<!DOCTYPE html>



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    Error Messages
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="_static/default.css" type="text/css" />
                <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
        <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="index.html" />
        <link rel="next" title="Changes and Migration" href="changelog/index.html" />
        <link rel="prev" title="Third Party Integration Issues" href="faq/thirdparty.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.31</span>


        | Release Date: June 18, 2024

    </div>

    <h1><a href="index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy 2.0 Documentation">SQLAlchemy 2.0 Documentation</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="intro.html">Overview</a></span></li>
<li><span class="link-container"><a class="reference external" href="tutorial/index.html">SQLAlchemy Unified Tutorial</a></span></li>
<li><span class="link-container"><a class="reference external" href="orm/index.html">SQLAlchemy ORM</a></span></li>
<li><span class="link-container"><a class="reference external" href="core/index.html">SQLAlchemy Core</a></span></li>
<li><span class="link-container"><a class="reference external" href="dialects/index.html">Dialects</a></span></li>
<li><span class="link-container"><a class="reference external" href="faq/index.html">Frequently Asked Questions</a></span></li>
<li class="selected"><span class="link-container"><strong>Error Messages</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#connections-and-transactions">Connections and Transactions</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#queuepool-limit-of-size-x-overflow-y-reached-connection-timed-out-timeout-z">QueuePool limit of size &lt;x&gt; overflow &lt;y&gt; reached, connection timed out, timeout &lt;z&gt;</a></span></li>
<li><span class="link-container"><a class="reference external" href="#pool-class-cannot-be-used-with-asyncio-engine-or-vice-versa">Pool class cannot be used with asyncio engine (or vice versa)</a></span></li>
<li><span class="link-container"><a class="reference external" href="#can-t-reconnect-until-invalid-transaction-is-rolled-back-please-rollback-fully-before-proceeding">Can’t reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dbapi-errors">DBAPI Errors</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#interfaceerror">InterfaceError</a></span></li>
<li><span class="link-container"><a class="reference external" href="#databaseerror">DatabaseError</a></span></li>
<li><span class="link-container"><a class="reference external" href="#dataerror">DataError</a></span></li>
<li><span class="link-container"><a class="reference external" href="#operationalerror">OperationalError</a></span></li>
<li><span class="link-container"><a class="reference external" href="#integrityerror">IntegrityError</a></span></li>
<li><span class="link-container"><a class="reference external" href="#internalerror">InternalError</a></span></li>
<li><span class="link-container"><a class="reference external" href="#programmingerror">ProgrammingError</a></span></li>
<li><span class="link-container"><a class="reference external" href="#notsupportederror">NotSupportedError</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sql-expression-language">SQL Expression Language</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#object-will-not-produce-a-cache-key-performance-implications">Object will not produce a cache key, Performance Implications</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#caching-disables-itself-if-there-s-any-doubt">Caching disables itself if there’s any doubt</a></span></li>
<li><span class="link-container"><a class="reference external" href="#assertion-attributes-for-caching">Assertion attributes for caching</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#compiler-strsqlcompiler-can-t-render-element-of-type-element-type">Compiler StrSQLCompiler can’t render element of type &lt;element type&gt;</a></span></li>
<li><span class="link-container"><a class="reference external" href="#typeerror-operator-not-supported-between-instances-of-columnproperty-and-something">TypeError: &lt;operator&gt; not supported between instances of ‘ColumnProperty’ and &lt;something&gt;</a></span></li>
<li><span class="link-container"><a class="reference external" href="#a-value-is-required-for-bind-parameter-x-in-parameter-group-y">A value is required for bind parameter &lt;x&gt; (in parameter group &lt;y&gt;)</a></span></li>
<li><span class="link-container"><a class="reference external" href="#expected-from-clause-got-select-to-create-a-from-clause-use-the-subquery-method">Expected FROM clause, got Select.  To create a FROM clause, use the .subquery() method</a></span></li>
<li><span class="link-container"><a class="reference external" href="#an-alias-is-being-generated-automatically-for-raw-clauseelement">An alias is being generated automatically for raw clauseelement</a></span></li>
<li><span class="link-container"><a class="reference external" href="#an-alias-is-being-generated-automatically-due-to-overlapping-tables">An alias is being generated automatically due to overlapping tables</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#object-relational-mapping">Object Relational Mapping</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#illegalstatechangeerror-and-concurrency-exceptions">IllegalStateChangeError and concurrency exceptions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#parent-instance-x-is-not-bound-to-a-session-lazy-load-deferred-load-refresh-etc-operation-cannot-proceed">Parent instance &lt;x&gt; is not bound to a Session; (lazy load/deferred load/refresh/etc.) operation cannot proceed</a></span></li>
<li><span class="link-container"><a class="reference external" href="#this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush">This Session’s transaction has been rolled back due to a previous exception during flush</a></span></li>
<li><span class="link-container"><a class="reference external" href="#for-relationship-relationship-delete-orphan-cascade-is-normally-configured-only-on-the-one-side-of-a-one-to-many-relationship-and-not-on-the-many-side-of-a-many-to-one-or-many-to-many-relationship">For relationship &lt;relationship&gt;, delete-orphan cascade is normally configured only on the “one” side of a one-to-many relationship, and not on the “many” side of a many-to-one or many-to-many relationship.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#instance-instance-is-already-associated-with-an-instance-of-instance-via-its-attribute-attribute-and-is-only-allowed-a-single-parent">Instance &lt;instance&gt; is already associated with an instance of &lt;instance&gt; via its &lt;attribute&gt; attribute, and is only allowed a single parent.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#relationship-x-will-copy-column-q-to-column-p-which-conflicts-with-relationship-s-y">relationship X will copy column Q to column P, which conflicts with relationship(s): ‘Y’</a></span></li>
<li><span class="link-container"><a class="reference external" href="#object-cannot-be-converted-to-persistent-state-as-this-identity-map-is-no-longer-valid">Object cannot be converted to ‘persistent’ state, as this identity map is no longer valid.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#type-annotation-can-t-be-interpreted-for-annotated-declarative-table-form">Type annotation can’t be interpreted for Annotated Declarative Table form</a></span></li>
<li><span class="link-container"><a class="reference external" href="#when-transforming-cls-to-a-dataclass-attribute-s-originate-from-superclass-cls-which-is-not-a-dataclass">When transforming &lt;cls&gt; to a dataclass, attribute(s) originate from superclass &lt;cls&gt; which is not a dataclass.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#python-dataclasses-error-encountered-when-creating-dataclass-for-classname">Python dataclasses error encountered when creating dataclass for &lt;classname&gt;</a></span></li>
<li><span class="link-container"><a class="reference external" href="#per-row-orm-bulk-update-by-primary-key-requires-that-records-contain-primary-key-values">per-row ORM Bulk Update by Primary Key requires that records contain primary key values</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#asyncio-exceptions">AsyncIO Exceptions</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#awaitrequired">AwaitRequired</a></span></li>
<li><span class="link-container"><a class="reference external" href="#missinggreenlet">MissingGreenlet</a></span></li>
<li><span class="link-container"><a class="reference external" href="#no-inspection-available">No Inspection Available</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#core-exception-classes">Core Exception Classes</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-exception-classes">ORM Exception Classes</a></span></li>
<li><span class="link-container"><a class="reference external" href="#legacy-exceptions">Legacy Exceptions</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#the-some-function-in-sqlalchemy-2-0-will-no-longer-something">The &lt;some function&gt; in SQLAlchemy 2.0 will no longer &lt;something&gt;</a></span></li>
<li><span class="link-container"><a class="reference external" href="#object-is-being-merged-into-a-session-along-the-backref-cascade">Object is being merged into a Session along the backref cascade</a></span></li>
<li><span class="link-container"><a class="reference external" href="#select-construct-created-in-legacy-mode-keyword-arguments-etc">select() construct created in “legacy” mode; keyword arguments, etc.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#a-bind-was-located-via-legacy-bound-metadata-but-since-future-true-is-set-on-this-session-this-bind-is-ignored">A bind was located via legacy bound metadata, but since future=True is set on this Session, this bind is ignored.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#this-compiled-object-is-not-bound-to-any-engine-or-connection">This Compiled object is not bound to any Engine or Connection</a></span></li>
<li><span class="link-container"><a class="reference external" href="#this-connection-is-on-an-inactive-transaction-please-rollback-fully-before-proceeding">This connection is on an inactive transaction.  Please rollback() fully before proceeding</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="changelog/index.html">Changes and Migration</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="faq/thirdparty.html" title="previous chapter">Third Party Integration Issues</a></li>
                <li><b>Next:</b>
                <a href="changelog/index.html" title="next chapter">Changes and Migration</a></li>

            <li><b>Up:</b> <a href="index.html">Home</a></li>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#error-messages">Error Messages</a><ul>
<li><a class="reference internal" href="#connections-and-transactions">Connections and Transactions</a><ul>
<li><a class="reference internal" href="#queuepool-limit-of-size-x-overflow-y-reached-connection-timed-out-timeout-z">QueuePool limit of size &lt;x&gt; overflow &lt;y&gt; reached, connection timed out, timeout &lt;z&gt;</a></li>
<li><a class="reference internal" href="#pool-class-cannot-be-used-with-asyncio-engine-or-vice-versa">Pool class cannot be used with asyncio engine (or vice versa)</a></li>
<li><a class="reference internal" href="#can-t-reconnect-until-invalid-transaction-is-rolled-back-please-rollback-fully-before-proceeding">Can’t reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dbapi-errors">DBAPI Errors</a><ul>
<li><a class="reference internal" href="#interfaceerror">InterfaceError</a></li>
<li><a class="reference internal" href="#databaseerror">DatabaseError</a></li>
<li><a class="reference internal" href="#dataerror">DataError</a></li>
<li><a class="reference internal" href="#operationalerror">OperationalError</a></li>
<li><a class="reference internal" href="#integrityerror">IntegrityError</a></li>
<li><a class="reference internal" href="#internalerror">InternalError</a></li>
<li><a class="reference internal" href="#programmingerror">ProgrammingError</a></li>
<li><a class="reference internal" href="#notsupportederror">NotSupportedError</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql-expression-language">SQL Expression Language</a><ul>
<li><a class="reference internal" href="#object-will-not-produce-a-cache-key-performance-implications">Object will not produce a cache key, Performance Implications</a><ul>
<li><a class="reference internal" href="#caching-disables-itself-if-there-s-any-doubt">Caching disables itself if there’s any doubt</a></li>
<li><a class="reference internal" href="#assertion-attributes-for-caching">Assertion attributes for caching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#compiler-strsqlcompiler-can-t-render-element-of-type-element-type">Compiler StrSQLCompiler can’t render element of type &lt;element type&gt;</a></li>
<li><a class="reference internal" href="#typeerror-operator-not-supported-between-instances-of-columnproperty-and-something">TypeError: &lt;operator&gt; not supported between instances of ‘ColumnProperty’ and &lt;something&gt;</a></li>
<li><a class="reference internal" href="#a-value-is-required-for-bind-parameter-x-in-parameter-group-y">A value is required for bind parameter &lt;x&gt; (in parameter group &lt;y&gt;)</a></li>
<li><a class="reference internal" href="#expected-from-clause-got-select-to-create-a-from-clause-use-the-subquery-method">Expected FROM clause, got Select.  To create a FROM clause, use the .subquery() method</a></li>
<li><a class="reference internal" href="#an-alias-is-being-generated-automatically-for-raw-clauseelement">An alias is being generated automatically for raw clauseelement</a></li>
<li><a class="reference internal" href="#an-alias-is-being-generated-automatically-due-to-overlapping-tables">An alias is being generated automatically due to overlapping tables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#object-relational-mapping">Object Relational Mapping</a><ul>
<li><a class="reference internal" href="#illegalstatechangeerror-and-concurrency-exceptions">IllegalStateChangeError and concurrency exceptions</a></li>
<li><a class="reference internal" href="#parent-instance-x-is-not-bound-to-a-session-lazy-load-deferred-load-refresh-etc-operation-cannot-proceed">Parent instance &lt;x&gt; is not bound to a Session; (lazy load/deferred load/refresh/etc.) operation cannot proceed</a></li>
<li><a class="reference internal" href="#this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush">This Session’s transaction has been rolled back due to a previous exception during flush</a></li>
<li><a class="reference internal" href="#for-relationship-relationship-delete-orphan-cascade-is-normally-configured-only-on-the-one-side-of-a-one-to-many-relationship-and-not-on-the-many-side-of-a-many-to-one-or-many-to-many-relationship">For relationship &lt;relationship&gt;, delete-orphan cascade is normally configured only on the “one” side of a one-to-many relationship, and not on the “many” side of a many-to-one or many-to-many relationship.</a></li>
<li><a class="reference internal" href="#instance-instance-is-already-associated-with-an-instance-of-instance-via-its-attribute-attribute-and-is-only-allowed-a-single-parent">Instance &lt;instance&gt; is already associated with an instance of &lt;instance&gt; via its &lt;attribute&gt; attribute, and is only allowed a single parent.</a></li>
<li><a class="reference internal" href="#relationship-x-will-copy-column-q-to-column-p-which-conflicts-with-relationship-s-y">relationship X will copy column Q to column P, which conflicts with relationship(s): ‘Y’</a></li>
<li><a class="reference internal" href="#object-cannot-be-converted-to-persistent-state-as-this-identity-map-is-no-longer-valid">Object cannot be converted to ‘persistent’ state, as this identity map is no longer valid.</a></li>
<li><a class="reference internal" href="#type-annotation-can-t-be-interpreted-for-annotated-declarative-table-form">Type annotation can’t be interpreted for Annotated Declarative Table form</a></li>
<li><a class="reference internal" href="#when-transforming-cls-to-a-dataclass-attribute-s-originate-from-superclass-cls-which-is-not-a-dataclass">When transforming &lt;cls&gt; to a dataclass, attribute(s) originate from superclass &lt;cls&gt; which is not a dataclass.</a></li>
<li><a class="reference internal" href="#python-dataclasses-error-encountered-when-creating-dataclass-for-classname">Python dataclasses error encountered when creating dataclass for &lt;classname&gt;</a></li>
<li><a class="reference internal" href="#per-row-orm-bulk-update-by-primary-key-requires-that-records-contain-primary-key-values">per-row ORM Bulk Update by Primary Key requires that records contain primary key values</a></li>
</ul>
</li>
<li><a class="reference internal" href="#asyncio-exceptions">AsyncIO Exceptions</a><ul>
<li><a class="reference internal" href="#awaitrequired">AwaitRequired</a></li>
<li><a class="reference internal" href="#missinggreenlet">MissingGreenlet</a></li>
<li><a class="reference internal" href="#no-inspection-available">No Inspection Available</a></li>
</ul>
</li>
<li><a class="reference internal" href="#core-exception-classes">Core Exception Classes</a></li>
<li><a class="reference internal" href="#orm-exception-classes">ORM Exception Classes</a></li>
<li><a class="reference internal" href="#legacy-exceptions">Legacy Exceptions</a><ul>
<li><a class="reference internal" href="#the-some-function-in-sqlalchemy-2-0-will-no-longer-something">The &lt;some function&gt; in SQLAlchemy 2.0 will no longer &lt;something&gt;</a></li>
<li><a class="reference internal" href="#object-is-being-merged-into-a-session-along-the-backref-cascade">Object is being merged into a Session along the backref cascade</a></li>
<li><a class="reference internal" href="#select-construct-created-in-legacy-mode-keyword-arguments-etc">select() construct created in “legacy” mode; keyword arguments, etc.</a></li>
<li><a class="reference internal" href="#a-bind-was-located-via-legacy-bound-metadata-but-since-future-true-is-set-on-this-session-this-bind-is-ignored">A bind was located via legacy bound metadata, but since future=True is set on this Session, this bind is ignored.</a></li>
<li><a class="reference internal" href="#this-compiled-object-is-not-bound-to-any-engine-or-connection">This Compiled object is not bound to any Engine or Connection</a></li>
<li><a class="reference internal" href="#this-connection-is-on-an-inactive-transaction-please-rollback-fully-before-proceeding">This connection is on an inactive transaction.  Please rollback() fully before proceeding</a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar errors" >
        
<section id="error-messages">
<span id="errors"></span><h1>Error Messages<a class="headerlink" href="#error-messages" title="Link to this heading">¶</a></h1>
<p>この項では、SQLAlchemyによって生成または出力される一般的なエラーメッセージと警告の説明とバックグラウンドを示します。</p>
<p>SQLAlchemyは通常、SQLAlchemy固有の例外クラスのコンテキスト内でエラーを発生させます。これらのクラスの詳細については、 <a class="reference internal" href="core/exceptions.html"><span class="std std-ref">Core Exceptions</span></a> および <a class="reference internal" href="orm/exceptions.html"><span class="std std-ref">ORM Exceptions</span></a> を参照してください。</p>
<p>SQLAlchemyエラーは、 <strong>プログラミング時エラー</strong> と <strong>実行時エラー</strong> の2つのカテゴリに大別できます。プログラミング時エラーは、関数またはメソッドが不正な引数で呼び出された結果、または解決できないマッパー構成などの他の構成指向のメソッドから呼び出された結果として発生します。プログラミング時エラーは、通常、即時かつ決定的なものです。一方、実行時エラーは、データベース接続の枯渇やデータ関連の問題の発生など、任意に発生する何らかの条件に応答してプログラムが実行されるときに発生する障害を表します。実行時エラーは、プログラムがロードやデータの発生に応答してこれらの状態に遭遇するため、実行中のアプリケーションのログに表示される可能性が高くなります。</p>
<p>実行時エラーは再現が容易ではなく、プログラムの実行中に何らかの任意の条件に応じて発生することが多いため、デバッグがより困難になり、また、すでにプロダクション環境に置かれているプログラムにも影響を与えます。このセクションでは、最も一般的な実行時エラーとプログラミング時エラーのバックグラウンドを説明します。</p>
<section id="connections-and-transactions">
<h2>Connections and Transactions<a class="headerlink" href="#connections-and-transactions" title="Link to this heading">¶</a></h2>
<section id="queuepool-limit-of-size-x-overflow-y-reached-connection-timed-out-timeout-z">
<span id="error-3o7r"></span><h3>QueuePool limit of size &lt;x&gt; overflow &lt;y&gt; reached, connection timed out, timeout &lt;z&gt;<a class="headerlink" href="#queuepool-limit-of-size-x-overflow-y-reached-connection-timed-out-timeout-z" title="Link to this heading">¶</a></h3>
<p>これは、アプリケーションの作業負荷が設定された制限を超えることに直接関係するため、おそらく最も一般的なランタイムエラーであり、通常、ほとんどすべてのSQLAlchemyアプリケーションに適用されます。</p>
<p>以下に、このエラーが何を意味するかをまとめます。まず、ほとんどのSQLAlchemyユーザが既に知っているはずの最も基本的な点から説明します。</p>
<ul class="simple">
<li><p><strong>SQLAlchemy Engineオブジェクトはデフォルトで接続プールを使用します</strong> - これが意味するのは、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> オブジェクトのSQLデータベース接続リソースを使用し、そのリソースを <a class="reference internal" href="glossary.html#term-releases"><span class="xref std std-term">releases</span></a> した場合、データベース接続自体はデータベースに接続されたまま内部キューに戻され、そこで再び使用できるということです。コードがデータベースとの対話を終了しているように見えても、多くの場合、アプリケーションはアプリケーションが終了するか、プールが明示的に破棄されるまで、固定された数のデータベース接続を維持します。</p></li>
</ul>
<ul class="simple">
<li><p>プールのため、アプリケーションがSQLデータベース接続を使用する場合、最も一般的には <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine.connect" title="sqlalchemy.engine.Engine.connect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Engine.connect()</span></code></a> を使用する場合、またはORM <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> を使用してクエリを行う場合、このアクティビティは、接続オブジェクトが取得された時点でデータベースへの新しい接続を確立するとは限りません。代わりに、接続プールに接続を問い合わせ、多くの場合、既存の接続をプールから取得して再利用します。使用可能な接続がない場合、プールは新しいデータベース接続を作成しますが、プールが設定された容量を超えていない場合に限られます。</p></li>
</ul>
<ul>
<li><p>ほとんどの場合、デフォルトのプールは <a class="reference internal" href="core/pooling.html#sqlalchemy.pool.QueuePool" title="sqlalchemy.pool.QueuePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">QueuePool</span></code></a> と呼ばれます。このプールに接続を要求しても使用可能な接続がない場合、新しい接続が作成されます。 <strong>実行中の接続の合計数が設定された値よりも少ない場合</strong> 新しい接続が作成されます。この値は、 <strong>プールサイズに最大オーバーフローを加えた値</strong> に等しくなります。つまり、エンジンを次のように設定した場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql+mysqldb://u:p@host/db&quot;</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_overflow</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span></pre></div>
</div>
</li>
</ul>
<p>より多くの接続を一度に使用できるようにするために、 <a class="reference internal" href="core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> 関数に渡される <a class="reference internal" href="core/engines.html#sqlalchemy.create_engine.params.pool_size" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.pool_size</span></code></a> および: paramref:<cite>_sa.create_engine.max_overflow</cite> パラメータを使用してプールを調整できます。接続が使用可能になるのを待つタイムアウトは、 <a class="reference internal" href="core/engines.html#sqlalchemy.create_engine.params.pool_timeout" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.pool_timeout</span></code></a> パラメータを使用して設定されます。</p>
<ul class="simple">
<li><p><a class="reference internal" href="core/engines.html#sqlalchemy.create_engine.params.max_overflow" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.max_overflow</span></code></a> を値”-1”に設定することで、無制限のオーバーフローを持つようにプールを設定できます。この設定では、プールは接続の固定プールを維持しますが、新しい接続が要求されたときにブロックされることはありません。代わりに、使用可能な接続がない場合は無条件に新しい接続を作成します。</p></li>
</ul>
<p>アプリケーションが利用可能なすべての接続を使い切る原因は何ですか?</p>
<ul class="simple">
<li><p><strong>プールに構成された値に基づいて作業するには、アプリケーションが処理している同時リクエストが多すぎます</strong> - これが最も直接的な原因です。30の同時スレッドを許可するスレッドプールで実行されるアプリケーションがあり、スレッドごとに1つの接続が使用されている場合、プールが一度に少なくとも30の接続をチェックアウトできるように構成されていないと、アプリケーションが十分な同時リクエストを受け取ると、このエラーが発生します。解決策は、プールの制限を上げるか、同時スレッドの数を減らすことです。</p></li>
</ul>
<ul class="simple">
<li><p><strong>アプリケーションがプールへの接続を返していないません</strong> - これは次に多い理由で、アプリケーションは接続プールを利用していますが、プログラムがこれらの接続を <a class="reference internal" href="glossary.html#term-release"><span class="xref std std-term">release</span></a> できず、代わりに開いたままにしています。接続プールとORM <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> には、セッションや接続オブジェクトがガベージコレクションされると、基礎となる接続リソースが解放されるようなロジックがありますが、この動作を信頼してリソースをタイムリーに解放することはできません。</p></li>
</ul>
<ul class="simple">
<li><p><strong>アプリケーションは長時間実行トランザクションを実行しようとしています</strong> - データベーストランザクションは非常に高価なリソースであり、 <strong>何らかのイベントが発生するのを待ってアイドル状態にしておくべきではありません</strong> 。アプリケーションが、ユーザーがボタンを押すのを待っている場合、長時間実行ジョブキューから結果が返されるのを待っている場合、またはブラウザへの永続的な接続を開いたままにしている場合は、<strong>データベーストランザクションを開いたままにしておく必要はありません</strong>。アプリケーションはデータベースを操作し、イベントと対話する必要があるため、その時点で短時間実行トランザクションを開いてから閉じます。</p></li>
</ul>
<ul class="simple">
<li><p><strong>アプリケーションがデッドロックしています</strong>-これもこのエラーの一般的な原因ですが、アプリケーション側またはデータベース側のデッドロックのためにアプリケーションが接続の使用を完了できない場合、アプリケーションは使用可能なすべての接続を使い果たし、追加の要求がこのエラーを受け取ることになります。デッドロックの理由は次のとおりです。</p></li>
</ul>
<p>プーリングを使用する代わりに、プーリングを完全にオフにする方法もあることに注意してください。このバックグラウンドについては <a class="reference internal" href="core/pooling.html#pool-switching"><span class="std std-ref">Switching Pool Implementations</span></a> の節を参照してください。ただし、このエラーメッセージが発生している場合は、 <strong>常に</strong> アプリケーション自体のより大きな問題が原因であることに注意してください。プールは問題をより早く明らかにするのに役立ちます。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="core/pooling.html"><span class="std std-ref">Connection Pooling</span></a></p>
<p><a class="reference internal" href="core/connections.html"><span class="std std-ref">Working with Engines and Connections</span></a></p>
</div>
</section>
<section id="pool-class-cannot-be-used-with-asyncio-engine-or-vice-versa">
<span id="error-pcls"></span><h3>Pool class cannot be used with asyncio engine (or vice versa)<a class="headerlink" href="#pool-class-cannot-be-used-with-asyncio-engine-or-vice-versa" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="core/pooling.html#sqlalchemy.pool.QueuePool" title="sqlalchemy.pool.QueuePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">QueuePool</span></code></a> プールクラスは内部的には <code class="docutils literal notranslate"><span class="pre">thread.Lock</span></code> オブジェクトを使用しており、asyncioとは互換性がありません。 <code class="xref py py-func docutils literal notranslate"> <span class="pre">create_async_engine()</span></code> 関数を使用して <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncEngine" title="sqlalchemy.ext.asyncio.AsyncEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncEngine</span></code></a> を作成する場合、適切なキュープールクラスは <a class="reference internal" href="core/pooling.html#sqlalchemy.pool.AsyncAdaptedQueuePool" title="sqlalchemy.pool.AsyncAdaptedQueuePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncAdaptedQueuePool</span></code></a> です。これは自動的に使用され、指定する必要はありません。</p>
<p><a class="reference internal" href="core/pooling.html#sqlalchemy.pool.AsyncAdaptedQueuePool" title="sqlalchemy.pool.AsyncAdaptedQueuePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncAdaptedQueuePool</span></code></a> に加えて、 <a class="reference internal" href="core/pooling.html#sqlalchemy.pool.NullPool" title="sqlalchemy.pool.NullPool"><code class="xref py py-class docutils literal notranslate"><span class="pre">NullPool</span></code></a> と <a class="reference internal" href="core/pooling.html#sqlalchemy.pool.StaticPool" title="sqlalchemy.pool.StaticPool"><code class="xref py py-class docutils literal notranslate"><span class="pre">StaticPool</span></code></a> プールクラスはロックを使用せず、非同期エンジンでの使用にも適しています。</p>
<p><a class="reference internal" href="core/pooling.html#sqlalchemy.pool.AsyncAdaptedQueuePool" title="sqlalchemy.pool.AsyncAdaptedQueuePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncAdaptedQueuePool</span></code></a> プールクラスが <a class="reference internal" href="core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> 関数で明示的に指定されている場合にも、このエラーは逆に発生します。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="core/pooling.html"><span class="std std-ref">Connection Pooling</span></a></p>
</div>
</section>
<section id="can-t-reconnect-until-invalid-transaction-is-rolled-back-please-rollback-fully-before-proceeding">
<span id="error-8s2b"></span><h3>Can’t reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding<a class="headerlink" href="#can-t-reconnect-until-invalid-transaction-is-rolled-back-please-rollback-fully-before-proceeding" title="Link to this heading">¶</a></h3>
<p>このエラー条件は、データベースの切断が検出されたか、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection.invalidate" title="sqlalchemy.engine.Connection.invalidate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.invalidate()</span></code></a> が明示的に呼び出されたために <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> が無効になったが、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection.begin" title="sqlalchemy.engine.Connection.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin()</span></code></a> メソッドによって明示的に開始されたトランザクションがまだ存在する場合、またはSQL文が発行されたときにSQLAlchemyの2.xシリーズで発生するように接続が自動的にトランザクションを開始した場合に発生します。接続が無効になると、進行中だった <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Transaction" title="sqlalchemy.engine.Transaction"><code class="xref py py-class docutils literal notranslate"><span class="pre">Transaction</span></code></a> は無効な状態になり、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> から削除するために明示的にロールバックする必要があります。</p>
</section>
</section>
<section id="dbapi-errors">
<span id="error-dbapi"></span><h2>DBAPI Errors<a class="headerlink" href="#dbapi-errors" title="Link to this heading">¶</a></h2>
<p>PythonデータベースAPI(DBAPI)は、 <a class="reference external" href="https://www.python.org/dev/peps/pep-0249/">Pep-249</a> にあるデータベースドライバの仕様です。このAPIは、データベースのあらゆる障害モードに対応する一連の例外クラスを指定します。</p>
<p>SQLAlchemyはこれらの例外を直接生成しません。代わりに、それらはデータベースドライバからインターセプトされ、SQLAlchemyが提供する例外 <a class="reference internal" href="core/exceptions.html#sqlalchemy.exc.DBAPIError" title="sqlalchemy.exc.DBAPIError"><code class="xref py py-class docutils literal notranslate"><span class="pre">DBAPIError</span></code></a> によってラップされますが、例外内のメッセージは <strong>SQLAlchemyではなく、ドライバによって生成されます</strong> 。</p>
<section id="interfaceerror">
<span id="error-rvf5"></span><h3>InterfaceError<a class="headerlink" href="#interfaceerror" title="Link to this heading">¶</a></h3>
<p>データベース自体ではなく、データベースインターフェースに関連するエラーに対して発生する例外です。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
<p><code class="docutils literal notranslate"><span class="pre">InterfaceError</span></code> は、データベース接続が切断されたり、データベースに接続できない状況で、ドライバによって発生することがあります。この問題に対処するためのヒントについては、 <a class="reference internal" href="core/pooling.html#pool-disconnects"><span class="std std-ref">Dealing with Disconnects</span></a> を参照してください。</p>
</section>
<section id="databaseerror">
<span id="error-4xp6"></span><h3>DatabaseError<a class="headerlink" href="#databaseerror" title="Link to this heading">¶</a></h3>
<p>渡されるインタフェースまたはデータではなく、データベース自体に関連するエラーに対して発生する例外です。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
</section>
<section id="dataerror">
<span id="error-9h9h"></span><h3>DataError<a class="headerlink" href="#dataerror" title="Link to this heading">¶</a></h3>
<p>ゼロによる除算、範囲外の数値など、処理されたデータの問題に起因するエラーに対して発生する例外です。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
</section>
<section id="operationalerror">
<span id="error-e3q8"></span><h3>OperationalError<a class="headerlink" href="#operationalerror" title="Link to this heading">¶</a></h3>
<p>データベースの操作に関連し、必ずしもプログラマの制御下にないエラーに対して発生する例外です。たとえば、予期しない切断が発生した、データソース名が見つからなかった、トランザクションを処理できなかった、処理中にメモリ割り当てエラーが発生したなど。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
<p><code class="docutils literal notranslate"><span class="pre">OperationalError</span></code> は最も一般的な(しかし唯一ではない)エラークラスで、データベース接続が切断されたり、データベースに接続できなくなったりした場合にドライバが使用します。これに対処するためのヒントについては <a class="reference internal" href="core/pooling.html#pool-disconnects"><span class="std std-ref">Dealing with Disconnects</span></a> を参照してください。</p>
</section>
<section id="integrityerror">
<span id="error-gkpj"></span><h3>IntegrityError<a class="headerlink" href="#integrityerror" title="Link to this heading">¶</a></h3>
<p>外部キーチェックが失敗するなど、データベースのリレーショナル整合性が影響を受ける場合に発生する例外です。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
</section>
<section id="internalerror">
<span id="error-2j85"></span><h3>InternalError<a class="headerlink" href="#internalerror" title="Link to this heading">¶</a></h3>
<p>データベースで内部エラーが発生した場合に発生する例外です。たとえば、カーソルが無効になった、トランザクションが同期していないなどです。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
<p><code class="docutils literal notranslate"><span class="pre">InternalError</span></code> は、データベース接続が切断されたり、データベースに接続できなかったりする状況で、ドライバによって発生することがあります。この問題に対処するためのヒントについては、 <a class="reference internal" href="core/pooling.html#pool-disconnects"><span class="std std-ref">Dealing with Disconnects</span></a> を参照してください。</p>
</section>
<section id="programmingerror">
<span id="error-f405"></span><h3>ProgrammingError<a class="headerlink" href="#programmingerror" title="Link to this heading">¶</a></h3>
<p>プログラミングエラーの場合に発生する例外です。たとえば、テーブルが見つからない、またはすでに存在する、SQL文の構文エラー、指定されたパラメータの数が間違っているなど。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
<p>データベース接続が切断された場合や、データベースに接続できない場合に、ドライバによって <code class="docutils literal notranslate"><span class="pre">ProgrammingError</span></code> が発生することがあります。これに対処するためのヒントについては、 <a class="reference internal" href="core/pooling.html#pool-disconnects"><span class="std std-ref">Dealing with Disconnects</span></a> を参照してください。</p>
</section>
<section id="notsupportederror">
<span id="error-tw8g"></span><h3>NotSupportedError<a class="headerlink" href="#notsupportederror" title="Link to this heading">¶</a></h3>
<p>データベースでサポートされていないメソッドまたはデータベースAPIが使用された場合に発生する例外です。たとえば、トランザクションをサポートしていない接続またはトランザクションがオフになっている接続で .rollback()を要求した場合などです。</p>
<p>このエラーは <a class="reference internal" href="#error-dbapi"><span class="std std-ref">DBAPI Error</span></a> であり、SQLAlchemy自身ではなく、データベースドライバ(DBAPI)から発生します。</p>
</section>
</section>
<section id="sql-expression-language">
<h2>SQL Expression Language<a class="headerlink" href="#sql-expression-language" title="Link to this heading">¶</a></h2>
<section id="object-will-not-produce-a-cache-key-performance-implications">
<span id="caching-caveats"></span><span id="error-cprf"></span><h3>Object will not produce a cache key, Performance Implications<a class="headerlink" href="#object-will-not-produce-a-cache-key-performance-implications" title="Link to this heading">¶</a></h3>
<p>バージョン1.4のSQLAlchemyには <a class="reference internal" href="core/connections.html#sql-caching"><span class="std std-ref">SQL compilation caching facility</span></a> が含まれています。これにより、CoreとORM SQL構文が、結果を文から取得するために使用される他の構造情報と共に、文字列化された形式をキャッシュできるようになり、構造的に等価な別の構文が次に使用されるときに、比較的高価な文字列コンパイルプロセスをスキップできるようになります。このシステムは、 <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 、 <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> 、 <a class="reference internal" href="core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> オブジェクトなどのオブジェクトを含むすべてのSQL構文に実装されている機能に依存して、SQLコンパイルプロセスに影響を与える程度までそれらの状態を完全に表現する <strong>キャッシュキー</strong> を生成します。</p>
<p>問題の警告が <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> オブジェクトのような広く使用されているオブジェクトを参照していて、( <a class="reference internal" href="core/connections.html#sql-caching-logging"><span class="std std-ref">Estimating Cache Performance Using Logging</span></a> で説明されている推定テクニックを使って)発行されるSQL構文の大部分に影響を与えていることが示され、一般的にアプリケーションでキャッシングが有効になっていない場合、これはパフォーマンスに悪影響を与え、場合によっては以前のバージョンのSQLAlchemyと比較して <strong>パフォーマンスの低下</strong> を引き起こす可能性があります。 <a class="reference internal" href="faq/performance.html#faq-new-caching"><span class="std std-ref">Why is my application slow after upgrading to 1.4 and/or 2.x?</span></a> のFAQでは、これについてさらに詳しく説明しています。</p>
<section id="caching-disables-itself-if-there-s-any-doubt">
<h4>Caching disables itself if there’s any doubt<a class="headerlink" href="#caching-disables-itself-if-there-s-any-doubt" title="Link to this heading">¶</a></h4>
<p>キャッシュは、文の <strong>完全な構造</strong> を <strong>一貫性のある</strong> 方法で正確に表すキャッシュキーを生成できるかどうかに依存します。特定のSQL構文(または型)に、適切なキャッシュキーの生成を可能にする適切なディレクティブがない場合、キャッシュを安全に有効化できません。</p>
<ul class="simple">
<li><p>キャッシュキーは <strong>完全な構造</strong> を表している必要があります。その構文の2つの別々のインスタンスを使用すると異なるSQLがレンダリングされる可能性がある場合、最初の要素と2番目の要素の明確な違いを取得しないキャッシュキーを使用して、要素の最初のインスタンスに対してSQLをキャッシュすると、2番目のインスタンスに対して不正なSQLがキャッシュされてレンダリングされます。</p></li>
</ul>
<ul class="simple">
<li><p>キャッシュキーは <strong>一貫性がある</strong> 必要があります。構文が毎回変化する状態(リテラル値など)を表し、そのすべてのインスタンスに対して一意のSQLを生成する場合、この構文をキャッシュしても安全ではありません。これは、構文を繰り返し使用すると、文キャッシュが一意のSQL文字列ですぐにいっぱいになり、二度と使用されない可能性が高いため、キャッシュの目的が損なわれるためです。</p></li>
</ul>
<p>上記の2つの理由から、SQLAlchemyのキャッシュシステムは、オブジェクトに対応するSQLをキャッシュすることを決定することに関して <strong>非常に保守的</strong> です。</p>
</section>
<section id="assertion-attributes-for-caching">
<h4>Assertion attributes for caching<a class="headerlink" href="#assertion-attributes-for-caching" title="Link to this heading">¶</a></h4>
<p>この警告は以下の基準に基づいて発せられます。それぞれの詳細については <a class="reference internal" href="faq/performance.html#faq-new-caching"><span class="std std-ref">Why is my application slow after upgrading to 1.4 and/or 2.x?</span></a> を参照してください。</p>
<ul class="simple">
<li><p><a class="reference internal" href="core/internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a> 自体(つまり、 <a class="reference internal" href="core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> に渡すURLの最初の部分で指定されるモジュール。例えば、 <code class="docutils literal notranslate"><span class="pre">postgresql+psycopg2://</span></code> )は、キャッシュを正しくサポートするためにレビューされ、テストされたことを示す必要があります。これは、 <a class="reference internal" href="core/internals.html#sqlalchemy.engine.Dialect.supports_statement_cache" title="sqlalchemy.engine.Dialect.supports_statement_cache"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Dialect.supports_statement_cache</span></code></a> 属性が <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定されていることで示されます。サードパーティのダイアレクトを使用する場合は、ダイアレクトのメンテナに相談して、彼らのダイアレクトで <a class="reference internal" href="core/connections.html#engine-thirdparty-caching"><span class="std std-ref">steps to ensure caching may be enabled</span></a> に従って新しいリリースを公開してください。</p></li>
</ul>
<ul class="simple">
<li><p><a class="reference internal" href="core/custom_types.html#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> または <a class="reference internal" href="core/custom_types.html#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> のいずれかを継承するサードパーティまたはユーザ定義の型は、 <a class="reference internal" href="core/type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a> 属性をその定義に含める必要があります。これには 、<a class="reference internal" href="core/type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a> のdocstringで説明されているガイドラインに従って、すべての派生サブクラスも含まれます。以前と同様に、これらのデータ型がサードパーティのライブラリからインポートされている場合は、そのライブラリのメンテナと相談して、ライブラリに必要な変更を加え、新しいリリースを公開してください。</p></li>
</ul>
<ul class="simple">
<li><p><a class="reference internal" href="core/foundation.html#sqlalchemy.sql.expression.ClauseElement" title="sqlalchemy.sql.expression.ClauseElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClauseElement</span></code></a> 、 <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 、 <a class="reference internal" href="core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> などのクラスをサブクラスとするサードパーティまたはユーザ定義のSQL構文は、単純なサブクラスや <a class="reference internal" href="core/compiler.html"><span class="std std-ref">Custom SQL Constructs and Compilation Extension</span></a> で動作するように設計されたサブクラスも含めて、通常は <a class="reference internal" href="core/compiler.html#compilerext-caching"><span class="std std-ref">Enabling Caching Support for Custom Constructs</span></a> で説明されているガイドラインに従って、構文の設計に基づいて <a class="reference internal" href="core/foundation.html#sqlalchemy.sql.traversals.HasCacheKey.inherit_cache" title="sqlalchemy.sql.traversals.HasCacheKey.inherit_cache"><code class="xref py py-attr docutils literal notranslate"><span class="pre">HasCacheKey.inherit_cache</span></code></a> 属性を <code class="docutils literal notranslate"><span class="pre">True</span></code> または <code class="docutils literal notranslate"><span class="pre">False</span></code> に設定する必要があります。</p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="core/connections.html#sql-caching-logging"><span class="std std-ref">Estimating Cache Performance Using Logging</span></a> - キャッシュの動作と効率を観測したバックグラウンド</p>
<p><a class="reference internal" href="faq/performance.html#faq-new-caching"><span class="std std-ref">Why is my application slow after upgrading to 1.4 and/or 2.x?</span></a> - <a class="reference internal" href="faq/index.html"><span class="std std-ref">Frequently Asked Questions</span></a> セクション</p>
</div>
</section>
</section>
<section id="compiler-strsqlcompiler-can-t-render-element-of-type-element-type">
<span id="error-l7de"></span><h3>Compiler StrSQLCompiler can’t render element of type &lt;element type&gt;<a class="headerlink" href="#compiler-strsqlcompiler-can-t-render-element-of-type-element-type" title="Link to this heading">¶</a></h3>
<p>このエラーは通常、デフォルトのコンパイルの一部ではない要素を含むSQL式の構成体を文字列化しようとしたときに発生します。この場合、エラーは <a class="reference internal" href="core/internals.html#sqlalchemy.sql.compiler.StrSQLCompiler" title="sqlalchemy.sql.compiler.StrSQLCompiler"><code class="xref py py-class docutils literal notranslate"><span class="pre">StrSQLCompiler</span></code></a> クラスに対して発生します。あまり一般的ではありませんが、特定の種類のデータベースバックエンドで間違った種類のSQL式が使用された場合にも発生することがあります。そのような場合には、 <code class="docutils literal notranslate"><span class="pre">SQLCompiler</span></code> や <code class="docutils literal notranslate"><span class="pre">sqlalchemy.dialects.postgresql.PGCompiler</span></code> など、他の種類のSQLコンパイラクラスに名前が付けられます。以下のガイダンスは、”文字列化”のユースケースに特化していますが、一般的なバックグラウンドについても説明しています。</p>
<p>通常、コアSQL構文またはORM <a class="reference internal" href="orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> オブジェクトは、 <code class="docutils literal notranslate"><span class="pre">print()</span></code> のように直接文字列化することができます。</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
<div class='show_sql_print'><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">x_1</span>
</div></pre></div>
</div>
<p>上記のSQL式が文字列化されると、 <a class="reference internal" href="core/internals.html#sqlalchemy.sql.compiler.StrSQLCompiler" title="sqlalchemy.sql.compiler.StrSQLCompiler"><code class="xref py py-class docutils literal notranslate"><span class="pre">StrSQLCompiler</span></code></a> コンパイラクラスが使用されます。これは、構文が方言固有の情報なしに文字列化されたときに呼び出される特別なステートメントコンパイラです。</p>
<p>しかし、ある特定の種類のデータベース言語に固有の多くの構文があります。例えば、PostgreSQLの <a class="reference external" href="PostgreSQL_insert_on_conflict">“insert on conflict”</a> 構文のように、  <a class="reference internal" href="core/internals.html#sqlalchemy.sql.compiler.StrSQLCompiler" title="sqlalchemy.sql.compiler.StrSQLCompiler"><code class="xref py py-class docutils literal notranslate"><span class="pre">StrSQLCompiler</span></code></a> は文字列に変換する方法を知りません:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">insert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">table</span><span class="p">,</span> <span class="n">column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_table</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">my_table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">insert_stmt</span><span class="o">.</span><span class="n">on_conflict_do_nothing</span><span class="p">(</span><span class="n">index_elements</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">insert_stmt</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>

<span class="gr">...</span>

<span class="gr">sqlalchemy.exc.UnsupportedCompilationError</span>: <span class="n">Compiler &lt;sqlalchemy.sql.compiler.StrSQLCompiler object at 0x7f04fc17e320&gt; can&#39;t render element of type &lt;class &#39;sqlalchemy.dialects.postgresql.dml.OnConflictDoNothing&#39;&gt;</span></pre></div>
</div>
<p>特定のバックエンドに固有の構文を文字列化するには、 <a class="reference internal" href="core/foundation.html#sqlalchemy.sql.expression.ClauseElement.compile" title="sqlalchemy.sql.expression.ClauseElement.compile"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ClauseElement.compile()</span></code></a> メソッドを使用して、正しいコンパイラを呼び出す <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> または <a class="reference internal" href="core/internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a> オブジェクトを渡す必要があります。以下ではPostgreSQLのダイアレクトを使用します:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">postgresql</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">insert_stmt</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">my_table</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">DO</span><span class="w"> </span><span class="k">NOTHING</span>
</div></pre></div>
</div>
<p>ORM <a class="reference internal" href="orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> オブジェクトの場合、この文は <code class="xref py py-attr docutils literal notranslate"><span class="pre">Query.statement</span></code> アクセッサを使ってアクセスできます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">statement</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">statement</span>
<span class="n">print</span><span class="p">(</span><span class="n">statement</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span></pre></div>
</div>
<p>SQL要素の直接のストリング化/コンパイルの詳細については、以下のFAQリンクを参照してください。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="faq/sqlexpressions.html#faq-sql-expression-string"><span class="std std-ref">How do I render SQL expressions as strings, possibly with bound parameters inlined?</span></a></p>
</div>
</section>
<section id="typeerror-operator-not-supported-between-instances-of-columnproperty-and-something">
<h3>TypeError: &lt;operator&gt; not supported between instances of ‘ColumnProperty’ and &lt;something&gt;<a class="headerlink" href="#typeerror-operator-not-supported-between-instances-of-columnproperty-and-something" title="Link to this heading">¶</a></h3>
<p>これは、 <a class="reference internal" href="orm/mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> または <a class="reference internal" href="orm/queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> オブジェクトをSQL式のコンテキストで、通常は次のような宣言内で使用しようとしたときによく起こります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cprop</span> <span class="o">=</span> <span class="n">deferred</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">))</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">CheckConstraint</span><span class="p">(</span><span class="n">cprop</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">),)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上記では、 <code class="docutils literal notranslate"><span class="pre">cprop</span></code> 属性はマップされる前にインラインで使用されていますが、この <code class="docutils literal notranslate"><span class="pre">cprop</span></code> 属性は <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> ではなく、 <a class="reference internal" href="orm/internals.html#sqlalchemy.orm.ColumnProperty" title="sqlalchemy.orm.ColumnProperty"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnProperty</span></code></a> です。これは一時的なオブジェクトなので、宣言プロセスが完了すると <code class="docutils literal notranslate"><span class="pre">Bar</span></code> クラスにマップされる <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> オブジェクトや <a class="reference internal" href="orm/internals.html#sqlalchemy.orm.InstrumentedAttribute" title="sqlalchemy.orm.InstrumentedAttribute"><code class="xref py py-class docutils literal notranslate"><span class="pre">InstrumentedAttribute</span></code></a> オブジェクトの完全な機能を持ちません。</p>
<p><a class="reference internal" href="orm/internals.html#sqlalchemy.orm.ColumnProperty" title="sqlalchemy.orm.ColumnProperty"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnProperty</span></code></a> には、いくつかの列指向のコンテキストで動作することを可能にする <code class="docutils literal notranslate"><span class="pre">__clause_element__()</span></code> メソッドがありますが、上で説明したようなオープンエンドの比較コンテキストでは動作しません。なぜなら、数値”5”との比較を通常のPythonの比較ではなくSQL式として解釈できるPythonの <code class="docutils literal notranslate"><span class="pre">__eq__()</span></code> メソッドがないからです。</p>
<p>解決策は、 <a class="reference internal" href="orm/internals.html#sqlalchemy.orm.ColumnProperty.expression" title="sqlalchemy.orm.ColumnProperty.expression"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ColumnProperty.expression</span></code></a> 属性を使って直接 <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> にアクセスすることです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cprop</span> <span class="o">=</span> <span class="n">deferred</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">))</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">CheckConstraint</span><span class="p">(</span><span class="n">cprop</span><span class="o">.</span><span class="n">expression</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">),)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</section>
<section id="a-value-is-required-for-bind-parameter-x-in-parameter-group-y">
<span id="error-cd3x"></span><h3>A value is required for bind parameter &lt;x&gt; (in parameter group &lt;y&gt;)<a class="headerlink" href="#a-value-is-required-for-bind-parameter-x-in-parameter-group-y" title="Link to this heading">¶</a></h3>
<p>このエラーは、ステートメントが暗黙的または明示的に <a class="reference internal" href="core/sqlelement.html#sqlalchemy.sql.expression.bindparam" title="sqlalchemy.sql.expression.bindparam"><code class="xref py py-func docutils literal notranslate"><span class="pre">bindparam()</span></code></a> を使用し、ステートメントの実行時に値を提供しない場合に発生します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">column</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">bindparam</span><span class="p">(</span><span class="s2">&quot;my_param&quot;</span><span class="p">))</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p>上記では、パラメータ”my_param”に値が指定されていません。正しい方法は、値を指定することです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;my_param&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span></pre></div>
</div>
<p>メッセージが “a value is required for bind parameter &lt;x&gt; in parameter group &lt;y&gt;”の形式をとる場合、メッセージは”executemany”スタイルの実行を参照しています。この場合、ステートメントは通常INSERT、UPDATE、またはDELETEで、パラメータのリストが渡されます。この形式では、ステートメントは引数リストで指定されたすべてのパラメータのパラメータ位置を含むように動的に生成され、 <strong>最初のパラメータセット</strong> を使用して、これらが何であるべきかを決定します。</p>
<p>たとえば、次の文は、パラメータ”a”、”b”、および”c”を必要とする最初のパラメータセットに基づいて計算されます。これらの名前は、リスト内の各パラメータセットに使用される文の最終的な文字列形式を決定します。2番目のエントリに”b”が含まれていないため、このエラーが生成されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>

<span class="n">e</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">t</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
    <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="p">],</span>
<span class="p">)</span></pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">StatementError</span><span class="p">:</span> <span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">)</span> <span class="n">A</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">required</span> <span class="k">for</span> <span class="n">bind</span> <span class="n">parameter</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="ow">in</span> <span class="n">parameter</span> <span class="n">group</span> <span class="mi">1</span> <span class="p">[</span><span class="n">SQL</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;INSERT INTO t (a, b, c) VALUES (?, ?, ?)&#39;</span><span class="p">]</span> <span class="p">[</span><span class="n">parameters</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}]]</span></pre></div>
</div>
<p>“b”は必須なので、INSERTが実行されるように、”None”として渡します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">t</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
    <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="p">],</span>
<span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="tutorial/dbapi_transactions.html#tutorial-sending-parameters"><span class="std std-ref">Sending Parameters</span></a></p>
</div>
</section>
<section id="expected-from-clause-got-select-to-create-a-from-clause-use-the-subquery-method">
<span id="error-89ve"></span><h3>Expected FROM clause, got Select.  To create a FROM clause, use the .subquery() method<a class="headerlink" href="#expected-from-clause-got-select-to-create-a-from-clause-use-the-subquery-method" title="Link to this heading">¶</a></h3>
<p>これはSQLAlchemy 1.4で行われた変更で、 <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> のような関数によって生成され、共用体やテキストのSELECT式のようなものを含むSELECT文は、 <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> オブジェクトとは見なされなくなり、最初に <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> でラップされない限り、別のSELECT文のFROM句に直接配置することはできなくなりました。これはコアの主要な概念上の変更であり、完全な理論的根拠は <a class="reference internal" href="changelog/migration_14.html#change-4617"><span class="std std-ref">A SELECT statement is no longer implicitly considered to be a FROM clause</span></a> で議論されています。</p>
<p>Given an example as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></pre></div>
</div>
<p>上の例では、 <code class="docutils literal notranslate"><span class="pre">stmt</span></code> はSELECT文を表しています。このエラーは、別のSELECTのFROM句として <code class="docutils literal notranslate"><span class="pre">stmt</span></code> を直接使用したい場合に発生します。たとえば、そこから選択しようとした場合などです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_stmt_1</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p>または、JOINなどのFROM句で使用する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_stmt_2</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">some_table</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stmt</span><span class="p">))</span></pre></div>
</div>
<p>以前のバージョンのSQLAlchemyでは、別のSELECTの内部でSELECTを使用すると、括弧で括られた名前のない副問い合わせが生成されました。MySQLやPostgreSQLのようなデータベースでは、FROM句内の副問い合わせが名前付きのエイリアスを持つ必要があるため、ほとんどの場合、この形式のSQLはあまり有用ではありません。つまり、 <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.SelectBase.alias" title="sqlalchemy.sql.expression.SelectBase.alias"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SelectBase.alias()</span></code></a> メソッドを使用するか、1.4では <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.SelectBase.subquery" title="sqlalchemy.sql.expression.SelectBase.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SelectBase.subquery()</span></code></a> メソッドを使用してこれを生成します。他のデータベースでは、副問い合わせ内の列名への将来の参照に関するあいまいさを解決するために、副問い合わせが名前を持つ方がはるかに明確です。</p>
<p>上記の実際的な理由以外にも、変更が行われているSQLAlchemy指向の理由はたくさんあります。したがって、上記の2つのステートメントの正しい形式では、 <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.SelectBase.subquery" title="sqlalchemy.sql.expression.SelectBase.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SelectBase.subquery()</span></code></a> を使用する必要があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subq</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">new_stmt_1</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">subq</span><span class="p">)</span>

<span class="n">new_stmt_2</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">some_table</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subq</span><span class="p">))</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="changelog/migration_14.html#change-4617"><span class="std std-ref">A SELECT statement is no longer implicitly considered to be a FROM clause</span></a></p>
</div>
</section>
<section id="an-alias-is-being-generated-automatically-for-raw-clauseelement">
<span id="error-xaj1"></span><h3>An alias is being generated automatically for raw clauseelement<a class="headerlink" href="#an-alias-is-being-generated-automatically-for-raw-clauseelement" title="Link to this heading">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.26.</span></p>
</div>
<p>この非推奨警告は、レガシーの <a class="reference internal" href="orm/queryguide/query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a> メソッドと <a class="reference internal" href="glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a> <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> メソッドに適用される非常に古く、あまり知られていないパターンを参照しています。ここで、結合は <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> で記述できますが、ターゲットは、マップされたクラスや <a class="reference internal" href="orm/queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> 構成体のようなORMエンティティではなく、クラスがマップされる <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> やその他のCore選択可能なものです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="n">__table__</span>

<span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;ed@foo.com&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span></pre></div>
</div>
<p>上記のパターンでは、Core <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a> や <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> オブジェクトのような任意の選択が可能ですが、この要素は自動的には適用されないので、Core要素を直接参照する必要があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;ed@foo.com&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span></pre></div>
</div>
<p>結合対象を指定する正しい方法は、常にマップされたクラスそのものか <a class="reference internal" href="orm/queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-class docutils literal notranslate"><span class="pre">aliased</span></code></a> オブジェクトを使うことです。後者の場合は <a class="reference internal" href="orm/internals.html#sqlalchemy.orm.PropComparator.of_type" title="sqlalchemy.orm.PropComparator.of_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PropComparator.of_type()</span></code></a> 修飾子を使ってエイリアスを設定します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># normal join to relationship entity</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;ed@foo.com&quot;</span><span class="p">)</span>

<span class="c1"># name Address target explicitly, not necessary but legal</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;ed@foo.com&quot;</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>エイリアスへの結合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>

<span class="n">a1</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span>

<span class="c1"># of_type() form; recommended</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">a1</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;ed@foo.com&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># target, onclause form</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s2">&quot;ed@foo.com&quot;</span><span class="p">)</span></pre></div>
</div>
</section>
<section id="an-alias-is-being-generated-automatically-due-to-overlapping-tables">
<span id="error-xaj2"></span><h3>An alias is being generated automatically due to overlapping tables<a class="headerlink" href="#an-alias-is-being-generated-automatically-due-to-overlapping-tables" title="Link to this heading">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.26.</span></p>
</div>
<p>この警告は通常、 <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> メソッドまたは従来の <a class="reference internal" href="orm/queryguide/query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a> メソッドを使用して、結合テーブルの継承を含むマッピングでクエリを行うときに生成されます。問題は、共通のベーステーブルを共有する2つの結合された継承モデル間を結合する場合、2つのエンティティ間の適切なSQL JOINは、どちらかの側にエイリアスを適用しないと形成できないことです。SQLAlchemyは、結合の右側にエイリアスを適用します。たとえば、結合された継承マッピングが次のように与えられたとします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Employee</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;employee&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">manager_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;manager.id&quot;</span><span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="n">reports_to</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Manager&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">manager_id</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;polymorphic_identity&quot;</span><span class="p">:</span> <span class="s2">&quot;employee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;polymorphic_on&quot;</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">class</span> <span class="nc">Manager</span><span class="p">(</span><span class="n">Employee</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;manager&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;employee.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;polymorphic_identity&quot;</span><span class="p">:</span> <span class="s2">&quot;manager&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inherit_condition&quot;</span><span class="p">:</span> <span class="n">id</span> <span class="o">==</span> <span class="n">Employee</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上記のマッピングには、 <code class="docutils literal notranslate"><span class="pre">Employee</span></code> クラスと <code class="docutils literal notranslate"><span class="pre">Manager</span></code> クラスの間の関係が含まれています。どちらのクラスも <code class="docutils literal notranslate"><span class="pre">employee</span></code> データベーステーブルを使用しているので、SQLの観点から見ると、これは <a class="reference internal" href="orm/self_referential.html#self-referential"><span class="std std-ref">self_referential relationship</span></a> です。結合を使用して <code class="docutils literal notranslate"><span class="pre">Employee</span></code> モデルと <code class="docutils literal notranslate"><span class="pre">Manager</span></code> モデルの両方からクエリを実行したい場合、SQLレベルでは``employee`` テーブルをクエリに2回含める必要があります。つまり、エイリアスを作成する必要があります。SQLAlchemy ORMを使用してこのような結合を作成すると、次のようなSQLが得られます。</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Employee</span><span class="p">,</span> <span class="n">Manager</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">reports_to</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">manager_id</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="n">employee</span><span class="p">.</span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="n">manager_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id_1</span><span class="p">,</span><span class="w"> </span><span class="n">employee_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id_2</span><span class="p">,</span>
<span class="n">employee_1</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_id_1</span><span class="p">,</span><span class="w"> </span><span class="n">employee_1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">name_1</span><span class="p">,</span>
<span class="n">employee_1</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">type_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">JOIN</span>
<span class="p">(</span><span class="n">employee</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">manager_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employee_1</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="n">manager_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">manager_id</span>
</div></pre></div>
</div>
<p>上の例では、SQLはクエリ内の <code class="docutils literal notranslate"><span class="pre">Employee</span></code> エンティティを表す <code class="docutils literal notranslate"><span class="pre">employee</span></code> テーブルから選択します。次に、 <code class="docutils literal notranslate"><span class="pre">employee</span> <span class="pre">AS</span> <span class="pre">employee_1</span> <span class="pre">JOIN</span> <span class="pre">manager</span> <span class="pre">AS</span> <span class="pre">manager_1</span></code> の右入れ子結合に結合します。ここでは、匿名のエイリアス <code class="docutils literal notranslate"><span class="pre">employee_1</span></code> を除いて、 <code class="docutils literal notranslate"><span class="pre">employee</span></code> テーブルが再度記述されています。これは、警告メッセージが参照する”エイリアスの自動生成”です。</p>
<p>SQLAlchemyがそれぞれ <code class="docutils literal notranslate"><span class="pre">Employee</span></code> オブジェクトと <code class="docutils literal notranslate"><span class="pre">Manager</span></code> オブジェクトを含むORM行をロードする時、ORMは上にある <code class="docutils literal notranslate"><span class="pre">employee_1</span></code> と <code class="docutils literal notranslate"><span class="pre">manager_1</span></code> というテーブルエイリアスからの行を、エイリアスされていない <code class="docutils literal notranslate"><span class="pre">Manager</span></code> クラスの行に適合させなければなりません。このプロセスは内部的に複雑で、すべてのAPI機能に対応しているわけではありません。特に、 <a class="reference internal" href="orm/queryguide/relationships.html#sqlalchemy.orm.contains_eager" title="sqlalchemy.orm.contains_eager"><code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code></a> のようなEagerローディング機能を、ここに示すよりも深くネストされたクエリで使用しようとする場合にはそうです。このパターンは、より複雑なシナリオでは信頼できず、予測や追跡が困難な暗黙の意思決定を伴うため、警告が表示され、このパターンはレガシー機能と見なされる可能性があります。この問い合わせを書くためのより良い方法は、他の自己参照関係に適用されるものと同じパターンを使うことです。つまり、 <a class="reference internal" href="orm/queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> 構文を明示的に使うことです。結合継承やその他の結合指向のマッピングでは、通常、 <a class="reference internal" href="orm/queryguide/api.html#sqlalchemy.orm.aliased.params.flat" title="sqlalchemy.orm.aliased"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">aliased.flat</span></code></a> パラメータの使用を追加することが望まれます。これにより、結合を新しい副問い合わせに埋め込むのではなく、結合内の個々のテーブルにエイリアスを適用することで、2つ以上のテーブルのJOINにエイリアスを適用できます:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">manager_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Manager</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Employee</span><span class="p">,</span> <span class="n">manager_alias</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">reports_to</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">manager_alias</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">manager_id</span><span class="p">,</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="n">employee</span><span class="p">.</span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="n">manager_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id_1</span><span class="p">,</span><span class="w"> </span><span class="n">employee_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id_2</span><span class="p">,</span>
<span class="n">employee_1</span><span class="p">.</span><span class="n">manager_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_id_1</span><span class="p">,</span><span class="w"> </span><span class="n">employee_1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">name_1</span><span class="p">,</span>
<span class="n">employee_1</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">type_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">JOIN</span>
<span class="p">(</span><span class="n">employee</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">manager_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employee_1</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="n">manager_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">manager_id</span>
</div></pre></div>
</div>
<p><a class="reference internal" href="orm/queryguide/relationships.html#sqlalchemy.orm.contains_eager" title="sqlalchemy.orm.contains_eager"><code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code></a> を使って <code class="docutils literal notranslate"><span class="pre">reports_to</span></code> 属性を生成したい場合は、エイリアスを参照します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">Employee</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">reports_to</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">manager_alias</span><span class="p">))</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">contains_eager</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">reports_to</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">manager_alias</span><span class="p">)))</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<p>明示的な <a class="reference internal" href="orm/queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> オブジェクトを使用しないと、入れ子になったいくつかのケースでは、 <a class="reference internal" href="orm/queryguide/relationships.html#sqlalchemy.orm.contains_eager" title="sqlalchemy.orm.contains_eager"><code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code></a> オプションは、データをどこから取得するかを知るための十分なコンテキストを持っていません。これは、ORMが非常に入れ子になったコンテキストで”auto-aliasing”している場合です。したがって、この機能に頼らず、代わりにSQL構文をできるだけ明示的にしておくことが最善です。</p>
</section>
</section>
<section id="object-relational-mapping">
<h2>Object Relational Mapping<a class="headerlink" href="#object-relational-mapping" title="Link to this heading">¶</a></h2>
<section id="illegalstatechangeerror-and-concurrency-exceptions">
<span id="error-isce"></span><h3>IllegalStateChangeError and concurrency exceptions<a class="headerlink" href="#illegalstatechangeerror-and-concurrency-exceptions" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy 2.0は、 <a class="reference internal" href="changelog/whatsnew_20.html#change-7433"><span class="std std-ref">Session raises proactively when illegal concurrent or reentrant access is detected</span></a> で説明されている新しいシステムを導入しました。これは、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> オブジェクトの個々のインスタンス、さらには <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncSession" title="sqlalchemy.ext.asyncio.AsyncSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncSession</span></code></a> プロキシオブジェクトで呼び出されている並行メソッドを事前に検出します。これらの並行アクセス呼び出しは、排他的ではありませんが、通常、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> の単一インスタンスが、そのようなアクセスが同期されていない複数の並行スレッド間で共有されている場合、または同様に、 <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncSession" title="sqlalchemy.ext.asyncio.AsyncSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncSession</span></code></a> の単一インスタンスが複数の並行タスク間で共有されている場合(例えば、 <code class="docutils literal notranslate"><span class="pre">asyncio.gather()</span></code> のような関数を使用している場合)に発生します。これらの使用パターンは、これらのオブジェクトの適切な使用ではありません。事前警告システムがなければ、SQLAlchemy実装はオブジェクト内に無効な状態を生成し、データベース接続自体にドライバレベルのエラーを含むデバッグ困難なエラーを生成します。</p>
<p><a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> と <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncSession" title="sqlalchemy.ext.asyncio.AsyncSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncSession</span></code></a> のインスタンスは、メソッド呼び出しの同期 <strong>が組み込まれていない</strong> 可変のステートフルなオブジェクトであり、オブジェクトがバインドされている特定の <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> または <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncEngine" title="sqlalchemy.ext.asyncio.AsyncEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncEngine</span></code></a> に対する一度に1つのデータベース接続で、 <strong>単一の進行中のデータベーストランザクション</strong> を表します(これらのオブジェクトは両方とも同時に複数のエンジンにバインドすることをサポートしていますが、この場合、トランザクションのスコープ内で動作するエンジンごとに1つの接続しかありません)。単一のデータベーストランザクションは、並行SQLコマンドの適切なターゲットではありません。代わりに、並行データベース操作を実行するアプリケーションは並行トランザクションを使用する必要があります。これらのオブジェクトの場合、適切なパターンはスレッドごとの <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> か、タスクごとの <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncSession" title="sqlalchemy.ext.asyncio.AsyncSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncSession</span></code></a> になります。</p>
<p>並行性のバックグラウンドについては <a class="reference internal" href="orm/session_basics.html#session-faq-threadsafe"><span class="std std-ref">Is the Session thread-safe?  Is AsyncSession safe to share in concurrent tasks?</span></a> の節を参照してください。</p>
</section>
<section id="parent-instance-x-is-not-bound-to-a-session-lazy-load-deferred-load-refresh-etc-operation-cannot-proceed">
<span id="error-bhk3"></span><h3>Parent instance &lt;x&gt; is not bound to a Session; (lazy load/deferred load/refresh/etc.) operation cannot proceed<a class="headerlink" href="#parent-instance-x-is-not-bound-to-a-session-lazy-load-deferred-load-refresh-etc-operation-cannot-proceed" title="Link to this heading">¶</a></h3>
<p>これはORMを扱うときに最も一般的なエラーメッセージであり、ORMが広く使用している <a class="reference internal" href="glossary.html#term-lazy-loading"><span class="xref std std-term">lazy loading</span></a> として知られるテクニックの性質の結果として発生します。遅延読み込みは、ORMによって永続化されたオブジェクトがデータベース自体へのプロキシを維持する一般的なオブジェクトリレーショナルパターンであり、オブジェクト上のさまざまな属性がアクセスされると、それらの値がデータベースから <em>遅延</em> して取得されます。このアプローチの利点は、すべての属性または関連データを一度にロードすることなくオブジェクトをデータベースから取得でき、代わりに要求されたデータのみをその時点で配信できることです。主な欠点は、基本的に利点の反対であり、すべての場合に特定のデータセットを必要とすることが知られている多くのオブジェクトがロードされている場合、その追加データを断片的にロードするのは無駄であるということです。</p>
<p>通常の効率性の問題を超えた遅延読み込みのもう1つの注意事項は、遅延読み込みが進行するためには、オブジェクトがその状態を取得できるように、 <strong>セッションに関連付けられたまま</strong> でなければならないことです。このエラーメッセージは、オブジェクトがその <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> との関連付けが解除され、データベースからデータを遅延読み込みするように要求されていることを示します。</p>
<p>オブジェクトが <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> から切り離される最も一般的な理由は、セッション自体が、通常は <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session.close" title="sqlalchemy.orm.Session.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.close()</span></code></a> メソッドによって閉じられたことです。その後、オブジェクトはさらにアクセスされるために存続します。多くの場合、オブジェクトはWebアプリケーション内でサーバ側のテンプレートエンジンに配信され、ロードできない追加の属性が要求されます。</p>
<p>このエラーを軽減するには、次のテクニックを使用します。</p>
<ul class="simple">
<li><p><strong>デタッチされたオブジェクトを持たないようにしてください。セッションを早めに閉じないでください</strong> - 多くの場合、アプリケーションは、このエラーのために失敗する他のシステムに関連するオブジェクトを渡す前に、トランザクションを閉じます。トランザクションをすぐに閉じる必要がない場合もあります。たとえば、Webアプリケーションは、ビューがレンダリングされる前にトランザクションを閉じます。これはしばしば「正当性」という名前で行われますが、この用語は実際のアクションではなくコード編成を指すため、「カプセル化」の誤った適用と見なされることがあります。ORMオブジェクトを使用するテンプレートは、呼び出し元からデータベースロジックをカプセル化したままにする <a class="reference external" href="https://en.wikipedia.org/wiki/Proxy_pattern">proxy pattern</a> を使用しています。オブジェクトのライフスパンが完了するまで <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> を開いたままにできる場合、これが最善のアプローチです。</p></li>
</ul>
<ul class="simple">
<li><p><strong>そうでない場合は、必要なものをすべて事前にロードしてください</strong> - トランザクションを開いたままにしておくことは、特に、同じプロセス内にあっても同じコンテキストで実行できない他のシステムにオブジェクトを渡す必要がある、より複雑なアプリケーションでは、非常に多くの場合不可能です。この場合、アプリケーションは <a class="reference internal" href="glossary.html#term-detached"><span class="xref std std-term">detached</span></a> オブジェクトを処理する準備をし、 <a class="reference internal" href="glossary.html#term-eager-loading"><span class="xref std std-term">eager loading</span></a> を適切に使用して、オブジェクトが事前に必要なものを持っていることを確認する必要があります。</p></li>
</ul>
<ul class="simple">
<li><p><strong>そして重要なのは、expire_on_commitをFalseに設定することです</strong> - デタッチされたオブジェクトを使用する場合、オブジェクトがデータを再ロードする必要がある最も一般的な理由は、オブジェクトが <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> の最後の呼び出しから期限切れになっているためです。この期限切れはデタッチされたオブジェクトを扱うときには使用すべきではありません。そのため、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session.params.expire_on_commit" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.expire_on_commit</span></code></a> パラメータを <code class="docutils literal notranslate"><span class="pre">False</span></code> に設定します。オブジェクトがトランザクションの外部で期限切れにならないようにすることで、ロードされたデータはそのまま残り、そのデータにアクセスしたときに追加の遅延ロードが発生することはありません。</p></li>
</ul>
</section>
<section id="this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush">
<span id="error-7s2a"></span><h3>This Session’s transaction has been rolled back due to a previous exception during flush<a class="headerlink" href="#this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="orm/session_basics.html#session-flushing"><span class="std std-ref">Flushing</span></a> で説明されている <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> のフラッシュプロセスは、エラーが発生した場合、内部の一貫性を維持するためにデータベーストランザクションをロールバックします。しかし、これが発生すると、セッションのトランザクションは「非アクティブ」になり、失敗が発生しなかった場合に明示的にコミットする必要があるのと同じ方法で、呼び出し側アプリケーションによって明示的にロールバックする必要があります。</p>
<p>これはORMを使うときによくあるエラーで、通常は <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 操作の周りに正しい”枠組み”がないアプリケーションに当てはまります。詳細は <a class="reference internal" href="faq/sessions.html#faq-session-rollback"><span class="std std-ref">“This Session’s transaction has been rolled back due to a previous exception during flush.” (or similar)</span></a> のFAQで説明されています。</p>
</section>
<section id="for-relationship-relationship-delete-orphan-cascade-is-normally-configured-only-on-the-one-side-of-a-one-to-many-relationship-and-not-on-the-many-side-of-a-many-to-one-or-many-to-many-relationship">
<span id="error-bbf0"></span><h3>For relationship &lt;relationship&gt;, delete-orphan cascade is normally configured only on the “one” side of a one-to-many relationship, and not on the “many” side of a many-to-one or many-to-many relationship.<a class="headerlink" href="#for-relationship-relationship-delete-orphan-cascade-is-normally-configured-only-on-the-one-side-of-a-one-to-many-relationship-and-not-on-the-many-side-of-a-many-to-one-or-many-to-many-relationship" title="Link to this heading">¶</a></h3>
<p>このエラーは、”delete-orphan” <a class="reference internal" href="orm/cascades.html#unitofwork-cascades"><span class="std std-ref">cascade</span></a> が以下のような多対1または多対多の関係に設定されている場合に発生します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="c1"># this will emit the error message when the mapper</span>
    <span class="c1"># configuration step occurs</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">)</span>


<span class="n">configure_mappers</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上記の <code class="docutils literal notranslate"><span class="pre">B.a</span></code> の”delete-orphan”設定は、特定の <code class="docutils literal notranslate"><span class="pre">A</span></code> を参照するすべての <code class="docutils literal notranslate"><span class="pre">B</span></code> オブジェクトが削除された場合、 <code class="docutils literal notranslate"><span class="pre">A</span></code> も削除されるべきであるという意図を示しています。つまり、削除される”orphan”は <code class="docutils literal notranslate"><span class="pre">A</span></code> オブジェクトであり、それを参照するすべての <code class="docutils literal notranslate"><span class="pre">B</span></code> が削除されると”orphan”になることを表しています。</p>
<p>“delete-orphan”カスケードモデルでは、この機能はサポートされていません。”orphan”の考慮は、単一のオブジェクトの削除に関してのみ行われます。このオブジェクトは、この単一の削除によって”orphand”にされた0個以上のオブジェクトを参照します。その結果、これらのオブジェクトも削除されます。つまり、孤立オブジェクトごとに1つのみの”親”オブジェクトを削除することに基づいて、”orphan”の作成を追跡するように設計されています。これは、1対多の関係では自然なケースであり、”1”側のオブジェクトを削除すると、”多”側の関連アイテムも削除されます。</p>
<p>この機能をサポートするための上記のマッピングでは、代わりにカスケード設定を1対多の側に置きます。これは次のようになります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;bs&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">A</span></code> が削除されると、それが参照する <code class="docutils literal notranslate"><span class="pre">B</span></code> オブジェクトのすべても削除されるという意図が表明されている場合です。</p>
<p>次に、エラーメッセージは <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.single_parent" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.single_parent</span></code></a> フラグの使用法を示唆します。このフラグは、特定のオブジェクトを参照する多くのオブジェクトを持つことができる関係が、実際には一度に <strong>1つの</strong> オブジェクトしか参照しないことを強制するために使用できます。これは、外部キー関係が”多くの”コレクションを示唆するレガシーまたはその他のあまり理想的でないデータベーススキーマに使用されますが、実際には一度に1つのオブジェクトのみが特定のターゲットオブジェクトを参照します。このまれなシナリオは、次のように上記の例で示すことができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;A&quot;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span>
        <span class="n">single_parent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上記の設定は、 <code class="docutils literal notranslate"><span class="pre">B.a</span></code> 関係の範囲内で、一度に1つの <code class="docutils literal notranslate"><span class="pre">B</span></code> だけが <code class="docutils literal notranslate"><span class="pre">A</span></code> に関連付けられることを強制するバリデータをインストールします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a1</span>
<span class="go">sqlalchemy.exc.InvalidRequestError: Instance &lt;A at 0x7eff44359350&gt; is</span>
<span class="go">already associated with an instance of &lt;class &#39;__main__.B&#39;&gt; via its</span>
<span class="go">B.a attribute, and is only allowed a single parent.</span></pre></div>
</div>
<p>このバリデータの有効範囲は限られており、複数の”親”が別の方向から作成されるのを防ぐことはできないことに注意してください。たとえば、 <code class="docutils literal notranslate"><span class="pre">A.bs</span></code> に関しては同じ設定は検出されません。</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">VALUES</span>
<span class="p">()</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">a_id</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">a_id</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</div></pre></div>
</div>
<p>しかし、”delete-orphan”カスケードは <strong>単一の</strong> リードオブジェクトに関して機能し続けるので、後で物事は期待通りに進みません。つまり、 <code class="docutils literal notranslate"><span class="pre">B</span></code> オブジェクトの <strong>いずれか</strong> を削除すると、 <code class="docutils literal notranslate"><span class="pre">A</span></code> が削除されます。もう1つの <code class="docutils literal notranslate"><span class="pre">B</span></code> は近くにあり、ORMは通常、外部キー属性をNULLに設定するのに十分な賢さを持っていますが、通常はこれは望まれていることではありません。</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">a_id</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">(</span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">COMMIT</span>
</div></pre></div>
</div>
<p>上記のすべての例で、同様のロジックが多対多関係の計算に適用されます。多対多関係の一方でsingle_parent=Trueが設定されている場合、その側で”delete-orphan”カスケードを使用できます。ただし、多対多関係のポイントは、どちらの方向にもオブジェクトを参照する多くのオブジェクトが存在できるようにすることであるため、これが実際に必要とされるものである可能性は非常に低くなります。</p>
<p>全体として、 “delete-orphan”カスケードは通常、1対多関係の”1”側に適用されるため、”多”側のオブジェクトは削除されますが、その逆は行われません。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.3.18: </span>多対1または多対多の関係で使用された場合の”delete-orphan”エラーメッセージのテキストが、より説明的に更新されました。</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="orm/cascades.html#unitofwork-cascades"><span class="std std-ref">Cascades</span></a></p>
<p><a class="reference internal" href="orm/cascades.html#cascade-delete-orphan"><span class="std std-ref">delete-orphan</span></a></p>
<p><a class="reference internal" href="#error-bbf1"><span class="std std-ref">Instance &lt;instance&gt; is already associated with an instance of &lt;instance&gt; via its &lt;attribute&gt; attribute, and is only allowed a single parent.</span></a></p>
</div>
</section>
<section id="instance-instance-is-already-associated-with-an-instance-of-instance-via-its-attribute-attribute-and-is-only-allowed-a-single-parent">
<span id="error-bbf1"></span><h3>Instance &lt;instance&gt; is already associated with an instance of &lt;instance&gt; via its &lt;attribute&gt; attribute, and is only allowed a single parent.<a class="headerlink" href="#instance-instance-is-already-associated-with-an-instance-of-instance-via-its-attribute-attribute-and-is-only-allowed-a-single-parent" title="Link to this heading">¶</a></h3>
<p>このエラーは、 <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.single_parent" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.single_parent</span></code></a> フラグが使用され、同時に複数のオブジェクトがオブジェクトの”親”として割り当てられた場合に発生します。</p>
<p>次のようにマッピングします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;A&quot;</span><span class="p">,</span>
        <span class="n">single_parent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>インテントは、特定の <code class="docutils literal notranslate"><span class="pre">A</span></code> オブジェクトを一度に参照できる <code class="docutils literal notranslate"><span class="pre">B</span></code> オブジェクトは1つだけであることを示しています:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a1</span>
<span class="go">sqlalchemy.exc.InvalidRequestError: Instance &lt;A at 0x7eff44359350&gt; is</span>
<span class="go">already associated with an instance of &lt;class &#39;__main__.B&#39;&gt; via its</span>
<span class="go">B.a attribute, and is only allowed a single parent.</span></pre></div>
</div>
<p>このエラーが予期せずに発生した場合、通常は <a class="reference internal" href="#error-bbf0"><span class="std std-ref">For relationship &lt;relationship&gt;, delete-orphan cascade is normally configured only on the “one” side of a one-to-many relationship, and not on the “many” side of a many-to-one or many-to-many relationship.</span></a> で説明されているエラーメッセージに応じて <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.single_parent" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.single_parent</span></code></a> フラグが適用されたことが原因であり、この問題は実際には”delete-orphan”カスケード設定の誤解です。詳細については、このメッセージを参照してください。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#error-bbf0"><span class="std std-ref">For relationship &lt;relationship&gt;, delete-orphan cascade is normally configured only on the “one” side of a one-to-many relationship, and not on the “many” side of a many-to-one or many-to-many relationship.</span></a></p>
</div>
</section>
<section id="relationship-x-will-copy-column-q-to-column-p-which-conflicts-with-relationship-s-y">
<span id="error-qzyx"></span><h3>relationship X will copy column Q to column P, which conflicts with relationship(s): ‘Y’<a class="headerlink" href="#relationship-x-will-copy-column-q-to-column-p-which-conflicts-with-relationship-s-y" title="Link to this heading">¶</a></h3>
<p>この警告は、2つ以上の関係がフラッシュ時に同じ列にデータを書き込むが、ORMにはこれらの関係を調整する手段がない場合を指します。具体的には、 <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.back_populates" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code></a> を使用して2つの関係を互いに参照する必要がある、1つ以上の関係を <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a> で設定して書き込みの競合を防ぐ、場合によっては設定が完全に意図的であり、 <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.overlaps" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.overlaps</span></code></a> を設定して各警告を沈黙させる、などの解決策が考えられます。</p>
<p><a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.back_populates" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code></a> が欠落している典型的な例では、次のようにマッピングされます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;parent&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Child&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;child&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;parent.id&quot;</span><span class="p">))</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Parent&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上記のマッピングでは警告が生成されます:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>SAWarning: relationship &#39;Child.parent&#39; will copy column parent.id to column child.parent_id,
which conflicts with relationship(s): &#39;Parent.children&#39; (copies parent.id to child.parent_id).</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Child.parent</span></code> と <code class="docutils literal notranslate"><span class="pre">Parent.children</span></code> の関係が矛盾しているようです。解決策は <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.back_populates" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code></a> を適用することです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;parent&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Child&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;child&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;parent.id&quot;</span><span class="p">))</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;children&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>“オーバーラップ”状態が意図的で解決できない、よりカスタマイズされた関係の場合、 <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.overlaps" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.overlaps</span></code></a> パラメータは、警告が有効にならない関係の名前を指定することがあります。これは通常、それぞれのケースで関連する項目を制限するカスタムの <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 条件を含む、同じ基礎となるテーブルに対する2つ以上の関係に対して発生します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;parent&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Child&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(Parent.id == Child.parent_id, Child.flag == 0)&quot;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span>
        <span class="n">overlaps</span><span class="o">=</span><span class="s2">&quot;c2, parent&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Child&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(Parent.id == Child.parent_id, Child.flag == 1)&quot;</span><span class="p">,</span>
        <span class="n">overlaps</span><span class="o">=</span><span class="s2">&quot;c1, parent&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;child&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;parent.id&quot;</span><span class="p">))</span>

    <span class="n">flag</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上記では、ORMは <code class="docutils literal notranslate"><span class="pre">Parent.c1</span></code> 、 <code class="docutils literal notranslate"><span class="pre">Parent.c2</span></code> 、 <code class="docutils literal notranslate"><span class="pre">Child.parent</span></code> の間の重複が意図的であることを認識します。</p>
</section>
<section id="object-cannot-be-converted-to-persistent-state-as-this-identity-map-is-no-longer-valid">
<span id="error-lkrp"></span><h3>Object cannot be converted to ‘persistent’ state, as this identity map is no longer valid.<a class="headerlink" href="#object-cannot-be-converted-to-persistent-state-as-this-identity-map-is-no-longer-valid" title="Link to this heading">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.26.</span></p>
</div>
<p>このメッセージは、ORMオブジェクトを生成する <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> オブジェクトが、元の <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> が閉じられた後、またはその <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session.expunge_all" title="sqlalchemy.orm.Session.expunge_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expunge_all()</span></code></a> メソッドが呼び出された後に繰り返される場合に対応するために追加されました。 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> が一度にすべてのオブジェクトを削除すると、その <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> で使用されている内部の <a class="reference internal" href="glossary.html#term-identity-map"><span class="xref std std-term">identity map</span></a> は新しいものに置き換えられ、元のものは破棄されます。消費されず、バッファもされていない <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> オブジェクトは、破棄されたidentity mapへの参照を内部で保持します。したがって、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> が消費されると、生成されるオブジェクトをその <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> に関連付けることはできません。一般に、バッファもされていない <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> オブジェクトを、それが作成されたトランザクションコンテキストの外で繰り返すことは推奨されないので、この配置は設計上のものです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># context manager creates new Session</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session_obj</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># context manager is closed, so session_obj above is closed, identity</span>
<span class="c1"># map is replaced</span>

<span class="c1"># iterating the result object can&#39;t associate the object with the</span>
<span class="c1"># Session, raises this error.</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
</div>
<p>上記の状況は、 <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncSession" title="sqlalchemy.ext.asyncio.AsyncSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncSession</span></code></a> がsync-styleの <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> を返す場合のように、ORM拡張の <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> を使用する場合には <strong>発生しません</strong> 。この場合、結果は文の実行時に事前にバッファされています。これは、2番目のEager Loaderが追加の <code class="docutils literal notranslate"><span class="pre">await</span></code> 呼び出しを必要とせずに呼び出すことを可能にするためです。</p>
<p>上記の状況で、通常の <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> を使って、 <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> 拡張が行うのと同じように結果を事前にバッファリングするには、次のように <code class="docutils literal notranslate"><span class="pre">prebuffer_rows</span></code> 実行オプションを使うことができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># context manager creates new Session</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session_obj</span><span class="p">:</span>
    <span class="c1"># result internally pre-fetches all objects</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">7</span><span class="p">),</span> <span class="n">execution_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;prebuffer_rows&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="p">)</span>

<span class="c1"># context manager is closed, so session_obj above is closed, identity</span>
<span class="c1"># map is replaced</span>

<span class="c1"># pre-buffered objects are returned</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># however they are detached from the session, which has been closed</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">detached</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span></pre></div>
</div>
<p>上の例では、選択されたORMオブジェクトは完全に <code class="docutils literal notranslate"><span class="pre">session_obj</span></code> ブロック内で生成され、 <code class="docutils literal notranslate"><span class="pre">session_obj</span></code> に関連付けられ、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> オブジェクト内に反復のためにバッファされます。ブロックの外では、 <code class="docutils literal notranslate"><span class="pre">session_obj</span></code> が閉じられ、これらのORMオブジェクトが削除されます。 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> オブジェクトを反復すると、これらのORMオブジェクトが生成されますが、元の <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> がそれらを削除すると、それらは <a class="reference internal" href="glossary.html#term-detached"><span class="xref std std-term">detached</span></a> 状態で配信されます。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>上記の”pre-buffered”対”un-buffered” <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> オブジェクトへの参照は、ORMが <a class="reference internal" href="glossary.html#term-DBAPI"><span class="xref std std-term">DBAPI</span></a> から入ってくる生のデータベース行をORMオブジェクトに変換するプロセスを参照しています。これは、DBAPIからの保留中の結果を表す基礎となる <code class="docutils literal notranslate"><span class="pre">cursor</span></code> オブジェクト自体が、本質的にはバッファリングの下位層であるため、バッファリングされているか、されていないかを意味するものではありません。 <code class="docutils literal notranslate"><span class="pre">cursor</span></code> 結果自体のバッファリングのバックグラウンドについては、 <a class="reference internal" href="core/connections.html#engine-stream-results"><span class="std std-ref">Using Server Side Cursors (a.k.a. stream results)</span></a> のセクションを参照してください。</p>
</div>
</section>
<section id="type-annotation-can-t-be-interpreted-for-annotated-declarative-table-form">
<span id="error-zlpr"></span><h3>Type annotation can’t be interpreted for Annotated Declarative Table form<a class="headerlink" href="#type-annotation-can-t-be-interpreted-for-annotated-declarative-table-form" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy 2.0では、新しい <a class="reference internal" href="orm/declarative_tables.html#orm-declarative-mapped-column"><span class="std std-ref">Annotated Declarative Table</span></a> 宣言システムが導入されました。これは、実行時にクラス定義内の <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a> アノテーションからORMにマッピングされた属性情報を導出します。この形式の要件は、すべてのORMアノテーションが適切にアノテーションされるために <a class="reference internal" href="orm/internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> と呼ばれる汎用コンテナを利用しなければならないことです。明示的な <span class="target" id="index-1"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a> 型付けアノテーションを含むレガシーSQLAlchemyマッピング(型付けサポートに <a class="reference internal" href="orm/extensions/mypy.html"><span class="std std-ref">legacy Mypy extension</span></a> を使用するものなど)には、この汎用を含まない <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> などのディレクティブが含まれる場合があります。</p>
<p>解決するには、2.0構文に完全に移行できるようになるまで、クラスに <code class="docutils literal notranslate"><span class="pre">__allow_unmapped__</span></code> ブール属性を付けます。例については、 <a class="reference internal" href="changelog/migration_20.html#migration-20-step-six"><span class="std std-ref">Migration to 2.0 Step Six - Add __allow_unmapped__ to explicitly typed ORM models</span></a> の移行に関する注意を参照してください。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="changelog/migration_20.html#migration-20-step-six"><span class="std std-ref">Migration to 2.0 Step Six - Add __allow_unmapped__ to explicitly typed ORM models</span></a> - in the <a class="reference internal" href="changelog/migration_20.html"><span class="std std-ref">SQLAlchemy 2.0 - Major Migration Guide</span></a> document</p>
</div>
</section>
<section id="when-transforming-cls-to-a-dataclass-attribute-s-originate-from-superclass-cls-which-is-not-a-dataclass">
<span id="error-dcmx"></span><h3>When transforming &lt;cls&gt; to a dataclass, attribute(s) originate from superclass &lt;cls&gt; which is not a dataclass.<a class="headerlink" href="#when-transforming-cls-to-a-dataclass-attribute-s-originate-from-superclass-cls-which-is-not-a-dataclass" title="Link to this heading">¶</a></h3>
<p>この警告は、以下の例のように、 <a class="reference internal" href="orm/dataclasses.html#orm-declarative-native-dataclasses"><span class="std std-ref">Declarative Dataclass Mapping</span></a> で説明されているSQLAlchemy ORM Mapped Dataclasses機能を、それ自体がデータクラスとして宣言されていないミックスインクラスまたは抽象ベースと組み合わせて使用すると発生します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>


<span class="k">class</span> <span class="nc">Mixin</span><span class="p">:</span>
    <span class="n">create_user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">update_user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">MappedAsDataclass</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">Mixin</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sys_user&quot;</span>

    <span class="n">uid</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="n">uuid4</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上記では、 <code class="docutils literal notranslate"><span class="pre">Mixin</span></code> 自体は <a class="reference internal" href="orm/mapping_api.html#sqlalchemy.orm.MappedAsDataclass" title="sqlalchemy.orm.MappedAsDataclass"><code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code></a> から拡張されていないので、以下の警告が生成されます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SADeprecationWarning: When transforming &lt;class &#39;__main__.User&#39;&gt; to a
dataclass, attribute(s) &quot;create_user&quot;, &quot;update_user&quot; originates from
superclass &lt;class
&#39;__main__.Mixin&#39;&gt;, which is not a dataclass. This usage is deprecated and
will raise an error in SQLAlchemy 2.1. When declaring SQLAlchemy
Declarative Dataclasses, ensure that all mixin classes and other
superclasses which include attributes are also a subclass of
MappedAsDataclass.</pre></div>
</div>
<p>この問題を解決するには、 <a class="reference internal" href="orm/mapping_api.html#sqlalchemy.orm.MappedAsDataclass" title="sqlalchemy.orm.MappedAsDataclass"><code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code></a> を <code class="docutils literal notranslate"><span class="pre">Mixin</span></code> のシグネチャに追加します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mixin</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">):</span>
    <span class="n">create_user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">update_user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Pythonの <span class="target" id="index-2"></span><a class="pep reference external" href="https://peps.python.org/pep-0681/"><strong>PEP 681</strong></a> 仕様は、自身がデータクラスではないデータクラスのスーパークラスで宣言された属性に対応していません。Pythonのデータクラスの動作では、以下の例のように、そのようなフィールドは無視されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">field</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>


<span class="k">class</span> <span class="nc">Mixin</span><span class="p">:</span>
    <span class="n">create_user</span><span class="p">:</span> <span class="n">int</span>
    <span class="n">update_user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Mixin</span><span class="p">):</span>
    <span class="n">uid</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">str</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上記では、 <code class="docutils literal notranslate"><span class="pre">User</span></code> クラスはコンストラクタに <code class="docutils literal notranslate"><span class="pre">create_user</span></code> を含まず、 <code class="docutils literal notranslate"><span class="pre">update_user</span></code> をデータクラス属性として解釈しません。これは <code class="docutils literal notranslate"><span class="pre">Mixin</span></code> がデータクラスではないからです。</p>
<p>2.0シリーズのSQLAlchemyのデータクラス機能では、この動作は正しく行われません。代わりに、非データクラスのミックスインやスーパークラスの属性は、最終的なデータクラス設定の一部として扱われます。しかし、PyrightやMypyのような型チェッカーは、これらのフィールドをデータクラスコンストラクタの一部とはみなしません。なぜなら、これらは <span class="target" id="index-3"></span><a class="pep reference external" href="https://peps.python.org/pep-0681/"><strong>PEP 681</strong></a> によって無視されるからです。これらの存在は他の点では曖昧であるため、SQLAlchemy 2.1では、データクラス階層内にSQLAlchemyがマップされた属性を持つミックスインクラスは、それ自体がデータクラスでなければならないことが要求されます。</p>
</section>
<section id="python-dataclasses-error-encountered-when-creating-dataclass-for-classname">
<span id="error-dcte"></span><h3>Python dataclasses error encountered when creating dataclass for &lt;classname&gt;<a class="headerlink" href="#python-dataclasses-error-encountered-when-creating-dataclass-for-classname" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="orm/mapping_api.html#sqlalchemy.orm.MappedAsDataclass" title="sqlalchemy.orm.MappedAsDataclass"><code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code></a> ミックスインクラスまたは <a class="reference internal" href="orm/mapping_api.html#sqlalchemy.orm.registry.mapped_as_dataclass" title="sqlalchemy.orm.registry.mapped_as_dataclass"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped_as_dataclass()</span></code></a> デコレータを使用する場合、SQLAlchemyはPython標準ライブラリにある実際の <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">Python dataclasses</a> モジュールを使用して、データクラスの動作をターゲットクラスに適用します。このAPIには独自のエラーシナリオがあり、そのほとんどはユーザ定義クラスでの <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> メソッドの構築を含みます。クラスで宣言された属性の順序は、 <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#inheritance">on superclasses</a> と同様に、どのように <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> メソッドが構築されるかを決定します。また、属性の編成方法や、<code class="docutils literal notranslate"><span class="pre">init=False</span></code> 、<code class="docutils literal notranslate"><span class="pre">kw_only=True</span></code> などのパラメータの使用方法には特定の規則があります。 <strong>SQLAlchemyはこれらの規則を制御または実装しません</strong> 。したがって、この種のエラーについては、 <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">Python dataclasses</a> のドキュメントを参照してください。特に <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#inheritance">inheritance</a> に適用される規則に注意してください。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="orm/dataclasses.html#orm-declarative-native-dataclasses"><span class="std std-ref">Declarative Dataclass Mapping</span></a> - SQLAlchemyデータクラスのドキュメント</p>
<p><a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">Python dataclasses</a> - python.orgのWebサイト</p>
<p><a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#inheritance">inheritance</a>  - python.orgのWebサイト</p>
</div>
</section>
<section id="per-row-orm-bulk-update-by-primary-key-requires-that-records-contain-primary-key-values">
<span id="error-bupq"></span><h3>per-row ORM Bulk Update by Primary Key requires that records contain primary key values<a class="headerlink" href="#per-row-orm-bulk-update-by-primary-key-requires-that-records-contain-primary-key-values" title="Link to this heading">¶</a></h3>
<p>このエラーは、 <a class="reference internal" href="orm/queryguide/dml.html#orm-queryguide-bulk-update"><span class="std std-ref">ORM Bulk UPDATE by Primary Key</span></a> 機能を利用する際に、以下のような指定されたレコードに主キー値を指定しないと発生します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">bindparam</span><span class="p">(</span><span class="s2">&quot;u_name&quot;</span><span class="p">)),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;u_name&quot;</span><span class="p">:</span> <span class="s2">&quot;spongebob&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;u_name&quot;</span><span class="p">:</span> <span class="s2">&quot;patrick&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<p>上記では、パラメータ辞書のリストの存在と、ORM対応のUPDATE文を実行するための <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> の使用を組み合わせることで、自動的に主キーによるORMのバルクアップデートが使用されます。これは、パラメータ辞書が主キーの値を含むことを期待しています。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Eugene H. Krabs&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<p>レコードごとの主キーの値を指定せずにUPDATE文を呼び出すには、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session.connection" title="sqlalchemy.orm.Session.connection"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.connection()</span></code></a> を使って現在の <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> を取得し、それを使ってを呼び出します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">bindparam</span><span class="p">(</span><span class="s2">&quot;u_name&quot;</span><span class="p">)),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;u_name&quot;</span><span class="p">:</span> <span class="s2">&quot;spongebob&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;u_name&quot;</span><span class="p">:</span> <span class="s2">&quot;patrick&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="orm/queryguide/dml.html#orm-queryguide-bulk-update"><span class="std std-ref">ORM Bulk UPDATE by Primary Key</span></a></p>
<p><a class="reference internal" href="orm/queryguide/dml.html#orm-queryguide-bulk-update-disabling"><span class="std std-ref">Disabling Bulk ORM Update by Primary Key for an UPDATE statement with multiple parameter sets</span></a></p>
</div>
</section>
</section>
<section id="asyncio-exceptions">
<h2>AsyncIO Exceptions<a class="headerlink" href="#asyncio-exceptions" title="Link to this heading">¶</a></h2>
<section id="awaitrequired">
<span id="error-xd1r"></span><h3>AwaitRequired<a class="headerlink" href="#awaitrequired" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy非同期モードでは、データベースへの接続に非同期ドライバを使用する必要があります。このエラーは通常、互換性のない <a class="reference internal" href="glossary.html#term-DBAPI"><span class="xref std std-term">DBAPI</span></a> で非同期バージョンのSQLAlchemyを使用しようとしたときに発生します。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="orm/extensions/asyncio.html"><span class="std std-ref">Asynchronous I/O (asyncio)</span></a></p>
</div>
</section>
<section id="missinggreenlet">
<span id="error-xd2s"></span><h3>MissingGreenlet<a class="headerlink" href="#missinggreenlet" title="Link to this heading">¶</a></h3>
<p>async <a class="reference internal" href="glossary.html#term-DBAPI"><span class="xref std std-term">DBAPI</span></a> の呼び出しが、通常はSQLAlchemy AsyncIOプロキシクラスによって設定されたgreenlet spawnコンテキストの外で開始されました。通常、このエラーは、 <code class="docutils literal notranslate"><span class="pre">await</span></code> キーワードの使用を直接提供しない呼び出しパターンを使用して、予期しない場所でIOが試行されたときに発生します。ORMを使用する場合、これはほとんど常に <a class="reference internal" href="glossary.html#term-lazy-loading"><span class="xref std std-term">lazy loading</span></a> の使用によるものです。これは、正常に使用するために追加のステップや代替のローダーパターンがなければ、AsyncIOで直接サポートされません。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="orm/extensions/asyncio.html#asyncio-orm-avoid-lazyloads"><span class="std std-ref">Preventing Implicit IO when Using AsyncSession</span></a> - この問題が発生する可能性のあるほとんどのORMシナリオと、遅延ロードシナリオで使用する特定のパターンを含む緩和方法をカバーしています。</p>
</div>
</section>
<section id="no-inspection-available">
<span id="error-xd3s"></span><h3>No Inspection Available<a class="headerlink" href="#no-inspection-available" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncConnection" title="sqlalchemy.ext.asyncio.AsyncConnection"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncConnection</span></code></a> または <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncEngine" title="sqlalchemy.ext.asyncio.AsyncEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncEngine</span></code></a> オブジェクトに対して <a class="reference internal" href="core/inspection.html#sqlalchemy.inspect" title="sqlalchemy.inspect"><code class="xref py py-func docutils literal notranslate"><span class="pre">inspect()</span></code></a> 関数を直接使用することは、現在サポートされていません。これは、 <a class="reference internal" href="core/reflection.html#sqlalchemy.engine.reflection.Inspector" title="sqlalchemy.engine.reflection.Inspector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Inspector</span></code></a> オブジェクトの待機可能な形式がまだ存在しないためです。代わりに、 <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncConnection" title="sqlalchemy.ext.asyncio.AsyncConnection"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncConnection</span></code></a> オブジェクトの基礎となる <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncConnection.sync_connection" title="sqlalchemy.ext.asyncio.AsyncConnection.sync_connection"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AsyncConnection.sync_connection</span></code></a> 属性を参照するような方法で、 <a class="reference internal" href="core/inspection.html#sqlalchemy.inspect" title="sqlalchemy.inspect"><code class="xref py py-func docutils literal notranslate"><span class="pre">inspect()</span></code></a> 関数を使用してオブジェクトを取得することによって使用されます。その後、 <code class="xref py py-class docutils literal notranslate"><span class="pre">Inspector</span></code> は、 <a class="reference internal" href="orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncConnection.run_sync" title="sqlalchemy.ext.asyncio.AsyncConnection.run_sync"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AsyncConnection.run_sync()</span></code></a> メソッドと、必要な操作を実行するカスタム関数を使用して、”同期”呼び出しスタイルで使用されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">async_main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">sync_conn</span><span class="p">:</span> <span class="n">inspect</span><span class="p">(</span><span class="n">sync_conn</span><span class="p">)</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
        <span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="orm/extensions/asyncio.html#asyncio-inspector"><span class="std std-ref">Using the Inspector to inspect schema objects</span></a> - asyncio拡張で <a class="reference internal" href="core/inspection.html#sqlalchemy.inspect" title="sqlalchemy.inspect"><code class="xref py py-func docutils literal notranslate"><span class="pre">inspect()</span></code></a> を使う追加の例です。</p>
</div>
</section>
</section>
<section id="core-exception-classes">
<h2>Core Exception Classes<a class="headerlink" href="#core-exception-classes" title="Link to this heading">¶</a></h2>
<p>コア例外クラスについては <a class="reference internal" href="core/exceptions.html"><span class="std std-ref">Core Exceptions</span></a> を参照してください。</p>
</section>
<section id="orm-exception-classes">
<h2>ORM Exception Classes<a class="headerlink" href="#orm-exception-classes" title="Link to this heading">¶</a></h2>
<p>ORM例外クラスについては <a class="reference internal" href="orm/exceptions.html"><span class="std std-ref">ORM Exceptions</span></a> を参照してください。</p>
</section>
<section id="legacy-exceptions">
<h2>Legacy Exceptions<a class="headerlink" href="#legacy-exceptions" title="Link to this heading">¶</a></h2>
<p>このセクションの例外は、現在のSQLAlchemyバージョンでは生成されませんが、例外メッセージのハイパーリンクに対応するためにここで説明します。</p>
<section id="the-some-function-in-sqlalchemy-2-0-will-no-longer-something">
<span id="error-b8d9"></span><h3>The &lt;some function&gt; in SQLAlchemy 2.0 will no longer &lt;something&gt;<a class="headerlink" href="#the-some-function-in-sqlalchemy-2-0-will-no-longer-something" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy 2.0は、コアコンポーネントとORMコンポーネントの両方におけるさまざまな主要なSQLAlchemy使用パターンの大きな変化を表しています。2.0リリースの目標は、SQLAlchemyの初期の開始以来の最も基本的な前提条件のいくつかを若干再調整し、コアコンポーネントとORMコンポーネントの間で大幅にミニマムで一貫性があり、より有能であることが期待される、新たに合理化された利用モデルを提供することです。</p>
<p><a class="reference internal" href="changelog/migration_20.html"><span class="std std-ref">SQLAlchemy 2.0 - Major Migration Guide</span></a> で紹介されたSQLAlchemy 2.0プロジェクトには、SQLAlchemyの1.4シリーズに統合された包括的な将来の互換性システムが含まれており、アプリケーションを完全に2.0互換に移行するために、アプリケーションに明確で曖昧さのない段階的なアップグレードパスを提供します。 <code class="xref py py-class docutils literal notranslate"><span class="pre">RemovedIn20Warning</span></code> 非推奨警告は、既存のコードベースのどの動作を変更する必要があるかについてのガイダンスを提供するために、このシステムの基礎にあります。この警告を有効にする方法の概要は <a class="reference internal" href="changelog/migration_14.html#deprecation-20-mode"><span class="std std-ref">SQLAlchemy 2.0 Deprecations Mode</span></a> にあります。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="changelog/migration_20.html"><span class="std std-ref">SQLAlchemy 2.0 - Major Migration Guide</span></a> - 1.xシリーズからのアップグレードプロセスの概要と、SQLAlchemy 2.0の現在の目標と進捗状況。</p>
<p><a class="reference internal" href="changelog/migration_14.html#deprecation-20-mode"><span class="std std-ref">SQLAlchemy 2.0 Deprecations Mode</span></a> - SQLAlchemy 1.4の”2.0 deprecations mode”の使用方法に関するガイドライン。</p>
</div>
</section>
<section id="object-is-being-merged-into-a-session-along-the-backref-cascade">
<span id="error-s9r1"></span><h3>Object is being merged into a Session along the backref cascade<a class="headerlink" href="#object-is-being-merged-into-a-session-along-the-backref-cascade" title="Link to this heading">¶</a></h3>
<p>このメッセージは、バージョン2.0で削除されたSQLAlchemyの”backref cascade”の動作を参照しています。これは、そのセッションに既に存在する別のオブジェクトが関連付けられた結果として、オブジェクトが <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> に追加される動作を参照しています。この動作は役に立つというよりも混乱を招くことが示されているので、 <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.cascade_backrefs" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.cascade_backrefs</span></code></a> と <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.backref.params.cascade_backrefs `パラメータが追加されました。これを ``False`" title="sqlalchemy.orm.backref"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">backref.cascade_backrefs</span> <span class="pre">`パラメータが追加されました。これを</span> <span class="pre">``False`</span></code></a> に設定して無効にすることができます。SQLAlchemy 2.0では”cascade backrefs”の動作は完全に削除されました。</p>
<p>古いバージョンのSQLAlchemyでは、現在 <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.backref" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.backref</span></code></a> 文字列パラメータを使って設定されているbackrefに対して <a class="reference internal" href="orm/relationship_api.html#sqlalchemy.orm.relationship.params.cascade_backrefs" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.cascade_backrefs</span></code></a> を <code class="docutils literal notranslate"><span class="pre">False</span></code> に設定するには、まず <code class="xref py py-func docutils literal notranslate"><span class="pre">cascade_backrefs()</span></code> パラメータを渡せるようにしなければなりません。</p>
<p>あるいは、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session.params.future" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.future</span></code></a> パラメータに <code class="docutils literal notranslate"><span class="pre">True</span></code> を渡すことで、”future”モードで <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> を 使用して、”cascade backrefs”動作全体を全面的にオフにすることもできます。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="changelog/migration_14.html#change-5150"><span class="std std-ref">cascade_backrefs behavior deprecated for removal in 2.0</span></a> - SQLAlchemy 2.0の変更のバックグラウンド</p>
</div>
</section>
<section id="select-construct-created-in-legacy-mode-keyword-arguments-etc">
<span id="error-c9ae"></span><h3>select() construct created in “legacy” mode; keyword arguments, etc.<a class="headerlink" href="#select-construct-created-in-legacy-mode-keyword-arguments-etc" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> 構文はSQLAlchemy 1.4の時点で更新され、SQLAlchemy 2.0の標準である新しい呼び出しスタイルをサポートします。1.4シリーズとの下位互換性のために、この構文は”legacy”スタイルと”new”スタイルの両方の引数を受け付けます。</p>
<p>“new”スタイルは、列とテーブルの式が <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> 構文に位置的に渡されることを特徴としています。オブジェクトに対するその他の修飾子は、後続のメソッドチェーニングを使って渡さなければなりません:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># this is the way to do it going forward</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span> <span class="o">==</span> <span class="n">table2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">otherid</span><span class="p">)</span></pre></div>
</div>
<p>比較のために、 <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.Select.where" title="sqlalchemy.sql.expression.Select.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.where()</span></code></a> のようなメソッドが追加される前のSQLAlchemyのレガシー形式の <a class="reference internal" href="core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> は、次のようになります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># this is how it was documented in original SQLAlchemy versions</span>
<span class="c1"># many years ago</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span><span class="p">],</span> <span class="n">whereclause</span><span class="o">=</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span> <span class="o">==</span> <span class="n">table2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">otherid</span><span class="p">)</span></pre></div>
</div>
<p>あるいは、”where句”が位置的に渡されることもあります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># this is also how it was documented in original SQLAlchemy versions</span>
<span class="c1"># many years ago</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span><span class="p">],</span> <span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span> <span class="o">==</span> <span class="n">table2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">otherid</span><span class="p">)</span></pre></div>
</div>
<p>ここ数年、追加の”where句”やその他の引数が受け入れられていましたが、ほとんどの説明文書から削除されました。これにより、リストとして渡される列引数のリストとして最もよく知られた呼び出しスタイルになりましたが、それ以上の引数はありません:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># this is how it&#39;s been documented since around version 1.0 or so</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">myid</span> <span class="o">==</span> <span class="n">table2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">otherid</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference internal" href="changelog/migration_20.html#migration-20-5284"><span class="std std-ref">select() no longer accepts varied constructor arguments, columns are passed positionally</span></a> の文書では、この変更を <a class="reference internal" href="changelog/migration_20.html"><span class="std std-ref">2.0 Migration</span></a> の観点から説明しています。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="changelog/migration_20.html#migration-20-5284"><span class="std std-ref">select() no longer accepts varied constructor arguments, columns are passed positionally</span></a></p>
<p><a class="reference internal" href="changelog/migration_20.html"><span class="std std-ref">SQLAlchemy 2.0 - Major Migration Guide</span></a></p>
</div>
</section>
<section id="a-bind-was-located-via-legacy-bound-metadata-but-since-future-true-is-set-on-this-session-this-bind-is-ignored">
<span id="error-c9bf"></span><h3>A bind was located via legacy bound metadata, but since future=True is set on this Session, this bind is ignored.<a class="headerlink" href="#a-bind-was-located-via-legacy-bound-metadata-but-since-future-true-is-set-on-this-session-this-bind-is-ignored" title="Link to this heading">¶</a></h3>
<p>“バインドされたメタデータ”という概念はSQLAlchemy 1.4まで存在していましたが、SQLAlchemy 2.0では削除されました。</p>
<p>このエラーは、ORM <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> のようなオブジェクトが特定のマップされたクラスを <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> に関連付けることを可能にする <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> オブジェクトの <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.MetaData.params.bind" title="sqlalchemy.schema.MetaData"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">MetaData.bind</span></code></a> パラメータを参照します。SQLAlchemy 2.0では、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> は各 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> に直接リンクされていなければなりません。つまり、引数なしで <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> または <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.sessionmaker" title="sqlalchemy.orm.sessionmaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code></a> をインスタンス化し、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> を <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> に関連付けるのではありません:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata_obj</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span> <span class="o">...</span>


<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyClass</span><span class="p">())</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>代わりに、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> を <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.sessionmaker" title="sqlalchemy.orm.sessionmaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code></a> または <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> に直接関連付ける必要があります。 <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> オブジェクトはどのエンジンにも関連付けるべきではありません:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span> <span class="o">...</span>


<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyClass</span><span class="p">())</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>SQLAlchemy 1.4では、この <a class="reference internal" href="glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a> の振る舞いは、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session.params.future" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.future</span></code></a> フラグが <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.sessionmaker" title="sqlalchemy.orm.sessionmaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code></a> または <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> に設定されている場合に有効になります。</p>
</section>
<section id="this-compiled-object-is-not-bound-to-any-engine-or-connection">
<span id="error-2afi"></span><h3>This Compiled object is not bound to any Engine or Connection<a class="headerlink" href="#this-compiled-object-is-not-bound-to-any-engine-or-connection" title="Link to this heading">¶</a></h3>
<p>このエラーは、1.xバージョンにのみ存在するレガシーSQLAlchemyパターンである”バインドされたメタデータ”の概念に関連しています。この問題は、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> に関連付けられていないCore式オブジェクトから直接 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Executable.execute()</span></code> メソッドを呼び出したときに発生します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c1"># &lt;--- raises</span></pre></div>
</div>
<p>このロジックが想定しているのは、 <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> オブジェクトが <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> に <strong>バインド</strong> されているということです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql+pymysql://user:pass@host/db&quot;</span><span class="p">)</span>
<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span></pre></div>
</div>
<p>上記の場合、 <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> から派生し、その <a class="reference internal" href="core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> から派生するステートメントは、暗黙的に指定された <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> を使用してステートメントを呼び出します。</p>
<p>バインドされたメタデータの概念は、 <strong>SQLAlchemy 2.0</strong> には存在しないことに注意してください。文を呼び出す正しい方法は、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> の <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection.execute" title="sqlalchemy.engine.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a> メソッドを使用することです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p>ORMを使用する場合、 <a class="reference internal" href="orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 経由で同様の機能を利用できます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="tutorial/dbapi_transactions.html#tutorial-statement-execution"><span class="std std-ref">Basics of Statement Execution</span></a></p>
</div>
</section>
<section id="this-connection-is-on-an-inactive-transaction-please-rollback-fully-before-proceeding">
<span id="error-8s2a"></span><h3>This connection is on an inactive transaction.  Please rollback() fully before proceeding<a class="headerlink" href="#this-connection-is-on-an-inactive-transaction-please-rollback-fully-before-proceeding" title="Link to this heading">¶</a></h3>
<p>このエラー条件は、バージョン1.4のSQLAlchemyに追加されたもので、SQLAlchemy 2.0には適用されません。このエラーは、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> が <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Connection.begin" title="sqlalchemy.engine.Connection.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin()</span></code></a> のようなメソッドを使ってトランザクションに入れられ、そのスコープ内でさらに”マーカー”トランザクションが作成される状態を指します。”マーカー”トランザクションは、その後 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Transaction.rollback" title="sqlalchemy.engine.Transaction.rollback"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Transaction.rollback()</span></code></a> を使ってロールバックされるか、 <a class="reference internal" href="core/connections.html#sqlalchemy.engine.Transaction.close" title="sqlalchemy.engine.Transaction.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Transaction.close()</span></code></a> を使って閉じられますが、外側のトランザクションはまだ”非アクティブ”な状態なので、ロールバックする必要があります。</p>
<p>The pattern looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">transaction1</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

<span class="c1"># this is a &quot;sub&quot; or &quot;marker&quot; transaction, a logical nesting</span>
<span class="c1"># structure based on &quot;real&quot; transaction transaction1</span>
<span class="n">transaction2</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="n">transaction2</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

<span class="c1"># transaction1 is still present and needs explicit rollback,</span>
<span class="c1"># so this will raise</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select 1&quot;</span><span class="p">))</span></pre></div>
</div>
<p>上の例では、 <code class="docutils literal notranslate"><span class="pre">transaction2</span></code> は <code class="docutils literal notranslate"><span class="pre">マーカー</span></code> トランザクションであり、外部トランザクション内の論理的なネストを示しています。内部トランザクションはrollback()メソッドによってトランザクション全体をロールバックできますが、commit()メソッドは”マーカー”トランザクション自体のスコープを閉じる以外には何の効果もありません。 <code class="docutils literal notranslate"><span class="pre">transaction2.rollback()</span></code> の呼び出しは、基本的にデータベースレベルでロールバックされることを意味する <code class="docutils literal notranslate"><span class="pre">transaction1</span></code> を <strong>非アクティブ化</strong> する効果がありますが、トランザクションの一貫したネストパターンに対応するために存在しています。</p>
<p>正しい解決方法は、外部トランザクションも確実にロールバックされるようにすることです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">transaction1</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span></pre></div>
</div>
<p>このパターンはCoreでは一般的に使用されていません。ORM内では、ORMの “論理的な” トランザクション構造の産物である同様の問題が発生する可能性があります。これは <a class="reference internal" href="faq/sessions.html#faq-session-rollback"><span class="std std-ref">“This Session’s transaction has been rolled back due to a previous exception during flush.” (or similar)</span></a> のFAQエントリで説明されています。</p>
<p>SQLAlchemy 2.0では”subtransaction”パターンが削除されたため、この特定のプログラミングパターンは使用できなくなり、このエラーメッセージが表示されなくなりました。</p>
</section>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="faq/thirdparty.html" title="previous chapter">Third Party Integration Issues</a>
        Next:
        <a href="changelog/index.html" title="next chapter">Changes and Migration</a>

    <div id="docs-copyright">
        &copy; <a href="copyright.html">Copyright</a> 2007-2024, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.2.6.

    Documentation last generated: Wed Aug  7 22:02:17 2024 JST

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      document.documentElement.dataset.content_root = './';

    </script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="_static/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="_static/init.js"></script>


    </body>
</html>


