<!DOCTYPE html>



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    What’s New in SQLAlchemy 2.0?
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="Changes and Migration" href="index.html" />
        <link rel="next" title="2.0 Changelog" href="changelog_20.html" />
        <link rel="prev" title="SQLAlchemy 2.0 - Major Migration Guide" href="migration_20.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.31</span>


        | Release Date: June 18, 2024

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="Changes and Migration">Changes and Migration</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="migration_20.html">SQLAlchemy 2.0 - Major Migration Guide</a></span></li>
<li class="selected"><span class="link-container"><strong>What’s New in SQLAlchemy 2.0?</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#new-typing-support-in-core-and-orm-stubs-extensions-no-longer-used">New Typing Support in Core and ORM - Stubs / Extensions no longer used</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sql-expression-statement-result-set-typing">SQL Expression / Statement / Result Set Typing</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#rationale-and-overview">Rationale and Overview</a></span></li>
<li><span class="link-container"><a class="reference external" href="#sql-expression-typing-examples">SQL Expression Typing - Examples</a></span></li>
<li><span class="link-container"><a class="reference external" href="#the-catch-all-stubs-must-be-uninstalled">the catch - all stubs must be uninstalled</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-models">ORM Declarative Models</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#overview">Overview</a></span></li>
<li><span class="link-container"><a class="reference external" href="#migrating-an-existing-mapping">Migrating an Existing Mapping</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#step-one-orm-declarative-base-is-superseded-by-orm-declarativebase">Step one - <code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code> is superseded by <code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code>.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#step-two-replace-declarative-use-of-schema-column-with-orm-mapped-column">Step two - replace Declarative use of <code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code> with <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#step-three-apply-exact-python-types-as-needed-using-orm-mapped">Step three - apply exact Python types as needed using <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code>.</a></span></li>
<li><span class="link-container"><a class="reference external" href="#step-four-remove-orm-mapped-column-directives-where-no-longer-needed">Step four - remove <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code> directives where no longer needed</a></span></li>
<li><span class="link-container"><a class="reference external" href="#step-five-make-use-of-pep-593-annotated-to-package-common-directives-into-types">Step five - make use of pep-593 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> to package common directives into types</a></span></li>
<li><span class="link-container"><a class="reference external" href="#optional-step-turn-mapped-classes-into-dataclasses">Optional step - turn mapped classes into dataclasses</a></span></li>
<li><span class="link-container"><a class="reference external" href="#typing-is-supported-from-step-3-onwards">Typing is supported from step 3 onwards</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#using-legacy-mypy-typed-models">Using Legacy Mypy-Typed Models</a></span></li>
<li><span class="link-container"><a class="reference external" href="#native-support-for-dataclasses-mapped-as-orm-models">Native Support for Dataclasses Mapped as ORM Models</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#optimized-orm-bulk-insert-now-implemented-for-all-backends-other-than-mysql">Optimized ORM bulk insert now implemented for all backends other than MySQL</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#benchmarks">Benchmarks</a></span></li>
<li><span class="link-container"><a class="reference external" href="#summary-of-changes">Summary of Changes</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-enabled-insert-upsert-update-and-delete-statements-with-orm-returning">ORM-enabled Insert, Upsert, Update and Delete Statements, with ORM RETURNING</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#bulk-insert-with-returning">Bulk Insert with RETURNING</a></span></li>
<li><span class="link-container"><a class="reference external" href="#bulk-update">Bulk UPDATE</a></span></li>
<li><span class="link-container"><a class="reference external" href="#insert-upsert-values-returning">INSERT / upsert … VALUES … RETURNING</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-update-delete-with-where-returning">ORM UPDATE / DELETE with WHERE … RETURNING</a></span></li>
<li><span class="link-container"><a class="reference external" href="#improved-synchronize-session-behavior-for-orm-update-delete">Improved <code class="docutils literal notranslate"><span class="pre">synchronize_session</span></code> behavior for ORM UPDATE / DELETE</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id3">Summary of Changes</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#new-write-only-relationship-strategy-supersedes-dynamic">New “Write Only” relationship strategy supersedes “dynamic”</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#new-pep-484-type-annotated-mapping-support-for-dynamic-relationships">New pep-484 / type annotated mapping support for Dynamic Relationships</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#installation-is-now-fully-pep-517-enabled">Installation is now fully pep-517 enabled</a></span></li>
<li><span class="link-container"><a class="reference external" href="#c-extensions-now-ported-to-cython">C Extensions now ported to Cython</a></span></li>
<li><span class="link-container"><a class="reference external" href="#major-architectural-performance-and-api-enhancements-for-database-reflection">Major Architectural, Performance and API Enhancements for Database Reflection</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#performance-overview">Performance Overview</a></span></li>
<li><span class="link-container"><a class="reference external" href="#behavioral-changes-for-inspector">Behavioral Changes for <code class="docutils literal notranslate"><span class="pre">Inspector()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-methods-and-improvements-for-inspector">New Methods and Improvements for <code class="docutils literal notranslate"><span class="pre">Inspector()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dialect-support-for-psycopg-3-a-k-a-psycopg">Dialect support for psycopg 3 (a.k.a. “psycopg”)</a></span></li>
<li><span class="link-container"><a class="reference external" href="#dialect-support-for-oracledb">Dialect support for oracledb</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-conditional-ddl-for-constraints-and-indexes">New Conditional DDL for Constraints and Indexes</a></span></li>
<li><span class="link-container"><a class="reference external" href="#date-time-datetime-datatypes-now-support-literal-rendering-on-all-backends">DATE, TIME, DATETIME datatypes now support literal rendering on all backends</a></span></li>
<li><span class="link-container"><a class="reference external" href="#context-manager-support-for-result-asyncresult">Context Manager Support for <code class="docutils literal notranslate"><span class="pre">Result</span></code>, <code class="docutils literal notranslate"><span class="pre">AsyncResult</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#behavioral-changes">Behavioral Changes</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#new-transaction-join-modes-for-session">New transaction join modes for <code class="docutils literal notranslate"><span class="pre">Session</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#str-engine-url-will-obfuscate-the-password-by-default"><code class="docutils literal notranslate"><span class="pre">str(engine.url)</span></code> will obfuscate the password by default</a></span></li>
<li><span class="link-container"><a class="reference external" href="#stricter-rules-for-replacement-of-columns-in-table-objects-with-same-names-keys">Stricter rules for replacement of Columns in Table objects with same-names, keys</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-applies-column-orders-differently-control-behavior-using-sort-order">ORM Declarative Applies Column Orders Differently; Control behavior using <code class="docutils literal notranslate"><span class="pre">sort_order</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#the-sequence-construct-reverts-to-not-having-any-explicit-default-start-value-impacts-ms-sql-server">The <code class="docutils literal notranslate"><span class="pre">Sequence</span></code> construct reverts to not having any explicit default “start” value; impacts MS SQL Server</a></span></li>
<li><span class="link-container"><a class="reference external" href="#with-variant-clones-the-original-typeengine-rather-than-changing-the-type">“with_variant()” clones the original TypeEngine rather than changing the type</a></span></li>
<li><span class="link-container"><a class="reference external" href="#python-division-operator-performs-true-division-for-all-backends-added-floor-division">Python division operator performs true division for all backends; added floor division</a></span></li>
<li><span class="link-container"><a class="reference external" href="#session-raises-proactively-when-illegal-concurrent-or-reentrant-access-is-detected">Session raises proactively when illegal concurrent or reentrant access is detected</a></span></li>
<li><span class="link-container"><a class="reference external" href="#the-sqlite-dialect-uses-queuepool-for-file-based-databases">The SQLite dialect uses QueuePool for file-based databases</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-oracle-float-type-with-binary-precision-decimal-precision-not-accepted-directly">New Oracle FLOAT type with binary precision; decimal precision not accepted directly</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-range-multirange-support-and-changes-for-postgresql-backends">New RANGE / MULTIRANGE support and changes for PostgreSQL backends</a></span></li>
<li><span class="link-container"><a class="reference external" href="#match-operator-on-postgresql-uses-plainto-tsquery-rather-than-to-tsquery"><code class="docutils literal notranslate"><span class="pre">match()</span></code> operator on PostgreSQL uses <code class="docutils literal notranslate"><span class="pre">plainto_tsquery()</span></code> rather than <code class="docutils literal notranslate"><span class="pre">to_tsquery()</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="changelog_20.html">2.0 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_14.html">1.4 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_13.html">1.3 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_12.html">1.2 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_11.html">1.1 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_10.html">1.0 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_09.html">0.9 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_08.html">0.8 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_07.html">0.7 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_06.html">0.6 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_05.html">0.5 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_04.html">0.4 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_03.html">0.3 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_02.html">0.2 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_01.html">0.1 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_14.html">What’s New in SQLAlchemy 1.4?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_13.html">What’s New in SQLAlchemy 1.3?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_12.html">What’s New in SQLAlchemy 1.2?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_11.html">What’s New in SQLAlchemy 1.1?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_10.html">What’s New in SQLAlchemy 1.0?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_09.html">What’s New in SQLAlchemy 0.9?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_08.html">What’s New in SQLAlchemy 0.8?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_07.html">What’s New in SQLAlchemy 0.7?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_06.html">What’s New in SQLAlchemy 0.6?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_05.html">What’s new in SQLAlchemy 0.5?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_04.html">What’s new in SQLAlchemy 0.4?</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="migration_20.html" title="previous chapter">SQLAlchemy 2.0 - Major Migration Guide</a></li>
                <li><b>Next:</b>
                <a href="changelog_20.html" title="next chapter">2.0 Changelog</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="Changes and Migration">Changes and Migration</a></li>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#what-s-new-in-sqlalchemy-2-0">What’s New in SQLAlchemy 2.0?</a><ul>
<li><a class="reference internal" href="#new-typing-support-in-core-and-orm-stubs-extensions-no-longer-used">New Typing Support in Core and ORM - Stubs / Extensions no longer used</a><ul>
<li><a class="reference internal" href="#sql-expression-statement-result-set-typing">SQL Expression / Statement / Result Set Typing</a><ul>
<li><a class="reference internal" href="#rationale-and-overview">Rationale and Overview</a></li>
<li><a class="reference internal" href="#sql-expression-typing-examples">SQL Expression Typing - Examples</a></li>
<li><a class="reference internal" href="#the-catch-all-stubs-must-be-uninstalled">the catch - all stubs must be uninstalled</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-declarative-models">ORM Declarative Models</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#migrating-an-existing-mapping">Migrating an Existing Mapping</a><ul>
<li><a class="reference internal" href="#step-one-orm-declarative-base-is-superseded-by-orm-declarativebase">Step one - <code class="xref py py-func docutils literal notranslate"><span class="pre">_orm.declarative_base()</span></code> is superseded by <code class="xref py py-class docutils literal notranslate"><span class="pre">_orm.DeclarativeBase</span></code>.</a></li>
<li><a class="reference internal" href="#step-two-replace-declarative-use-of-schema-column-with-orm-mapped-column">Step two - replace Declarative use of <code class="xref py py-class docutils literal notranslate"><span class="pre">_schema.Column</span></code> with <code class="xref py py-func docutils literal notranslate"><span class="pre">_orm.mapped_column()</span></code></a></li>
<li><a class="reference internal" href="#step-three-apply-exact-python-types-as-needed-using-orm-mapped">Step three - apply exact Python types as needed using <code class="xref py py-class docutils literal notranslate"><span class="pre">_orm.Mapped</span></code>.</a></li>
<li><a class="reference internal" href="#step-four-remove-orm-mapped-column-directives-where-no-longer-needed">Step four - remove <code class="xref py py-func docutils literal notranslate"><span class="pre">_orm.mapped_column()</span></code> directives where no longer needed</a></li>
<li><a class="reference internal" href="#step-five-make-use-of-pep-593-annotated-to-package-common-directives-into-types">Step five - make use of pep-593 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> to package common directives into types</a></li>
<li><a class="reference internal" href="#optional-step-turn-mapped-classes-into-dataclasses">Optional step - turn mapped classes into dataclasses</a></li>
<li><a class="reference internal" href="#typing-is-supported-from-step-3-onwards">Typing is supported from step 3 onwards</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#using-legacy-mypy-typed-models">Using Legacy Mypy-Typed Models</a></li>
<li><a class="reference internal" href="#native-support-for-dataclasses-mapped-as-orm-models">Native Support for Dataclasses Mapped as ORM Models</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optimized-orm-bulk-insert-now-implemented-for-all-backends-other-than-mysql">Optimized ORM bulk insert now implemented for all backends other than MySQL</a><ul>
<li><a class="reference internal" href="#benchmarks">Benchmarks</a></li>
<li><a class="reference internal" href="#summary-of-changes">Summary of Changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-enabled-insert-upsert-update-and-delete-statements-with-orm-returning">ORM-enabled Insert, Upsert, Update and Delete Statements, with ORM RETURNING</a><ul>
<li><a class="reference internal" href="#bulk-insert-with-returning">Bulk Insert with RETURNING</a></li>
<li><a class="reference internal" href="#bulk-update">Bulk UPDATE</a></li>
<li><a class="reference internal" href="#insert-upsert-values-returning">INSERT / upsert … VALUES … RETURNING</a></li>
<li><a class="reference internal" href="#orm-update-delete-with-where-returning">ORM UPDATE / DELETE with WHERE … RETURNING</a></li>
<li><a class="reference internal" href="#improved-synchronize-session-behavior-for-orm-update-delete">Improved <code class="docutils literal notranslate"><span class="pre">synchronize_session</span></code> behavior for ORM UPDATE / DELETE</a></li>
<li><a class="reference internal" href="#id3">Summary of Changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#new-write-only-relationship-strategy-supersedes-dynamic">New “Write Only” relationship strategy supersedes “dynamic”</a><ul>
<li><a class="reference internal" href="#new-pep-484-type-annotated-mapping-support-for-dynamic-relationships">New pep-484 / type annotated mapping support for Dynamic Relationships</a></li>
</ul>
</li>
<li><a class="reference internal" href="#installation-is-now-fully-pep-517-enabled">Installation is now fully pep-517 enabled</a></li>
<li><a class="reference internal" href="#c-extensions-now-ported-to-cython">C Extensions now ported to Cython</a></li>
<li><a class="reference internal" href="#major-architectural-performance-and-api-enhancements-for-database-reflection">Major Architectural, Performance and API Enhancements for Database Reflection</a><ul>
<li><a class="reference internal" href="#performance-overview">Performance Overview</a></li>
<li><a class="reference internal" href="#behavioral-changes-for-inspector">Behavioral Changes for <code class="docutils literal notranslate"><span class="pre">Inspector()</span></code></a></li>
<li><a class="reference internal" href="#new-methods-and-improvements-for-inspector">New Methods and Improvements for <code class="docutils literal notranslate"><span class="pre">Inspector()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-support-for-psycopg-3-a-k-a-psycopg">Dialect support for psycopg 3 (a.k.a. “psycopg”)</a></li>
<li><a class="reference internal" href="#dialect-support-for-oracledb">Dialect support for oracledb</a></li>
<li><a class="reference internal" href="#new-conditional-ddl-for-constraints-and-indexes">New Conditional DDL for Constraints and Indexes</a></li>
<li><a class="reference internal" href="#date-time-datetime-datatypes-now-support-literal-rendering-on-all-backends">DATE, TIME, DATETIME datatypes now support literal rendering on all backends</a></li>
<li><a class="reference internal" href="#context-manager-support-for-result-asyncresult">Context Manager Support for <code class="docutils literal notranslate"><span class="pre">Result</span></code>, <code class="docutils literal notranslate"><span class="pre">AsyncResult</span></code></a></li>
<li><a class="reference internal" href="#behavioral-changes">Behavioral Changes</a><ul>
<li><a class="reference internal" href="#new-transaction-join-modes-for-session">New transaction join modes for <code class="docutils literal notranslate"><span class="pre">Session</span></code></a></li>
<li><a class="reference internal" href="#str-engine-url-will-obfuscate-the-password-by-default"><code class="docutils literal notranslate"><span class="pre">str(engine.url)</span></code> will obfuscate the password by default</a></li>
<li><a class="reference internal" href="#stricter-rules-for-replacement-of-columns-in-table-objects-with-same-names-keys">Stricter rules for replacement of Columns in Table objects with same-names, keys</a></li>
<li><a class="reference internal" href="#orm-declarative-applies-column-orders-differently-control-behavior-using-sort-order">ORM Declarative Applies Column Orders Differently; Control behavior using <code class="docutils literal notranslate"><span class="pre">sort_order</span></code></a></li>
<li><a class="reference internal" href="#the-sequence-construct-reverts-to-not-having-any-explicit-default-start-value-impacts-ms-sql-server">The <code class="docutils literal notranslate"><span class="pre">Sequence</span></code> construct reverts to not having any explicit default “start” value; impacts MS SQL Server</a></li>
<li><a class="reference internal" href="#with-variant-clones-the-original-typeengine-rather-than-changing-the-type">“with_variant()” clones the original TypeEngine rather than changing the type</a></li>
<li><a class="reference internal" href="#python-division-operator-performs-true-division-for-all-backends-added-floor-division">Python division operator performs true division for all backends; added floor division</a></li>
<li><a class="reference internal" href="#session-raises-proactively-when-illegal-concurrent-or-reentrant-access-is-detected">Session raises proactively when illegal concurrent or reentrant access is detected</a></li>
<li><a class="reference internal" href="#the-sqlite-dialect-uses-queuepool-for-file-based-databases">The SQLite dialect uses QueuePool for file-based databases</a></li>
<li><a class="reference internal" href="#new-oracle-float-type-with-binary-precision-decimal-precision-not-accepted-directly">New Oracle FLOAT type with binary precision; decimal precision not accepted directly</a></li>
<li><a class="reference internal" href="#new-range-multirange-support-and-changes-for-postgresql-backends">New RANGE / MULTIRANGE support and changes for PostgreSQL backends</a></li>
<li><a class="reference internal" href="#match-operator-on-postgresql-uses-plainto-tsquery-rather-than-to-tsquery"><code class="docutils literal notranslate"><span class="pre">match()</span></code> operator on PostgreSQL uses <code class="docutils literal notranslate"><span class="pre">plainto_tsquery()</span></code> rather than <code class="docutils literal notranslate"><span class="pre">to_tsquery()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar changelog-whatsnew_20" >
        
<section id="what-s-new-in-sqlalchemy-2-0">
<span id="whatsnew-20-toplevel"></span><h1>What’s New in SQLAlchemy 2.0?<a class="headerlink" href="#what-s-new-in-sqlalchemy-2-0" title="Link to this heading">¶</a></h1>
<div class="admonition-note-for-readers admonition">
<p class="admonition-title">Note for Readers</p>
<p>SQLAlchemy 2.0’s transition documents are separated into <strong>two</strong>
documents - one which details major API shifts from the 1.x to 2.x
series, and the other which details new features and behaviors relative
to SQLAlchemy 1.4:</p>
<ul class="simple">
<li><p><a class="reference internal" href="migration_20.html"><span class="std std-ref">SQLAlchemy 2.0 - Major Migration Guide</span></a> - 1.x to 2.x API shifts</p></li>
<li><p><a class="reference internal" href="#"><span class="std std-ref">What’s New in SQLAlchemy 2.0?</span></a> - this document, new features and behaviors for SQLAlchemy 2.0</p></li>
</ul>
<p>Readers who have not yet updated their 1.4 application to follow
SQLAlchemy 2.0 engine and ORM conventions may navigate to
<a class="reference internal" href="migration_20.html"><span class="std std-ref">SQLAlchemy 2.0 - Major Migration Guide</span></a> for a guide to ensuring SQLAlchemy 2.0
compatibility, which is a prerequisite for having working code under
version 2.0.</p>
</div>
<div class="admonition-about-this-document admonition">
<p class="admonition-title">About this Document</p>
<p>This document describes changes between SQLAlchemy version 1.4
and SQLAlchemy version 2.0, <strong>independent</strong> of the major changes between
<a class="reference internal" href="../glossary.html#term-1.x-style"><span class="xref std std-term">1.x style</span></a> and <a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a> usage.   Readers should start
with the <a class="reference internal" href="migration_20.html"><span class="std std-ref">SQLAlchemy 2.0 - Major Migration Guide</span></a> document to get an overall picture
of the major compatibility changes between the 1.x and 2.x series.</p>
<p>Aside from the major 1.x-&gt;2.x migration path, the next largest
paradigm shift in SQLAlchemy 2.0 is deep integration with <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a> typing
practices and current capabilities, particularly within the ORM. New
type-driven ORM declarative styles inspired by Python <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>, as well
as new integrations with dataclasses themselves, complement an overall
approach that no longer requires stubs and also goes very far towards
providing a type-aware method chain from SQL statement to result set.</p>
<p>The prominence of Python typing is significant not only so that type checkers
like <a class="reference external" href="https://mypy.readthedocs.io/en/stable/">mypy</a> can run without plugins; more significantly it allows IDEs
like <a class="reference external" href="https://code.visualstudio.com/">vscode</a> and <a class="reference external" href="https://www.jetbrains.com/pycharm/">pycharm</a> to take a much more active role in assisting
with the composition of a SQLAlchemy application.</p>
</div>
<section id="new-typing-support-in-core-and-orm-stubs-extensions-no-longer-used">
<h2>New Typing Support in Core and ORM - Stubs / Extensions no longer used<a class="headerlink" href="#new-typing-support-in-core-and-orm-stubs-extensions-no-longer-used" title="Link to this heading">¶</a></h2>
<p>The approach to typing for Core and ORM has been completely reworked, compared
to the interim approach that was provided in version 1.4 via the
<a class="reference external" href="https://github.com/sqlalchemy/sqlalchemy2-stubs">sqlalchemy2-stubs</a> package.   The new approach begins at the most fundamental
element in SQLAlchemy which is the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>, or more
accurately the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code></a> that underlies all SQL
expressions that have a type.   This expression-level typing then extends into the area of
statement construction, statement execution, and result sets, and finally into the ORM
where new <a class="reference internal" href="../orm/declarative_config.html"><span class="std std-ref">declarative</span></a> forms allow
for fully typed ORM models that integrate all the way from statement to
result set.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Typing support should be considered <strong>beta level</strong> software
for the 2.0 series. Typing details are subject to change however
significant backwards-incompatible changes are not planned.</p>
</div>
<section id="sql-expression-statement-result-set-typing">
<h3>SQL Expression / Statement / Result Set Typing<a class="headerlink" href="#sql-expression-statement-result-set-typing" title="Link to this heading">¶</a></h3>
<p>This section provides background and examples for SQLAlchemy’s new
SQL expression typing approach, which extends from base <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code></a>
constructs through SQL statements and result sets and into realm of ORM mapping.</p>
<section id="rationale-and-overview">
<h4>Rationale and Overview<a class="headerlink" href="#rationale-and-overview" title="Link to this heading">¶</a></h4>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This section is an architectural discussion. Skip ahead to
<a class="reference internal" href="#whatsnew-20-expression-typing-examples"><span class="std std-ref">SQL Expression Typing - Examples</span></a> to just see what the new typing
looks like.</p>
</div>
<p>In <a class="reference external" href="https://github.com/sqlalchemy/sqlalchemy2-stubs">sqlalchemy2-stubs</a>, SQL expressions were typed as <a class="reference external" href="https://peps.python.org/pep-0484/#generics">generics</a> that then
referred to a <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> object such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a>,
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a>, or <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> as their generic argument
(such as <code class="docutils literal notranslate"><span class="pre">Column[Integer]</span></code>). This was itself a departure from what
the original Dropbox <a class="reference external" href="https://github.com/dropbox/sqlalchemy-stubs">sqlalchemy-stubs</a> package did, where
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> and its foundational constructs were directly generic on
Python types, such as <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime</span></code> and <code class="docutils literal notranslate"><span class="pre">str</span></code>.   It was hoped
that since <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a> / <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a> / <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> themselves
are generic against <code class="docutils literal notranslate"><span class="pre">int</span></code> / <code class="docutils literal notranslate"><span class="pre">datetime</span></code> / <code class="docutils literal notranslate"><span class="pre">str</span></code>, there would be ways
to maintain both levels of information and to be able to extract the Python
type from a column expression via the <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> as an intermediary
construct.  However, this is not the case, as <span class="target" id="index-1"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a>
doesn’t really have a rich enough feature set for this to be viable,
lacking capabilities such as
<a class="reference external" href="https://github.com/python/typing/issues/548">higher kinded TypeVars</a>.</p>
<p>So after a <a class="reference external" href="https://github.com/python/typing/discussions/999">deep assessment</a>
of the current capabilities of <span class="target" id="index-2"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a>, SQLAlchemy 2.0 has realized the
original wisdom of <a class="reference external" href="https://github.com/dropbox/sqlalchemy-stubs">sqlalchemy-stubs</a> in this area and returned to linking
column expressions directly to Python types.  This does mean that if one
has SQL expressions to different subtypes, like <code class="docutils literal notranslate"><span class="pre">Column(VARCHAR)</span></code> vs.
<code class="docutils literal notranslate"><span class="pre">Column(Unicode)</span></code>, the specifics of those two <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> subtypes
is not carried along as the type only carries along <code class="docutils literal notranslate"><span class="pre">str</span></code>,
but in practice this is usually not an issue and it is generally vastly more
useful that the Python type is immediately present, as it represents the
in-Python data one will be storing and receiving for this column directly.</p>
<p>Concretely, this means that an expression like <code class="docutils literal notranslate"><span class="pre">Column('id',</span> <span class="pre">Integer)</span></code>
is typed as <code class="docutils literal notranslate"><span class="pre">Column[int]</span></code>.    This allows for a viable pipeline of
SQLAlchemy construct -&gt; Python datatype to be set up, without the need for
typing plugins.  Crucially, it allows full interoperability with
the ORM’s paradigm of using <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> and <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a>
constructs that reference ORM mapped class types (e.g. a <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a>
containing instances of user-mapped instances, such as the <code class="docutils literal notranslate"><span class="pre">User</span></code> and
<code class="docutils literal notranslate"><span class="pre">Address</span></code> examples used in our tutorials).   While Python typing currently has very limited
support for customization of tuple-types (where <span class="target" id="index-3"></span><a class="pep reference external" href="https://peps.python.org/pep-0646/"><strong>PEP 646</strong></a>, the first pep that
attempts to deal with tuple-like objects, was <a class="reference external" href="https://mail.python.org/archives/list/typing-sig&#64;python.org/message/G2PNHRR32JMFD3JR7ACA2NDKWTDSEPUG/">intentionally limited
in its functionality</a>
and by itself is not yet viable for arbitrary tuple
manipulation),
a fairly decent approach has been devised that allows for basic
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> -&gt; <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> -&gt; <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> typing
to function, including for ORM classes, where at the point at which a
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> object is to be unpacked into individual column entries,
a small typing-oriented accessor is added that allows the individual Python
values to maintain the Python type linked to the SQL expression from which
they originated (translation: it works).</p>
</section>
<section id="sql-expression-typing-examples">
<span id="whatsnew-20-expression-typing-examples"></span><h4>SQL Expression Typing - Examples<a class="headerlink" href="#sql-expression-typing-examples" title="Link to this heading">¶</a></h4>
<p>A brief tour of typing behaviors.  Comments
indicate what one would see hovering over the code in <a class="reference external" href="https://code.visualstudio.com/">vscode</a> (or roughly
what typing tools would display when using the <a class="reference external" href="https://mypy.readthedocs.io/en/latest/common_issues.html?highlight=reveal_type#reveal-type">reveal_type()</a>
helper):</p>
<ul>
<li><p>Simple Python Types Assigned to SQL Expressions</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (variable) str_col: ColumnClause[str]</span>
<span class="n">str_col</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">)</span>

<span class="c1"># (variable) int_col: ColumnClause[int]</span>
<span class="n">int_col</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>

<span class="c1"># (variable) expr1: ColumnElement[str]</span>
<span class="n">expr1</span> <span class="o">=</span> <span class="n">str_col</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span>

<span class="c1"># (variable) expr2: ColumnElement[int]</span>
<span class="n">expr2</span> <span class="o">=</span> <span class="n">int_col</span> <span class="o">+</span> <span class="mi">10</span>

<span class="c1"># (variable) expr3: ColumnElement[bool]</span>
<span class="n">expr3</span> <span class="o">=</span> <span class="n">int_col</span> <span class="o">==</span> <span class="mi">15</span></pre></div>
</div>
</li>
<li><p>Individual SQL expressions assigned to <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> constructs, as well as any
row-returning construct, including row-returning DML
such as <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> with <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a>, are packed
into a <code class="docutils literal notranslate"><span class="pre">Tuple[]</span></code> type which retains the Python type for each element.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (variable) stmt: Select[Tuple[str, int]]</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">str_col</span><span class="p">,</span> <span class="n">int_col</span><span class="p">)</span>

<span class="c1"># (variable) stmt: ReturningInsert[Tuple[str, int]]</span>
<span class="n">ins_stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">str_col</span><span class="p">,</span> <span class="n">int_col</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Tuple[]</span></code> type from any row returning construct, when invoked with an
<code class="docutils literal notranslate"><span class="pre">.execute()</span></code> method, carries through to <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a>
and <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a>.  In order to unpack the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a>
object as a tuple, the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row.tuple" title="sqlalchemy.engine.Row.tuple"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Row.tuple()</span></code></a> or <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row.t" title="sqlalchemy.engine.Row.t"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Row.t</span></code></a>
accessor essentially casts the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> into the corresponding
<code class="docutils literal notranslate"><span class="pre">Tuple[]</span></code> (though remains the same <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> object at runtime).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="c1"># (variable) stmt: Select[Tuple[str, int]]</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">str_col</span><span class="p">,</span> <span class="n">int_col</span><span class="p">)</span>

    <span class="c1"># (variable) result: Result[Tuple[str, int]]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

    <span class="c1"># (variable) row: Row[Tuple[str, int]] | None</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># for typed tuple unpacking or indexed access,</span>
        <span class="c1"># use row.tuple() or row.t  (this is the small typing-oriented accessor)</span>
        <span class="n">strval</span><span class="p">,</span> <span class="n">intval</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">t</span>

        <span class="c1"># (variable) strval: str</span>
        <span class="n">strval</span>

        <span class="c1"># (variable) intval: int</span>
        <span class="n">intval</span></pre></div>
</div>
</li>
<li><p>Scalar values for single-column statements do the right thing with
methods like <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.scalar" title="sqlalchemy.engine.Connection.scalar"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.scalar()</span></code></a>, <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.scalars" title="sqlalchemy.engine.Result.scalars"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.scalars()</span></code></a>,
etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (variable) data: Sequence[str]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">str_col</span><span class="p">))</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</li>
<li><p>The above support for row-returning constructs works the best with
ORM mapped classes, as a mapped class can list out specific types
for its members.  The example below sets up a class using
<a class="reference internal" href="#whatsnew-20-orm-declarative-typing"><span class="std std-ref">new type-aware syntaxes</span></a>,
described in the following section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Address&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>With the above mapping, the attributes are typed and express themselves
all the way from statement to result set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="c1"># (variable) stmt: Select[Tuple[int, str]]</span>
    <span class="n">stmt_1</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># (variable) result_1: Result[Tuple[int, str]]</span>
    <span class="n">result_1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt_1</span><span class="p">)</span>

    <span class="c1"># (variable) intval: int</span>
    <span class="c1"># (variable) strval: str</span>
    <span class="n">intval</span><span class="p">,</span> <span class="n">strval</span> <span class="o">=</span> <span class="n">result_1</span><span class="o">.</span><span class="n">one</span><span class="p">()</span><span class="o">.</span><span class="n">t</span></pre></div>
</div>
<p>Mapped classes themselves are also types, and behave the same way, such
as a SELECT against two mapped classes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="c1"># (variable) stmt: Select[Tuple[User, Address]]</span>
    <span class="n">stmt_2</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span>

    <span class="c1"># (variable) result_2: Result[Tuple[User, Address]]</span>
    <span class="n">result_2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt_2</span><span class="p">)</span>

    <span class="c1"># (variable) user_obj: User</span>
    <span class="c1"># (variable) address_obj: Address</span>
    <span class="n">user_obj</span><span class="p">,</span> <span class="n">address_obj</span> <span class="o">=</span> <span class="n">result_2</span><span class="o">.</span><span class="n">one</span><span class="p">()</span><span class="o">.</span><span class="n">t</span></pre></div>
</div>
<p>When selecting mapped classes, constructs like <a class="reference internal" href="../orm/queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-class docutils literal notranslate"><span class="pre">aliased</span></code></a> work
as well, maintaining the column-level attributes of the original mapped
class as well as the return type expected from a statement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="c1"># this is in fact an Annotated type, but typing tools don&#39;t</span>
    <span class="c1"># generally display this</span>

    <span class="c1"># (variable) u1: Type[User]</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>

    <span class="c1"># (variable) stmt: Select[Tuple[User, User, str]]</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># (variable) result: Result[Tuple[User, User, str]]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p>Core Table does not yet have a decent way to maintain typing of
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects when accessing them via the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.c" title="sqlalchemy.schema.Table.c"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.c</span></code></a> accessor.</p>
<p>Since <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> is set up as an instance of a class, and the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.c" title="sqlalchemy.schema.Table.c"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.c</span></code></a> accessor typically accesses <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects
dynamically by name, there’s not yet an established typing approach for this; some
alternative syntax would be needed.</p>
</li>
<li><p>ORM classes, scalars, etc. work great.</p>
<p>The typical use case of selecting ORM classes, as scalars or tuples,
all works, both 2.0 and 1.x style queries, getting back the exact type
either by itself or contained within the appropriate container such
as <code class="docutils literal notranslate"><span class="pre">Sequence[]</span></code>, <code class="docutils literal notranslate"><span class="pre">List[]</span></code> or <code class="docutils literal notranslate"><span class="pre">Iterator[]</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (variable) users1: Sequence[User]</span>
<span class="n">users1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># (variable) user: User</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

<span class="c1"># (variable) user_iter: Iterator[User]</span>
<span class="n">user_iter</span> <span class="o">=</span> <span class="n">iter</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)))</span></pre></div>
</div>
</li>
<li><p>Legacy <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> gains tuple typing as well.</p>
<p>The typing support for <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> goes well beyond what
<a class="reference external" href="https://github.com/dropbox/sqlalchemy-stubs">sqlalchemy-stubs</a> or <a class="reference external" href="https://github.com/sqlalchemy/sqlalchemy2-stubs">sqlalchemy2-stubs</a> offered, where both scalar-object
as well as tuple-typed <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> objects will retain result level
typing for most cases:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (variable) q1: RowReturningQuery[Tuple[int, str]]</span>
<span class="n">q1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># (variable) rows: List[Row[Tuple[int, str]]]</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">q1</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># (variable) q2: Query[User]</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>

<span class="c1"># (variable) users: List[User]</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">q2</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</li>
</ul>
</section>
<section id="the-catch-all-stubs-must-be-uninstalled">
<h4>the catch - all stubs must be uninstalled<a class="headerlink" href="#the-catch-all-stubs-must-be-uninstalled" title="Link to this heading">¶</a></h4>
<p>A key caveat with the typing support is that <strong>all SQLAlchemy stubs packages
must be uninstalled</strong> for typing to work.   When running <a class="reference external" href="https://mypy.readthedocs.io/en/stable/">mypy</a> against a
Python virtualenv, this is only a matter of uninstalling those packages.
However, a SQLAlchemy stubs package is also currently part of <a class="reference external" href="https://github.com/python/typeshed">typeshed</a>, which
itself is bundled into some typing tools such as <a class="reference external" href="https://github.com/microsoft/pylance-release">Pylance</a>, so it may be
necessary in some cases to locate the files for these packages and delete them,
if they are in fact interfering with the new typing working correctly.</p>
<p>Once SQLAlchemy 2.0 is released in final status, typeshed will remove
SQLAlchemy from its own stubs source.</p>
</section>
</section>
<section id="orm-declarative-models">
<span id="whatsnew-20-orm-declarative-typing"></span><h3>ORM Declarative Models<a class="headerlink" href="#orm-declarative-models" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy 1.4 introduced the first SQLAlchemy-native ORM typing support
using a combination of <a class="reference external" href="https://github.com/sqlalchemy/sqlalchemy2-stubs">sqlalchemy2-stubs</a> and the <a class="reference internal" href="../orm/extensions/mypy.html"><span class="std std-ref">Mypy Plugin</span></a>.
In SQLAlchemy 2.0, the Mypy plugin <strong>remains available, and has been updated
to work with SQLAlchemy 2.0’s typing system</strong>.  However, it should now be
considered <strong>deprecated</strong>, as applications now have a straightforward path to adopting the
new typing support that does not use plugins or stubs.</p>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h4>
<p>The fundamental approach for the new system is that mapped column declarations,
when using a fully <a class="reference internal" href="../orm/declarative_tables.html#orm-declarative-table"><span class="std std-ref">Declarative</span></a> model (that is,
not <a class="reference internal" href="../orm/declarative_tables.html#orm-imperative-table-configuration"><span class="std std-ref">hybrid declarative</span></a> or
<a class="reference internal" href="../orm/mapping_styles.html#orm-imperative-mapping"><span class="std std-ref">imperative</span></a> configurations, which are unchanged),
are first derived at runtime by inspecting the type annotation on the left side
of each attribute declaration, if present.  Left hand type annotations are
expected to be contained within the
<a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> generic type, otherwise the attribute is not considered
to be a mapped attribute.  The attribute declaration may then refer to
the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct on the right hand side, which is used
to provide additional Core-level schema information about the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> to be produced and mapped. This right hand side
declaration is optional if a <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> annotation is present on the
left side; if no annotation is present on the left side, then the
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> may be used as an exact replacement for the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> directive where it will provide for more accurate (but
not exact) typing behavior of the attribute, even though no annotation is
present.</p>
<p>The approach is inspired by the approach of Python <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a> which starts
with an annotation on the left, then allows for an optional
<code class="docutils literal notranslate"><span class="pre">dataclasses.field()</span></code> specification on the right; the key difference from the
dataclasses approach is that SQLAlchemy’s approach is strictly <strong>opt-in</strong>,
where existing mappings that use <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> without any type
annotations continue to work as they always have, and the
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct may be used as a direct replacement for
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> without any explicit type annotations. Only for exact
attribute-level Python types to be present is the use of explicit annotations
with <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> required. These annotations may be used on an
as-needed, per-attribute basis for those attributes where specific types are
helpful; non-annotated attributes that use <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> will be
typed as <code class="docutils literal notranslate"><span class="pre">Any</span></code> at the instance level.</p>
</section>
<section id="migrating-an-existing-mapping">
<span id="whatsnew-20-orm-typing-migration"></span><h4>Migrating an Existing Mapping<a class="headerlink" href="#migrating-an-existing-mapping" title="Link to this heading">¶</a></h4>
<p>Transitioning to the new ORM approach begins as more verbose, but becomes more
succinct than was previously possible as the available new features are used
fully. The following steps detail a typical transition and then continue
on to illustrate some more options.</p>
<section id="step-one-orm-declarative-base-is-superseded-by-orm-declarativebase">
<h5>Step one - <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a> is superseded by <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a>.<a class="headerlink" href="#step-one-orm-declarative-base-is-superseded-by-orm-declarativebase" title="Link to this heading">¶</a></h5>
<p>One observed limitation in Python typing is that there seems to be
no ability to have a class dynamically generated from a function which then
is understood by typing tools as a base for new classes.  To solve this problem
without plugins, the usual call to <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a> can be replaced
with using the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a> class, which produces the same
<code class="docutils literal notranslate"><span class="pre">Base</span></code> object as usual, except that typing tools understand it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</section>
<section id="step-two-replace-declarative-use-of-schema-column-with-orm-mapped-column">
<h5>Step two - replace Declarative use of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> with <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a><a class="headerlink" href="#step-two-replace-declarative-use-of-schema-column-with-orm-mapped-column" title="Link to this heading">¶</a></h5>
<p>The <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> is an ORM-typing aware construct that can
be swapped directly for the use of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>.  Given a
1.x style mapping as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>We replace <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> with <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>; no
arguments need to change:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The individual columns above are <strong>not yet typed with Python types</strong>,
and are instead typed as <code class="docutils literal notranslate"><span class="pre">Mapped[Any]</span></code>; this is because we can declare any
column either with <code class="docutils literal notranslate"><span class="pre">Optional</span></code> or not, and there’s no way to have a
“guess” in place that won’t cause typing errors when we type it
explicitly.</p>
<p>However, at this step, our above mapping has appropriate <a class="reference internal" href="../glossary.html#term-descriptor"><span class="xref std std-term">descriptor</span></a> types
set up for all attributes and may be used in queries as well as for
instance-level manipulation, all of which will <strong>pass mypy –strict mode</strong> with no
plugins.</p>
</section>
<section id="step-three-apply-exact-python-types-as-needed-using-orm-mapped">
<h5>Step three - apply exact Python types as needed using <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>.<a class="headerlink" href="#step-three-apply-exact-python-types-as-needed-using-orm-mapped" title="Link to this heading">¶</a></h5>
<p>This can be done for all attributes for which exact typing is desired;
attributes that are fine being left as <code class="docutils literal notranslate"><span class="pre">Any</span></code> may be skipped.   For
context we also illustrate <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> being used for a
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> where we apply an exact type.
The mapping within this interim step
will be more verbose, however with proficiency, this step can
be combined with subsequent steps to update mappings more directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Address&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>At this point, our ORM mapping is fully typed and will produce exact-typed
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>, <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> and <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a>
constructs.   We now can proceed to pare down redundancy in the mapping
declaration.</p>
</section>
<section id="step-four-remove-orm-mapped-column-directives-where-no-longer-needed">
<h5>Step four - remove <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> directives where no longer needed<a class="headerlink" href="#step-four-remove-orm-mapped-column-directives-where-no-longer-needed" title="Link to this heading">¶</a></h5>
<p>All <code class="docutils literal notranslate"><span class="pre">nullable</span></code> parameters can be implied using <code class="docutils literal notranslate"><span class="pre">Optional[]</span></code>; in
the absence of <code class="docutils literal notranslate"><span class="pre">Optional[]</span></code>, <code class="docutils literal notranslate"><span class="pre">nullable</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>. All SQL
types without arguments such as <code class="docutils literal notranslate"><span class="pre">Integer</span></code> and <code class="docutils literal notranslate"><span class="pre">String</span></code> can be expressed
as a Python annotation alone. A <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> directive with no
parameters can be removed entirely. <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> now derives its
class from the left hand annotation, supporting forward references as well
(as <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> has supported string-based forward references
for ten years already ;) ):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Address&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</section>
<section id="step-five-make-use-of-pep-593-annotated-to-package-common-directives-into-types">
<h5>Step five - make use of pep-593 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> to package common directives into types<a class="headerlink" href="#step-five-make-use-of-pep-593-annotated-to-package-common-directives-into-types" title="Link to this heading">¶</a></h5>
<p>This is a radical new
capability that presents an alternative, or complementary approach, to
<a class="reference internal" href="../orm/declarative_mixins.html"><span class="std std-ref">declarative mixins</span></a> as a means to provide type
oriented configuration, and also replaces the need for
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.declared_attr" title="sqlalchemy.orm.declared_attr"><code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code></a> decorated functions in most cases.</p>
<p>First, the Declarative mapping allows the mapping of Python type to
SQL type, such as <code class="docutils literal notranslate"><span class="pre">str</span></code> to <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a>, to be customized
using <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a>.   Using <span class="target" id="index-4"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a>
<code class="docutils literal notranslate"><span class="pre">Annotated</span></code> allows us to create variants of a particular Python type so that
the same type, such as <code class="docutils literal notranslate"><span class="pre">str</span></code>, may be used which each provide variants
of <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a>, as below where use of an <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> <code class="docutils literal notranslate"><span class="pre">str</span></code> called
<code class="docutils literal notranslate"><span class="pre">str50</span></code> will indicate <code class="docutils literal notranslate"><span class="pre">String(50)</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">str50</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>


<span class="c1"># declarative base with a type-level override, using a type that is</span>
<span class="c1"># expected to be used in multiple places</span>
<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">str50</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Second, Declarative will extract full
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> definitions from the left hand type if
<code class="docutils literal notranslate"><span class="pre">Annotated[]</span></code> is used, by passing a <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct
as any argument to the <code class="docutils literal notranslate"><span class="pre">Annotated[]</span></code> construct (credit to <a class="reference external" href="https://twitter.com/adriangb01/status/1532841383647657988">&#64;adriangb01</a>
for illustrating this idea).   This capability may be extended in future releases
to also include <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, <a class="reference internal" href="../orm/composites.html#sqlalchemy.orm.composite" title="sqlalchemy.orm.composite"><code class="xref py py-func docutils literal notranslate"><span class="pre">composite()</span></code></a> and other
constructs, but currently is limited to <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>.  The
example below adds additional <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> types in addition to our
<code class="docutils literal notranslate"><span class="pre">str50</span></code> example to illustrate this feature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="c1"># declarative base from previous example</span>
<span class="n">str50</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">str50</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="p">}</span>


<span class="c1"># set up mapped_column() overrides, using whole column styles that are</span>
<span class="c1"># expected to be used in multiple places</span>
<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">user_fk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))]</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str50</span><span class="p">]</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Address&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str50</span><span class="p">]</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">user_fk</span><span class="p">]</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Above, columns that are mapped with <code class="docutils literal notranslate"><span class="pre">Mapped[str50]</span></code>, <code class="docutils literal notranslate"><span class="pre">Mapped[intpk]</span></code>,
or <code class="docutils literal notranslate"><span class="pre">Mapped[user_fk]</span></code> draw from both the
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> as well as the
<code class="docutils literal notranslate"><span class="pre">Annotated</span></code> construct directly in order to re-use pre-established typing
and column configurations.</p>
</section>
<section id="optional-step-turn-mapped-classes-into-dataclasses">
<h5>Optional step - turn mapped classes into <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a><a class="headerlink" href="#optional-step-turn-mapped-classes-into-dataclasses" title="Link to this heading">¶</a></h5>
<p>We can turn mapped classes into <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>, where a key advantage
is that we can build a strictly-typed <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method with explicit
positional, keyword only, and default arguments, not to mention we get methods
such as <code class="docutils literal notranslate"><span class="pre">__str__()</span></code> and <code class="docutils literal notranslate"><span class="pre">__repr__()</span></code> for free. The next section
<a class="reference internal" href="#whatsnew-20-dataclasses"><span class="std std-ref">Native Support for Dataclasses Mapped as ORM Models</span></a> illustrates further transformation of the above
model.</p>
</section>
<section id="typing-is-supported-from-step-3-onwards">
<h5>Typing is supported from step 3 onwards<a class="headerlink" href="#typing-is-supported-from-step-3-onwards" title="Link to this heading">¶</a></h5>
<p>With the above examples, any example from “step 3” on forward will include
that the attributes
of the model are typed
and will populate through to <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>, <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>,
and <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (variable) stmt: Select[Tuple[int, str]]</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sess</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
        <span class="c1"># (variable) row: Row[Tuple[int, str]]</span>
        <span class="n">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># (variable) users: Sequence[User]</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c1"># (variable) users_legacy: List[User]</span>
    <span class="n">users_legacy</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/declarative_tables.html#orm-declarative-table"><span class="std std-ref">Declarative Table with mapped_column()</span></a> - Updated Declarative documentation for
Declarative generation and mapping of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> columns.</p>
</div>
</section>
</section>
</section>
<section id="using-legacy-mypy-typed-models">
<span id="whatsnew-20-mypy-legacy-models"></span><h3>Using Legacy Mypy-Typed Models<a class="headerlink" href="#using-legacy-mypy-typed-models" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy applications that use the <a class="reference internal" href="../orm/extensions/mypy.html"><span class="std std-ref">Mypy plugin</span></a> with
explicit annotations that don’t use <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> in their annotations
are subject to errors under the new system, as such annotations are flagged as
errors when using constructs such as <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>.</p>
<p>The section <a class="reference internal" href="migration_20.html#migration-20-step-six"><span class="std std-ref">Migration to 2.0 Step Six - Add __allow_unmapped__ to explicitly typed ORM models</span></a> illustrates how to temporarily
disable these errors from being raised for a legacy ORM model that uses
explicit annotations.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="migration_20.html#migration-20-step-six"><span class="std std-ref">Migration to 2.0 Step Six - Add __allow_unmapped__ to explicitly typed ORM models</span></a></p>
</div>
</section>
<section id="native-support-for-dataclasses-mapped-as-orm-models">
<span id="whatsnew-20-dataclasses"></span><h3>Native Support for Dataclasses Mapped as ORM Models<a class="headerlink" href="#native-support-for-dataclasses-mapped-as-orm-models" title="Link to this heading">¶</a></h3>
<p>The new ORM Declarative features introduced above at
<a class="reference internal" href="#whatsnew-20-orm-declarative-typing"><span class="std std-ref">ORM Declarative Models</span></a> introduced the
new <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct and illustrated type-centric
mapping with optional use of <span class="target" id="index-5"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a> <code class="docutils literal notranslate"><span class="pre">Annotated</span></code>.  We can take
the mapping one step further by integrating this with Python
<a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>.   This new feature is made possible via <span class="target" id="index-6"></span><a class="pep reference external" href="https://peps.python.org/pep-0681/"><strong>PEP 681</strong></a> which
allows for type checkers to recognize classes that are dataclass compatible,
or are fully dataclasses, but were declared through alternate APIs.</p>
<p>Using the dataclasses feature, mapped classes gain an <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method
that supports positional arguments as well as customizable default values
for optional keyword arguments.  As mentioned previously, dataclasses also
generate many useful methods such as <code class="docutils literal notranslate"><span class="pre">__str__()</span></code>, <code class="docutils literal notranslate"><span class="pre">__eq__()</span></code>.  Dataclass
serialization methods such as
<a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#dataclasses.asdict">dataclasses.asdict()</a> and
<a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#dataclasses.astuple">dataclasses.astuple()</a>
also work, but don’t currently accommodate for self-referential structures, which
makes them less viable for mappings that have bidirectional relationships.</p>
<p>SQLAlchemy’s current integration approach converts the user-defined class
into a <strong>real dataclass</strong> to provide runtime functionality; the feature
makes use of the existing dataclass feature introduced in SQLAlchemy 1.4 at
<a class="reference internal" href="migration_14.html#change-5027"><span class="std std-ref">Python Dataclasses, attrs Supported w/ Declarative, Imperative Mappings</span></a> to produce an equivalent runtime mapping with a fully integrated
configuration style, which is also more correctly typed than was possible
with the previous approach.</p>
<p>To support dataclasses in compliance with <span class="target" id="index-7"></span><a class="pep reference external" href="https://peps.python.org/pep-0681/"><strong>PEP 681</strong></a>, ORM constructs like
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> and <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> accept additional
<span class="target" id="index-8"></span><a class="pep reference external" href="https://peps.python.org/pep-0681/"><strong>PEP 681</strong></a> arguments <code class="docutils literal notranslate"><span class="pre">init</span></code>, <code class="docutils literal notranslate"><span class="pre">default</span></code>, and <code class="docutils literal notranslate"><span class="pre">default_factory</span></code> which
are passed along to the dataclass creation process.  These
arguments currently must be present in an explicit directive on the right side,
just as they would be used with <code class="docutils literal notranslate"><span class="pre">dataclasses.field()</span></code>; they currently
can’t be local to an <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> construct on the left side.   To support
the convenient use of <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> while still supporting dataclass
configuration, <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> can merge
a minimal set of right-hand arguments with that of an existing
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct located on the left side within an <code class="docutils literal notranslate"><span class="pre">Annotated</span></code>
construct, so that most of the succinctness is maintained, as will be seen
below.</p>
<p>To enable dataclasses using class inheritance we make
use of the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.MappedAsDataclass" title="sqlalchemy.orm.MappedAsDataclass"><code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code></a> mixin, either directly on each class, or
on the <code class="docutils literal notranslate"><span class="pre">Base</span></code> class, as illustrated below where we further modify the
example mapping from “Step 5” of <a class="reference internal" href="#whatsnew-20-orm-declarative-typing"><span class="std std-ref">ORM Declarative Models</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">,</span> <span class="n">DeclarativeBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;subclasses will be converted to dataclasses&quot;&quot;&quot;</span>


<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">str30</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">))]</span>
<span class="n">user_fk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))]</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str30</span><span class="p">]</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Address&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="n">list</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">user_fk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The above mapping has used the <code class="docutils literal notranslate"><span class="pre">&#64;dataclasses.dataclass</span></code> decorator directly
on each mapped class at the same time that the declarative mapping was
set up, internally setting up each <code class="docutils literal notranslate"><span class="pre">dataclasses.field()</span></code> directive as
indicated.   <code class="docutils literal notranslate"><span class="pre">User</span></code> / <code class="docutils literal notranslate"><span class="pre">Address</span></code> structures can be created using
positional arguments as configured:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s2">&quot;full name&quot;</span><span class="p">,</span> <span class="n">addresses</span><span class="o">=</span><span class="p">[</span><span class="n">Address</span><span class="p">(</span><span class="s2">&quot;email@address&quot;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span>
<span class="go">User(id=None, name=&#39;username&#39;, fullname=&#39;full name&#39;, addresses=[Address(id=None, email_address=&#39;email@address&#39;, user_id=None, user=...)])</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/dataclasses.html#orm-declarative-native-dataclasses"><span class="std std-ref">Declarative Dataclass Mapping</span></a></p>
</div>
</section>
</section>
<section id="optimized-orm-bulk-insert-now-implemented-for-all-backends-other-than-mysql">
<span id="change-6047"></span><h2>Optimized ORM bulk insert now implemented for all backends other than MySQL<a class="headerlink" href="#optimized-orm-bulk-insert-now-implemented-for-all-backends-other-than-mysql" title="Link to this heading">¶</a></h2>
<p>The dramatic performance improvement introduced in the 1.4 series and described
at <a class="reference internal" href="migration_14.html#change-5263"><span class="std std-ref">ORM Batch inserts with psycopg2 now batch statements with RETURNING in most cases</span></a> has now been generalized to all included backends that
support RETURNING, which is all backends other than MySQL: SQLite, MariaDB,
PostgreSQL (all drivers), and Oracle; SQL Server has support but is
temporarily disabled in version 2.0.9 <a class="footnote-reference brackets" href="#id2" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. While the original feature
was most critical for the psycopg2 driver which otherwise had major performance
issues when using <code class="docutils literal notranslate"><span class="pre">cursor.executemany()</span></code>, the change is also critical for
other PostgreSQL drivers such as asyncpg, as when using RETURNING,
single-statement INSERT statements are still unacceptably slow, as well
as when using SQL Server that also seems to have very slow executemany
speed for INSERT statements regardless of whether or not RETURNING is used.</p>
<p>The performance of the new feature provides an almost across-the-board
order of magnitude performance increase for basically every driver when
INSERTing ORM objects that don’t have a pre-assigned primary key value, as
indicated in the table below, in most cases specific to the use of RETURNING
which is not normally supported with executemany().</p>
<p>The psycopg2 “fast execution helper” approach consists of transforming an
INSERT..RETURNING statement with a single parameter set into a single
statement that INSERTs many parameter sets, using multiple “VALUES…”
clauses so that it can accommodate many parameter sets at once.
Parameter sets are then typically batched into groups of 1000
or similar, so that no single INSERT statement is excessively large, and the
INSERT statement is then invoked for each batch of parameters, rather than
for each individual parameter set.  Primary key values and server defaults
are returned by RETURNING, which continues to work as each statement execution
is invoked using <code class="docutils literal notranslate"><span class="pre">cursor.execute()</span></code>, rather than <code class="docutils literal notranslate"><span class="pre">cursor.executemany()</span></code>.</p>
<p>This allows many rows to be inserted in one statement while also being able to
return newly-generated primary key values as well as SQL and server defaults.
SQLAlchemy historically has always needed to invoke one statement per parameter
set, as it relied upon Python DBAPI Features such as <code class="docutils literal notranslate"><span class="pre">cursor.lastrowid</span></code> which
do not support multiple rows.</p>
<p>With most databases now offering RETURNING (with the conspicuous exception of
MySQL, given that MariaDB supports it), the new change generalizes the psycopg2
“fast execution helper” approach to all dialects that support RETURNING, which
now includes SQlite and MariaDB, and for which no other approach for
“executemany plus RETURNING” is possible, which includes SQLite, MariaDB, and all
PG drivers. The cx_Oracle and oracledb drivers used for Oracle
support RETURNING with executemany natively, and this has also been implemented
to provide equivalent performance improvements.  With SQLite and MariaDB now
offering RETURNING support, ORM use of <code class="docutils literal notranslate"><span class="pre">cursor.lastrowid</span></code> is nearly a thing
of the past, with only MySQL still relying upon it.</p>
<p>For INSERT statements that don’t use RETURNING, traditional executemany()
behavior is used for most backends, with the current exception of psycopg2,
which has very slow executemany() performance overall
and are still improved by the “insertmanyvalues” approach.</p>
<section id="benchmarks">
<h3>Benchmarks<a class="headerlink" href="#benchmarks" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy includes a <a class="reference internal" href="../orm/examples.html#examples-performance"><span class="std std-ref">Performance Suite</span></a> within
the <code class="docutils literal notranslate"><span class="pre">examples/</span></code> directory, where we can make use of the <code class="docutils literal notranslate"><span class="pre">bulk_insert</span></code>
suite to benchmark INSERTs of many rows using both Core and ORM in different
ways.</p>
<p>For the tests below, we are inserting <strong>100,000 objects</strong>, and in all cases we
actually have 100,000 real Python ORM objects in memory, either created up
front or generated on the fly. All databases other than SQLite are run over a
local network connection, not localhost; this causes the “slower” results to be
extremely slow.</p>
<p>Operations that are improved by this feature include:</p>
<ul class="simple">
<li><p>unit of work flushes for objects added to the session using
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.add" title="sqlalchemy.orm.Session.add"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.add()</span></code></a> and <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.add_all" title="sqlalchemy.orm.Session.add_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.add_all()</span></code></a>.</p></li>
<li><p>The new <a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-bulk-insert"><span class="std std-ref">ORM Bulk Insert Statement</span></a> feature,
which improves upon the experimental version of this feature first introduced
in SQLAlchemy 1.4.</p></li>
<li><p>the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> “bulk” operations described at
<a class="reference internal" href="../orm/persistence_techniques.html#bulk-operations"><span class="std std-ref">Bulk Operations</span></a>, which are superseded by the above mentioned
ORM Bulk Insert feature.</p></li>
</ul>
<p>To get a sense of the scale of the operation, below are performance
measurements using the <code class="docutils literal notranslate"><span class="pre">test_flush_no_pk</span></code> performance suite, which
historically represents SQLAlchemy’s worst-case INSERT performance task,
where objects that don’t have primary key values need to be INSERTed, and
then the newly generated primary key values must be fetched so that the
objects can be used for subsequent flush operations, such as establishment
within relationships, flushing joined-inheritance models, etc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Profiler</span><span class="o">.</span><span class="n">profile</span>
<span class="k">def</span> <span class="nf">test_flush_no_pk</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;INSERT statements via the ORM (batched with RETURNING if available),</span>
<span class="sd">    fetching generated row id&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">Customer</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;customer name </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;customer description </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">chunk</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p>This test can be run from any SQLAlchemy source tree as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>python -m examples.performance.bulk_inserts --test test_flush_no_pk</pre></div>
</div>
<p>The table below summarizes performance measurements with
the latest 1.4 series of SQLAlchemy compared to 2.0, both running
the same test:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Driver</p></td>
<td><p>SQLA 1.4 Time (secs)</p></td>
<td><p>SQLA 2.0 Time (secs)</p></td>
</tr>
<tr class="row-even"><td><p>sqlite+pysqlite2 (memory)</p></td>
<td><p>6.204843</p></td>
<td><p>3.554856</p></td>
</tr>
<tr class="row-odd"><td><p>postgresql+asyncpg (network)</p></td>
<td><p>88.292285</p></td>
<td><p>4.561492</p></td>
</tr>
<tr class="row-even"><td><p>postgresql+psycopg (network)</p></td>
<td><p>N/A (psycopg3)</p></td>
<td><p>4.861368</p></td>
</tr>
<tr class="row-odd"><td><p>mssql+pyodbc (network)</p></td>
<td><p>158.396667</p></td>
<td><p>4.825139</p></td>
</tr>
<tr class="row-even"><td><p>oracle+cx_Oracle (network)</p></td>
<td><p>92.603953</p></td>
<td><p>4.809520</p></td>
</tr>
<tr class="row-odd"><td><p>mariadb+mysqldb (network)</p></td>
<td><p>71.705197</p></td>
<td><p>4.075377</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>The feature is was temporarily disabled for SQL Server in
SQLAlchemy 2.0.9 due to issues with row ordering when RETURNING is used.
In SQLAlchemy 2.0.10, the feature is re-enabled, with special
case handling for the unit of work’s requirement for RETURNING to be
ordered.</p>
</aside>
</aside>
</div>
<p>Two additional drivers have no change in performance; the psycopg2 drivers,
for which fast executemany was already implemented in SQLAlchemy 1.4,
and MySQL, which continues to not offer RETURNING support:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Driver</p></td>
<td><p>SQLA 1.4 Time (secs)</p></td>
<td><p>SQLA 2.0 Time (secs)</p></td>
</tr>
<tr class="row-even"><td><p>postgresql+psycopg2 (network)</p></td>
<td><p>4.704876</p></td>
<td><p>4.699883</p></td>
</tr>
<tr class="row-odd"><td><p>mysql+mysqldb (network)</p></td>
<td><p>77.281997</p></td>
<td><p>76.132995</p></td>
</tr>
</tbody>
</table>
</section>
<section id="summary-of-changes">
<h3>Summary of Changes<a class="headerlink" href="#summary-of-changes" title="Link to this heading">¶</a></h3>
<p>The following bullets list the individual changes made within 2.0 in order to
get all drivers to this state:</p>
<ul class="simple">
<li><p>RETURNING implemented for SQLite - <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/6195">#6195</a></p></li>
<li><p>RETURNING implemented for MariaDB - <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7011">#7011</a></p></li>
<li><p>Fix multi-row RETURNING for Oracle - <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/6245">#6245</a></p></li>
<li><p>make insert() executemany() support RETURNING for as many dialects as
possible, usually with VALUES() - <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/6047">#6047</a></p></li>
<li><p>Emit a warning when RETURNING w/ executemany is used for non-supporting
backend (currently no RETURNING backend has this limitation) - <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7907">#7907</a></p></li>
<li><p>The ORM <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper.params.eager_defaults" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.eager_defaults</span></code></a> parameter now defaults to a
a new setting <code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code>, which will enable “eager defaults” automatically
for INSERT statements, when the backend in use supports RETURNING with
“insertmanyvalues”.  See <a class="reference internal" href="../orm/persistence_techniques.html#orm-server-defaults"><span class="std std-ref">Fetching Server-Generated Defaults</span></a> for documentation.</p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/connections.html#engine-insertmanyvalues"><span class="std std-ref">“Insert Many Values” Behavior for INSERT statements</span></a> - Documentation and background on the
new feature as well as how to configure it</p>
</div>
</section>
</section>
<section id="orm-enabled-insert-upsert-update-and-delete-statements-with-orm-returning">
<span id="change-8360"></span><h2>ORM-enabled Insert, Upsert, Update and Delete Statements, with ORM RETURNING<a class="headerlink" href="#orm-enabled-insert-upsert-update-and-delete-statements-with-orm-returning" title="Link to this heading">¶</a></h2>
<p>SQLAlchemy 1.4 ported the features of the legacy <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object to
<a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a> execution, which meant that the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct
could be passed to <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> to deliver ORM results. Support
was also added for <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> and <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> to be passed to
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>, to the degree that they could provide
implementations of <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> and <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a>.</p>
<p>The major missing element has been support for the <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> construct.
The 1.4 documentation addressed this with some recipes for “inserts” and “upserts”
with use of <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.from_statement" title="sqlalchemy.sql.expression.Select.from_statement"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.from_statement()</span></code></a> to integrate RETURNING
into an ORM context.  2.0 now fully closes the gap by integrating direct support for
<a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> as an enhanced version of the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code></a>
method, along with full ORM RETURNING support for all DML structures.</p>
<section id="bulk-insert-with-returning">
<h3>Bulk Insert with RETURNING<a class="headerlink" href="#bulk-insert-with-returning" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> can be passed to <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>, with
or without <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a>, which when passed with a
separate parameter list will invoke the same process as was previously
implemented by
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code></a>, with additional enhancements.  This will optimize the
batching of rows making use of the new <a class="reference internal" href="#change-6047"><span class="std std-ref">fast insertmany</span></a>
feature, while also adding support for
heterogeneous parameter sets and multiple-table mappings like joined table
inheritance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">insert</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;spongebob&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sandy&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Sandy Cheeks&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;patrick&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;squidward&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Squidward Tentacles&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ehkrabs&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Eugene H. Krabs&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),</span>
<span class="go"> User(name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;),</span>
<span class="go"> User(name=&#39;patrick&#39;, fullname=&#39;Patrick Star&#39;),</span>
<span class="go"> User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;),</span>
<span class="go"> User(name=&#39;ehkrabs&#39;, fullname=&#39;Eugene H. Krabs&#39;)]</span></pre></div>
</div>
<p>RETURNING is supported for all of these use cases, where the ORM will construct
a full result set from multiple statement invocations.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-bulk-insert"><span class="std std-ref">ORM Bulk INSERT Statements</span></a></p>
</div>
</section>
<section id="bulk-update">
<h3>Bulk UPDATE<a class="headerlink" href="#bulk-update" title="Link to this heading">¶</a></h3>
<p>In a similar manner as that of <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>, passing the
<a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> construct along with a parameter list that includes
primary key values to <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> will invoke the same process
as previously supported by the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.bulk_update_mappings" title="sqlalchemy.orm.Session.bulk_update_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_update_mappings()</span></code></a>
method.  This feature does not however support RETURNING, as it uses
a SQL UPDATE statement that is invoked using DBAPI <a class="reference internal" href="../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-bulk-update"><span class="std std-ref">ORM Bulk UPDATE by Primary Key</span></a></p>
</div>
</section>
<section id="insert-upsert-values-returning">
<h3>INSERT / upsert … VALUES … RETURNING<a class="headerlink" href="#insert-upsert-values-returning" title="Link to this heading">¶</a></h3>
<p>When using <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> with <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a>, the set of
parameters may include SQL expressions. Additionally, upsert variants
such as those for SQLite, PostgreSQL and MariaDB are also supported.
These statements may now include <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> clauses
with column expressions or full ORM entities:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects.sqlite</span> <span class="kn">import</span> <span class="n">insert</span> <span class="k">as</span> <span class="n">sqlite_upsert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">sqlite_upsert</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;spongebob&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sandy&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Sandy Cheeks&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;patrick&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;squidward&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Squidward Tentacles&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ehkrabs&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Eugene H. Krabs&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">]</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">on_conflict_do_update</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">index_elements</span><span class="o">=</span><span class="p">[</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">set_</span><span class="o">=</span><span class="n">dict</span><span class="p">(</span><span class="n">fullname</span><span class="o">=</span><span class="n">stmt</span><span class="o">.</span><span class="n">excluded</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),</span>
<span class="go">User(name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;),</span>
<span class="go">User(name=&#39;patrick&#39;, fullname=&#39;Patrick Star&#39;),</span>
<span class="go">User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;),</span>
<span class="go">User(name=&#39;ehkrabs&#39;, fullname=&#39;Eugene H. Krabs&#39;)]</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-insert-values"><span class="std std-ref">ORM Bulk Insert with Per Row SQL Expressions</span></a></p>
<p><a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-upsert"><span class="std std-ref">ORM “upsert” Statements</span></a></p>
</div>
</section>
<section id="orm-update-delete-with-where-returning">
<h3>ORM UPDATE / DELETE with WHERE … RETURNING<a class="headerlink" href="#orm-update-delete-with-where-returning" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy 1.4 also had some modest support for the RETURNING feature to be
used with the <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> and <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> constructs, when
used with <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>.  This support has now been upgraded
to be fully native, including that the <code class="docutils literal notranslate"><span class="pre">fetch</span></code> synchronization strategy
may also proceed whether or not explicit use of RETURNING is present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;squidward&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;spongebob&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">execution_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;synchronize_session&quot;</span><span class="p">:</span> <span class="s2">&quot;fetch&quot;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-update-delete-where"><span class="std std-ref">ORM UPDATE and DELETE with Custom WHERE Criteria</span></a></p>
<p><a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-update-delete-where-returning"><span class="std std-ref">Using RETURNING with UPDATE/DELETE and Custom WHERE Criteria</span></a></p>
</div>
</section>
<section id="improved-synchronize-session-behavior-for-orm-update-delete">
<h3>Improved <code class="docutils literal notranslate"><span class="pre">synchronize_session</span></code> behavior for ORM UPDATE / DELETE<a class="headerlink" href="#improved-synchronize-session-behavior-for-orm-update-delete" title="Link to this heading">¶</a></h3>
<p>The default strategy for <a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-update-delete-sync"><span class="std std-ref">synchronize_session</span></a>
is now a new value <code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code>.  This strategy will attempt to use the
<code class="docutils literal notranslate"><span class="pre">&quot;evaluate&quot;</span></code> strategy and then automatically fall back to the <code class="docutils literal notranslate"><span class="pre">&quot;fetch&quot;</span></code>
strategy.   For all backends other than MySQL / MariaDB, <code class="docutils literal notranslate"><span class="pre">&quot;fetch&quot;</span></code> uses
RETURNING to fetch UPDATE/DELETEd primary key identifiers within the
same statement, so is generally more efficient than previous versions
(in 1.4, RETURNING was only available for PostgreSQL, SQL Server).</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/queryguide/dml.html#orm-queryguide-update-delete-sync"><span class="std std-ref">Selecting a Synchronization Strategy</span></a></p>
</div>
</section>
<section id="id3">
<h3>Summary of Changes<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p>Listed tickets for new ORM DML with RETURNING features:</p>
<ul class="simple">
<li><p>convert <code class="docutils literal notranslate"><span class="pre">insert()</span></code> at ORM level to interpret <code class="docutils literal notranslate"><span class="pre">values()</span></code> in an ORM
context - <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7864">#7864</a></p></li>
<li><p>evaluate feasibility of dml.returning(Entity) to deliver ORM expressions,
automatically apply select().from_statement equiv - <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7865">#7865</a></p></li>
<li><p>given ORM insert, try to carry the bulk methods along, re: inheritance -
<a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/8360">#8360</a></p></li>
</ul>
</section>
</section>
<section id="new-write-only-relationship-strategy-supersedes-dynamic">
<span id="change-7123"></span><h2>New “Write Only” relationship strategy supersedes “dynamic”<a class="headerlink" href="#new-write-only-relationship-strategy-supersedes-dynamic" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">lazy=&quot;dynamic&quot;</span></code> loader strategy becomes legacy, in that it is hardcoded
to make use of legacy <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>. This loader strategy is both not
compatible with asyncio, and additionally has many behaviors that implicitly
iterate its contents, which defeat the original purpose of the “dynamic”
relationship as being for very large collections that should not be implicitly
fully loaded into memory at any time.</p>
<p>The “dynamic” strategy is now superseded by a new strategy
<code class="docutils literal notranslate"><span class="pre">lazy=&quot;write_only&quot;</span></code>.  Configuration of “write only” may be achieved using
the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.lazy" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.lazy</span></code></a> parameter of <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>,
or when using <a class="reference internal" href="#whatsnew-20-orm-declarative-typing"><span class="std std-ref">type annotated mappings</span></a>,
indicating the <a class="reference internal" href="../orm/large_collections.html#sqlalchemy.orm.WriteOnlyMapped" title="sqlalchemy.orm.WriteOnlyMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyMapped</span></code></a> annotation as the mapping style:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">WriteOnlyMapped</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;account&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">account_transactions</span><span class="p">:</span> <span class="n">WriteOnlyMapped</span><span class="p">[</span><span class="s2">&quot;AccountTransaction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
        <span class="n">passive_deletes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;AccountTransaction.timestamp&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">AccountTransaction</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;account_transaction&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">account_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;account.id&quot;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">amount</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The write-only-mapped collection resembles <code class="docutils literal notranslate"><span class="pre">lazy=&quot;dynamic&quot;</span></code> in that
the collection may be assigned up front, and also has methods such as
<a class="reference internal" href="../orm/large_collections.html#sqlalchemy.orm.WriteOnlyCollection.add" title="sqlalchemy.orm.WriteOnlyCollection.add"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.add()</span></code></a> and <a class="reference internal" href="../orm/large_collections.html#sqlalchemy.orm.WriteOnlyCollection.remove" title="sqlalchemy.orm.WriteOnlyCollection.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.remove()</span></code></a>
to modify the collection on an individual item basis:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span>
    <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;account_01&quot;</span><span class="p">,</span>
    <span class="n">account_transactions</span><span class="o">=</span><span class="p">[</span>
        <span class="n">AccountTransaction</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;initial deposit&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">)),</span>
        <span class="n">AccountTransaction</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;transfer&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">)),</span>
        <span class="n">AccountTransaction</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;withdrawal&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-29.50&quot;</span><span class="p">)),</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">new_account</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">AccountTransaction</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;transfer&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;2000.00&quot;</span><span class="p">))</span>
<span class="p">)</span></pre></div>
</div>
<p>The bigger difference is on the database loading side, where the collection
has no ability to load objects from the database directly; instead,
SQL construction methods such as <a class="reference internal" href="../orm/large_collections.html#sqlalchemy.orm.WriteOnlyCollection.select" title="sqlalchemy.orm.WriteOnlyCollection.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.select()</span></code></a> are used to
produce SQL constructs such as <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> which are then executed
using <a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a> to load the desired objects in an explicit way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">account_transactions</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
    <span class="n">existing_account</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AccountTransaction</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>The <a class="reference internal" href="../orm/large_collections.html#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> also integrates with the new
<a class="reference internal" href="#change-8360"><span class="std std-ref">ORM bulk dml</span></a> features, including support for bulk INSERT
and UPDATE/DELETE with WHERE criteria, all including RETURNING support as
well.   See the complete documentation at <a class="reference internal" href="../orm/large_collections.html#write-only-relationship"><span class="std std-ref">Write Only Relationships</span></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/large_collections.html#write-only-relationship"><span class="std std-ref">Write Only Relationships</span></a></p>
</div>
<section id="new-pep-484-type-annotated-mapping-support-for-dynamic-relationships">
<h3>New pep-484 / type annotated mapping support for Dynamic Relationships<a class="headerlink" href="#new-pep-484-type-annotated-mapping-support-for-dynamic-relationships" title="Link to this heading">¶</a></h3>
<p>Even though “dynamic” relationships are legacy in 2.0, as these patterns
are expected to have a long lifespan,
<a class="reference internal" href="#whatsnew-20-orm-declarative-typing"><span class="std std-ref">type annotated mapping</span></a> support
is now added for “dynamic” relationships in the same way that its available
for the new <code class="docutils literal notranslate"><span class="pre">lazy=&quot;write_only&quot;</span></code> approach, using the <a class="reference internal" href="../orm/large_collections.html#sqlalchemy.orm.DynamicMapped" title="sqlalchemy.orm.DynamicMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">DynamicMapped</span></code></a>
annotation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DynamicMapped</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;account&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">account_transactions</span><span class="p">:</span> <span class="n">DynamicMapped</span><span class="p">[</span><span class="s2">&quot;AccountTransaction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
        <span class="n">passive_deletes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;AccountTransaction.timestamp&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">AccountTransaction</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;account_transaction&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">account_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;account.id&quot;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">amount</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The above mapping will provide an <code class="docutils literal notranslate"><span class="pre">Account.account_transactions</span></code> collection
that is typed as returning the <a class="reference internal" href="../orm/large_collections.html#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a> collection type,
including its element type, e.g. <code class="docutils literal notranslate"><span class="pre">AppenderQuery[AccountTransaction]</span></code>.  This
then allows iteration and queries to yield objects which are typed
as <code class="docutils literal notranslate"><span class="pre">AccountTransaction</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/large_collections.html#dynamic-relationship"><span class="std std-ref">Dynamic Relationship Loaders</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7123">#7123</a></p>
</section>
</section>
<section id="installation-is-now-fully-pep-517-enabled">
<span id="change-7311"></span><h2>Installation is now fully pep-517 enabled<a class="headerlink" href="#installation-is-now-fully-pep-517-enabled" title="Link to this heading">¶</a></h2>
<p>The source distribution now includes a <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file to allow for
complete <span class="target" id="index-9"></span><a class="pep reference external" href="https://peps.python.org/pep-0517/"><strong>PEP 517</strong></a> support. In particular this allows a local source build
using <code class="docutils literal notranslate"><span class="pre">pip</span></code> to automatically install the <a class="reference external" href="https://cython.org/">Cython</a> optional dependency.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7311">#7311</a></p>
</section>
<section id="c-extensions-now-ported-to-cython">
<span id="change-7256"></span><h2>C Extensions now ported to Cython<a class="headerlink" href="#c-extensions-now-ported-to-cython" title="Link to this heading">¶</a></h2>
<p>The SQLAlchemy C extensions have been replaced with all new extensions written
in <a class="reference external" href="https://cython.org/">Cython</a>. While Cython was evaluated back in 2010 when the C extensions were
first created, the nature and focus of the C extensions in use today has
changed quite a bit from that time. At the same time, Cython has apparently
evolved significantly, as has the Python build / distribution toolchain which
made it feasible for us to revisit it.</p>
<p>The move to Cython provides dramatic new advantages with
no apparent downsides:</p>
<ul class="simple">
<li><p>The Cython extensions that replace specific C extensions have all benchmarked
as <strong>faster</strong>, often slightly, but sometimes significantly, than
virtually all the C code that SQLAlchemy previously
included. While this seems amazing, it appears to be a product of
non-obvious optimizations within Cython’s implementation that would not be
present in a direct Python to C port of a function, as was particularly the
case for many of the custom collection types added to the C extensions.</p></li>
<li><p>Cython extensions are much easier to write, maintain and debug compared to
raw C code, and in most cases are line-per-line equivalent to the Python
code.   It is expected that many more elements of SQLAlchemy will be
ported to Cython in the coming releases which should open many new doors
to performance improvements that were previously out of reach.</p></li>
<li><p>Cython is very mature and widely used, including being the basis of some
of the prominent database drivers supported by SQLAlchemy including
<code class="docutils literal notranslate"><span class="pre">asyncpg</span></code>, <code class="docutils literal notranslate"><span class="pre">psycopg3</span></code> and <code class="docutils literal notranslate"><span class="pre">asyncmy</span></code>.</p></li>
</ul>
<p>Like the previous C extensions, the Cython extensions are pre-built within
SQLAlchemy’s wheel distributions which are automatically available to <code class="docutils literal notranslate"><span class="pre">pip</span></code>
from PyPi.  Manual build instructions are also unchanged with the exception
of the Cython requirement.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../intro.html#c-extensions"><span class="std std-ref">Building the Cython Extensions</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7256">#7256</a></p>
</section>
<section id="major-architectural-performance-and-api-enhancements-for-database-reflection">
<span id="change-4379"></span><h2>Major Architectural, Performance and API Enhancements for Database Reflection<a class="headerlink" href="#major-architectural-performance-and-api-enhancements-for-database-reflection" title="Link to this heading">¶</a></h2>
<p>The internal system by which <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects and their components are
<a class="reference internal" href="../core/reflection.html#metadata-reflection"><span class="std std-ref">reflected</span></a> has been completely rearchitected to
allow high performance bulk reflection of thousands of tables at once for
participating dialects. Currently, the <strong>PostgreSQL</strong> and <strong>Oracle</strong> dialects
participate in the new architecture, where the PostgreSQL dialect can now
reflect a large series of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects nearly three times faster,
and the Oracle dialect can now reflect a large series of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
objects ten times faster.</p>
<p>The rearchitecture applies most directly to dialects that make use of SELECT
queries against system catalog tables to reflect tables, and the remaining
included dialect that can benefit from this approach will be the SQL Server
dialect. The MySQL/MariaDB and SQLite dialects by contrast make use of
non-relational systems to reflect database tables, and were not subject to a
pre-existing performance issue.</p>
<p>The new API is backwards compatible with the previous system, and should
require no changes to third party dialects to retain compatibility; third party
dialects can also opt into the new system by implementing batched queries for
schema reflection.</p>
<p>Along with this change, the API and behavior of the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector" title="sqlalchemy.engine.reflection.Inspector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Inspector</span></code></a>
object has been improved and enhanced with more consistent cross-dialect
behaviors as well as new methods and new performance features.</p>
<section id="performance-overview">
<h3>Performance Overview<a class="headerlink" href="#performance-overview" title="Link to this heading">¶</a></h3>
<p>The source distribution includes a script
<code class="docutils literal notranslate"><span class="pre">test/perf/many_table_reflection.py</span></code> which benches both existing reflection
features as well as new ones. A limited set of its tests may be run on older
versions of SQLAlchemy, where here we use it to illustrate differences in
performance to invoke <code class="docutils literal notranslate"><span class="pre">metadata.reflect()</span></code> to reflect 250 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
objects at once over a local network connection:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Dialect</p></td>
<td><p>Operation</p></td>
<td><p>SQLA 1.4 Time (secs)</p></td>
<td><p>SQLA 2.0 Time (secs)</p></td>
</tr>
<tr class="row-even"><td><p>postgresql+psycopg2</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">metadata.reflect()</span></code>, 250 tables</p></td>
<td><p>8.2</p></td>
<td><p>3.3</p></td>
</tr>
<tr class="row-odd"><td><p>oracle+cx_oracle</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">metadata.reflect()</span></code>, 250 tables</p></td>
<td><p>60.4</p></td>
<td><p>6.8</p></td>
</tr>
</tbody>
</table>
</section>
<section id="behavioral-changes-for-inspector">
<h3>Behavioral Changes for <code class="docutils literal notranslate"><span class="pre">Inspector()</span></code><a class="headerlink" href="#behavioral-changes-for-inspector" title="Link to this heading">¶</a></h3>
<p>For SQLAlchemy-included dialects for SQLite, PostgreSQL, MySQL/MariaDB,
Oracle, and SQL Server, the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.has_table" title="sqlalchemy.engine.reflection.Inspector.has_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.has_table()</span></code></a>,
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.has_sequence" title="sqlalchemy.engine.reflection.Inspector.has_sequence"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.has_sequence()</span></code></a>, <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.has_index" title="sqlalchemy.engine.reflection.Inspector.has_index"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.has_index()</span></code></a>,
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_names" title="sqlalchemy.engine.reflection.Inspector.get_table_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_table_names()</span></code></a> and
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_sequence_names" title="sqlalchemy.engine.reflection.Inspector.get_sequence_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_sequence_names()</span></code></a> now all behave consistently in terms
of caching: they all fully cache their result after being called the first
time for a particular <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector" title="sqlalchemy.engine.reflection.Inspector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Inspector</span></code></a> object. Programs that create or
drop tables/sequences while calling upon the same <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector" title="sqlalchemy.engine.reflection.Inspector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Inspector</span></code></a>
object will not receive updated status after the state of the database has
changed. A call to <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.clear_cache" title="sqlalchemy.engine.reflection.Inspector.clear_cache"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.clear_cache()</span></code></a> or a new
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector" title="sqlalchemy.engine.reflection.Inspector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Inspector</span></code></a> should be used when DDL changes are to be executed.
Previously, the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.has_table" title="sqlalchemy.engine.reflection.Inspector.has_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.has_table()</span></code></a>,
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.has_sequence" title="sqlalchemy.engine.reflection.Inspector.has_sequence"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.has_sequence()</span></code></a> methods did not implement caching nor did
the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector" title="sqlalchemy.engine.reflection.Inspector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Inspector</span></code></a> support caching for these methods, while the
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_names" title="sqlalchemy.engine.reflection.Inspector.get_table_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_table_names()</span></code></a> and
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_sequence_names" title="sqlalchemy.engine.reflection.Inspector.get_sequence_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_sequence_names()</span></code></a> methods were, leading to inconsistent
results between the two types of method.</p>
<p>Behavior for third party dialects is dependent on whether or not they
implement the “reflection cache” decorator for the dialect-level
implementation of these methods.</p>
</section>
<section id="new-methods-and-improvements-for-inspector">
<h3>New Methods and Improvements for <code class="docutils literal notranslate"><span class="pre">Inspector()</span></code><a class="headerlink" href="#new-methods-and-improvements-for-inspector" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>added a method
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.has_schema" title="sqlalchemy.engine.reflection.Inspector.has_schema"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.has_schema()</span></code></a> that returns if a schema
is present in the target database</p></li>
<li><p>added a method <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.has_index" title="sqlalchemy.engine.reflection.Inspector.has_index"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.has_index()</span></code></a> that returns if a table has
a particular index.</p></li>
<li><p>Inspection methods such as <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_columns" title="sqlalchemy.engine.reflection.Inspector.get_columns"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_columns()</span></code></a> that work
on a single table at a time should now all consistently
raise <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.NoSuchTableError" title="sqlalchemy.exc.NoSuchTableError"><code class="xref py py-class docutils literal notranslate"><span class="pre">NoSuchTableError</span></code></a> if a
table or view is not found; this change is specific to individual
dialects, so may not be the case for existing third-party dialects.</p></li>
<li><p>Separated the handling of “views” and “materialized views”, as in
real world use cases, these two constructs make use of different DDL
for CREATE and DROP; this includes that there are now separate
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_view_names" title="sqlalchemy.engine.reflection.Inspector.get_view_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_view_names()</span></code></a> and
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_materialized_view_names" title="sqlalchemy.engine.reflection.Inspector.get_materialized_view_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_materialized_view_names()</span></code></a> methods.</p></li>
</ul>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4379">#4379</a></p>
</section>
</section>
<section id="dialect-support-for-psycopg-3-a-k-a-psycopg">
<span id="ticket-6842"></span><h2>Dialect support for psycopg 3 (a.k.a. “psycopg”)<a class="headerlink" href="#dialect-support-for-psycopg-3-a-k-a-psycopg" title="Link to this heading">¶</a></h2>
<p>Added dialect support for the <a class="reference external" href="https://pypi.org/project/psycopg/">psycopg 3</a>
DBAPI, which despite the number “3” now goes by the package name <code class="docutils literal notranslate"><span class="pre">psycopg</span></code>,
superseding the previous <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> package that for the time being remains
SQLAlchemy’s “default” driver for the <code class="docutils literal notranslate"><span class="pre">postgresql</span></code> dialects. <code class="docutils literal notranslate"><span class="pre">psycopg</span></code> is a
completely reworked and modernized database adapter for PostgreSQL which
supports concepts such as prepared statements as well as Python asyncio.</p>
<p><code class="docutils literal notranslate"><span class="pre">psycopg</span></code> is the first DBAPI supported by SQLAlchemy which provides
both a pep-249 synchronous API as well as an asyncio driver.  The same
<code class="docutils literal notranslate"><span class="pre">psycopg</span></code> database URL may be used with the <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a>
and <a class="reference internal" href="../orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.create_async_engine" title="sqlalchemy.ext.asyncio.create_async_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_async_engine()</span></code></a> engine-creation functions, and the
corresponding sync or asyncio version of the dialect will be selected
automatically.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#postgresql-psycopg"><span class="std std-ref">psycopg</span></a></p>
</div>
</section>
<section id="dialect-support-for-oracledb">
<span id="ticket-8054"></span><h2>Dialect support for oracledb<a class="headerlink" href="#dialect-support-for-oracledb" title="Link to this heading">¶</a></h2>
<p>Added dialect support for the <a class="reference external" href="https://pypi.org/project/oracledb/">oracledb</a>
DBAPI, which is the renamed, new major release of the popular cx_Oracle driver.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/oracle.html#oracledb"><span class="std std-ref">python-oracledb</span></a></p>
</div>
</section>
<section id="new-conditional-ddl-for-constraints-and-indexes">
<span id="ticket-7631"></span><h2>New Conditional DDL for Constraints and Indexes<a class="headerlink" href="#new-conditional-ddl-for-constraints-and-indexes" title="Link to this heading">¶</a></h2>
<p>A new method <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Constraint.ddl_if" title="sqlalchemy.schema.Constraint.ddl_if"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Constraint.ddl_if()</span></code></a> and <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index.ddl_if" title="sqlalchemy.schema.Index.ddl_if"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Index.ddl_if()</span></code></a>
allows constructs such as <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.CheckConstraint" title="sqlalchemy.schema.CheckConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">CheckConstraint</span></code></a>, <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a>
and <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a> to be rendered conditionally for a given
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>, based on the same kinds of criteria that are accepted
by the <code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLElement.execute_if()</span></code> method.  In the example below,
the CHECK constraint and index will only be produced against a PostgreSQL
backend:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>


<span class="n">my_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;my_table&quot;</span><span class="p">,</span>
    <span class="n">meta</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;my_pg_index&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ddl_if</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;postgresql&quot;</span><span class="p">),</span>
    <span class="n">CheckConstraint</span><span class="p">(</span><span class="s2">&quot;num &gt; 5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ddl_if</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;postgresql&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">e1</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">meta</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>  <span class="c1"># will not generate CHECK and INDEX</span>


<span class="n">e2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">meta</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>  <span class="c1"># will generate CHECK and INDEX</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/ddl.html#schema-ddl-ddl-if"><span class="std std-ref">Controlling DDL Generation of Constraints and Indexes</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7631">#7631</a></p>
</section>
<section id="date-time-datetime-datatypes-now-support-literal-rendering-on-all-backends">
<span id="change-5052"></span><h2>DATE, TIME, DATETIME datatypes now support literal rendering on all backends<a class="headerlink" href="#date-time-datetime-datatypes-now-support-literal-rendering-on-all-backends" title="Link to this heading">¶</a></h2>
<p>Literal rendering is now implemented for date and time types for backend
specific compilation, including PostgreSQL and Oracle:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">DATETIME</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">literal</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">oracle</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">postgresql</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">date_literal</span> <span class="o">=</span> <span class="n">literal</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">DATETIME</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span>
<span class="go">...     date_literal.compile(</span>
<span class="go">...         dialect=postgresql.dialect(), compile_kwargs={&quot;literal_binds&quot;: True}</span>
<span class="go">...     )</span>
<span class="go">... )</span>
<div class='show_sql_print'><span class="s1">&#39;2022-12-17 11:02:13.575789&#39;</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span>
<span class="go">...     date_literal.compile(</span>
<span class="go">...         dialect=oracle.dialect(), compile_kwargs={&quot;literal_binds&quot;: True}</span>
<span class="go">...     )</span>
<span class="go">... )</span>
<div class='show_sql_print'><span class="n">TO_TIMESTAMP</span><span class="p">(</span><span class="s1">&#39;2022-12-17 11:02:13.575789&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;YYYY-MM-DD HH24:MI:SS.FF&#39;</span><span class="p">)</span>
</div></pre></div>
</div>
<p>Previously, such literal rendering only worked when stringifying statements
without any dialect given; when attempting to render with a dialect-specific
type, a <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> would be raised, up until
SQLAlchemy 1.4.45 where this became a <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.CompileError" title="sqlalchemy.exc.CompileError"><code class="xref py py-class docutils literal notranslate"><span class="pre">CompileError</span></code></a> (part of
<a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/8800">#8800</a>).</p>
<p>The default rendering is modified ISO-8601 rendering (i.e. ISO-8601 with the T
converted to a space) when using <code class="docutils literal notranslate"><span class="pre">literal_binds</span></code> with the SQL compilers
provided by the PostgreSQL, MySQL, MariaDB, MSSQL, Oracle dialects. For Oracle,
the ISO format is wrapped inside of an appropriate TO_DATE() function call.
The rendering for SQLite is unchanged as this dialect always included string
rendering for date values.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/5052">#5052</a></p>
</section>
<section id="context-manager-support-for-result-asyncresult">
<span id="change-8710"></span><h2>Context Manager Support for <code class="docutils literal notranslate"><span class="pre">Result</span></code>, <code class="docutils literal notranslate"><span class="pre">AsyncResult</span></code><a class="headerlink" href="#context-manager-support-for-result-asyncresult" title="Link to this heading">¶</a></h2>
<p>The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> object now supports context manager use, which will
ensure the object and its underlying cursor is closed at the end of the block.
This is useful in particular with server side cursors, where it’s important that
the open cursor object is closed at the end of an operation, even if user-defined
exceptions have occurred:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">yield_per</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;select * from table&quot;</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
</div>
<p>With asyncio use, the <a class="reference internal" href="../orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncResult" title="sqlalchemy.ext.asyncio.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> and <a class="reference internal" href="../orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncConnection" title="sqlalchemy.ext.asyncio.AsyncConnection"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncConnection</span></code></a> have
been altered to provide for optional async context manager use, as in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">with</span> <span class="n">async_engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">yield_per</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;select * from table&quot;</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/8710">#8710</a></p>
</section>
<section id="behavioral-changes">
<h2>Behavioral Changes<a class="headerlink" href="#behavioral-changes" title="Link to this heading">¶</a></h2>
<p>This section covers behavioral changes made in SQLAlchemy 2.0 which are
not otherwise part of the major 1.4-&gt;2.0 migration path; changes here are
not expected to have significant effects on backwards compatibility.</p>
<section id="new-transaction-join-modes-for-session">
<span id="change-9015"></span><h3>New transaction join modes for <code class="docutils literal notranslate"><span class="pre">Session</span></code><a class="headerlink" href="#new-transaction-join-modes-for-session" title="Link to this heading">¶</a></h3>
<p>The behavior of “joining an external transaction into a Session” has been
revised and improved, allowing explicit control over how the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> will accommodate an incoming <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a>
that already has a transaction and possibly a savepoint already established.
The new parameter <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.params.join_transaction_mode" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.join_transaction_mode</span></code></a> includes a
series of option values which can accommodate the existing transaction in
several ways, most importantly allowing a <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> to operate in a
fully transactional style using savepoints exclusively, while leaving the
externally initiated transaction non-committed and active under all
circumstances, allowing test suites to rollback all changes that take place
within tests.</p>
<p>The primary improvement this allows is that the recipe documented at
<a class="reference internal" href="../orm/session_transaction.html#session-external-transaction"><span class="std std-ref">Joining a Session into an External Transaction (such as for test suites)</span></a>, which also changed from SQLAlchemy 1.3
to 1.4, is now simplified to no longer require explicit use of an event
handler or any mention of an explicit savepoint; by using
<code class="docutils literal notranslate"><span class="pre">join_transaction_mode=&quot;create_savepoint&quot;</span></code>, the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> will
never affect the state of an incoming transaction, and will instead create a
savepoint (i.e. “nested transaction”) as its root transaction.</p>
<p>The following illustrates part of the example given at
<a class="reference internal" href="../orm/session_transaction.html#session-external-transaction"><span class="std std-ref">Joining a Session into an External Transaction (such as for test suites)</span></a>; see that section for a full example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># connect to the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="c1"># begin a non-ORM transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

        <span class="c1"># bind an individual Session to the connection, selecting</span>
        <span class="c1"># &quot;create_savepoint&quot; join_transaction_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span>
            <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">join_transaction_mode</span><span class="o">=</span><span class="s2">&quot;create_savepoint&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># rollback non-ORM transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

        <span class="c1"># return connection to the Engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The default mode selected for <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.params.join_transaction_mode" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.join_transaction_mode</span></code></a>
is <code class="docutils literal notranslate"><span class="pre">&quot;conditional_savepoint&quot;</span></code>, which uses <code class="docutils literal notranslate"><span class="pre">&quot;create_savepoint&quot;</span></code> behavior
if the given <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> is itself already on a savepoint.
If the given <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> is in a transaction but not a
savepoint, the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> will propagate “rollback” calls
but not “commit” calls, but will not begin a new savepoint on its own.  This
behavior is chosen by default for its maximum compatibility with
older SQLAlchemy versions as well as that it does not start a new SAVEPOINT
unless the given driver is already making use of SAVEPOINT, as support
for SAVEPOINT varies not only with specific backend and driver but also
configurationally.</p>
<p>The following illustrates a case that worked in SQLAlchemy 1.3, stopped working
in SQLAlchemy 1.4, and is now restored in SQLAlchemy 2.0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>

<span class="c1"># setup outer connection with a transaction and a SAVEPOINT</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="n">nested</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>

<span class="c1"># bind a Session to that connection and operate upon it, including</span>
<span class="c1"># a commit</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># assert both SAVEPOINT and transaction remain active</span>
<span class="k">assert</span> <span class="n">nested</span><span class="o">.</span><span class="n">is_active</span>
<span class="n">nested</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="n">trans</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span></pre></div>
</div>
<p>Where above, a <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is joined to a <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a>
that has a savepoint started on it; the state of these two units remains
unchanged after the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> has worked with the transaction. In
SQLAlchemy 1.3, the above case worked because the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> would
begin a “subtransaction” upon the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a>, which would
allow the outer savepoint / transaction to remain unaffected for simple cases
as above. Since subtransactions were deprecated in 1.4 and are now removed in
2.0, this behavior was no longer available. The new default behavior improves
upon the behavior of “subtransactions” by using a real, second SAVEPOINT
instead, so that even calls to <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.rollback" title="sqlalchemy.orm.Session.rollback"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.rollback()</span></code></a> prevent the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> from “breaking out” into the externally initiated
SAVEPOINT or transaction.</p>
<p>New code that is joining a transaction-started <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> into
a <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> should however select a
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.params.join_transaction_mode" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.join_transaction_mode</span></code></a> explicitly, so that the desired
behavior is explicitly defined.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/9015">#9015</a></p>
</section>
<section id="str-engine-url-will-obfuscate-the-password-by-default">
<span id="change-8567"></span><h3><code class="docutils literal notranslate"><span class="pre">str(engine.url)</span></code> will obfuscate the password by default<a class="headerlink" href="#str-engine-url-will-obfuscate-the-password-by-default" title="Link to this heading">¶</a></h3>
<p>To avoid leakage of database passwords, calling <code class="docutils literal notranslate"><span class="pre">str()</span></code> on a
<a class="reference internal" href="../core/engines.html#sqlalchemy.engine.URL" title="sqlalchemy.engine.URL"><code class="xref py py-class docutils literal notranslate"><span class="pre">URL</span></code></a> will now enable the password obfuscation feature by default.
Previously, this obfuscation would be in place for <code class="docutils literal notranslate"><span class="pre">__repr__()</span></code> calls
but not <code class="docutils literal notranslate"><span class="pre">__str__()</span></code>.   This change will impact applications and test suites
that attempt to invoke <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> given the stringified URL
from another engine, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">e1</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://scott:tiger@localhost/test&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">e1</span><span class="o">.</span><span class="n">url</span><span class="p">))</span></pre></div>
</div>
<p>The above engine <code class="docutils literal notranslate"><span class="pre">e2</span></code> will not have the correct password; it will have the
obfuscated string <code class="docutils literal notranslate"><span class="pre">&quot;***&quot;</span></code>.</p>
<p>The preferred approach for the above pattern is to pass the
<a class="reference internal" href="../core/engines.html#sqlalchemy.engine.URL" title="sqlalchemy.engine.URL"><code class="xref py py-class docutils literal notranslate"><span class="pre">URL</span></code></a> object directly, there’s no need to stringify:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">e1</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://scott:tiger@localhost/test&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">e1</span><span class="o">.</span><span class="n">url</span><span class="p">)</span></pre></div>
</div>
<p>Otherwise, for a stringified URL with cleartext password, use the
<a class="reference internal" href="../core/engines.html#sqlalchemy.engine.URL.render_as_string" title="sqlalchemy.engine.URL.render_as_string"><code class="xref py py-meth docutils literal notranslate"><span class="pre">URL.render_as_string()</span></code></a> method, passing the
<a class="reference internal" href="../core/engines.html#sqlalchemy.engine.URL.render_as_string.params.hide_password" title="sqlalchemy.engine.URL.render_as_string"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">URL.render_as_string.hide_password</span></code></a> parameter
as <code class="docutils literal notranslate"><span class="pre">False</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">e1</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://scott:tiger@localhost/test&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">url_string</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">render_as_string</span><span class="p">(</span><span class="n">hide_password</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url_string</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/8567">#8567</a></p>
</section>
<section id="stricter-rules-for-replacement-of-columns-in-table-objects-with-same-names-keys">
<span id="change-8925"></span><h3>Stricter rules for replacement of Columns in Table objects with same-names, keys<a class="headerlink" href="#stricter-rules-for-replacement-of-columns-in-table-objects-with-same-names-keys" title="Link to this heading">¶</a></h3>
<p>Stricter rules are in place for appending of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects to
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects, both moving some previous deprecation warnings to
exceptions, and preventing some previous scenarios that would cause
duplicate columns to appear in tables, when
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.extend_existing" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.extend_existing</span></code></a> were set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, for both
programmatic <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> construction as well as during reflection
operations.</p>
<ul class="simple">
<li><p>Under no circumstances should a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object ever have two or more
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects with the same name, regardless of what .key they
have.  An edge case where this was still possible was identified and fixed.</p></li>
<li><p>Adding a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> to a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> that has the same name or
key as an existing <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> will always raise
<a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.DuplicateColumnError" title="sqlalchemy.exc.DuplicateColumnError"><code class="xref py py-class docutils literal notranslate"><span class="pre">DuplicateColumnError</span></code></a> (a new subclass of <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.ArgumentError" title="sqlalchemy.exc.ArgumentError"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArgumentError</span></code></a> in
2.0.0b4) unless additional parameters are present;
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.append_column.params.replace_existing" title="sqlalchemy.schema.Table.append_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.append_column.replace_existing</span></code></a> for
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.append_column" title="sqlalchemy.schema.Table.append_column"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Table.append_column()</span></code></a>, and <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.extend_existing" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.extend_existing</span></code></a> for
construction of a same-named <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> as an existing one, with or
without reflection being used. Previously, there was a deprecation warning in
place for this scenario.</p></li>
<li><p>A warning is now emitted if a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> is created, that does
include <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.extend_existing" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.extend_existing</span></code></a>, where an incoming
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> that has no separate <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.key" title="sqlalchemy.schema.Column.key"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Column.key</span></code></a> would fully
replace an existing <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> that does have a key, which suggests
the operation is not what the user intended.  This can happen particularly
during a secondary reflection step, such as <code class="docutils literal notranslate"><span class="pre">metadata.reflect(extend_existing=True)</span></code>.
The warning suggests that the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.autoload_replace" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.autoload_replace</span></code></a> parameter
be set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to prevent this. Previously, in 1.4 and earlier, the
incoming column would be added <strong>in addition</strong> to the existing column.
This was a bug and is a behavioral change in 2.0 (as of 2.0.0b4), as the
previous key will <strong>no longer be present</strong> in the column collection
when this occurs.</p></li>
</ul>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/8925">#8925</a></p>
</section>
<section id="orm-declarative-applies-column-orders-differently-control-behavior-using-sort-order">
<span id="change-9297"></span><h3>ORM Declarative Applies Column Orders Differently; Control behavior using <code class="docutils literal notranslate"><span class="pre">sort_order</span></code><a class="headerlink" href="#orm-declarative-applies-column-orders-differently-control-behavior-using-sort-order" title="Link to this heading">¶</a></h3>
<p>Declarative has changed the system by which mapped columns that originate from
mixin or abstract base classes are sorted along with the columns that are on the
declared class itself to place columns from the declared class first, followed
by mixin columns.  The following mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">col3</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">:</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">col4</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">Foo</span><span class="p">,</span> <span class="n">Bar</span><span class="p">):</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Produces a CREATE TABLE as follows on 1.4:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">col1</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col3</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col2</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col4</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>Whereas on 2.0 it produces:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">col1</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col3</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col2</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col4</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>For the specific case above, this can be seen as an improvement, as the primary
key columns on the <code class="docutils literal notranslate"><span class="pre">Model</span></code> are now where one would typically prefer.  However,
this is no comfort for the application that defined models the other way
around, as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">col3</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">col4</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>This now produces CREATE TABLE output as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">col2</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col4</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">col1</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col3</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>To solve this issue, SQLAlchemy 2.0.4 introduces a new parameter on
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> called <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column.params.sort_order" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.sort_order</span></code></a>,
which is an integer value, defaulting to <code class="docutils literal notranslate"><span class="pre">0</span></code>,
that can be set to a positive or negative value so that columns are placed
before or after other columns, as in the example below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_order</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">sort_order</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">col3</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">col4</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The above model places “id” before all others and “col1” after “id”:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">col1</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col2</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col4</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="n">col3</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>Future SQLAlchemy releases may opt to provide an explicit ordering hint for the
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-class docutils literal notranslate"><span class="pre">mapped_column</span></code></a> construct, as this ordering is ORM specific.</p>
</section>
<section id="the-sequence-construct-reverts-to-not-having-any-explicit-default-start-value-impacts-ms-sql-server">
<span id="change-7211"></span><h3>The <code class="docutils literal notranslate"><span class="pre">Sequence</span></code> construct reverts to not having any explicit default “start” value; impacts MS SQL Server<a class="headerlink" href="#the-sequence-construct-reverts-to-not-having-any-explicit-default-start-value-impacts-ms-sql-server" title="Link to this heading">¶</a></h3>
<p>Prior to SQLAlchemy 1.4, the <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sequence</span></code></a> construct would emit only
simple <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">SEQUENCE</span></code> DDL, if no additional arguments were specified:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># SQLAlchemy 1.3 (and 2.0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">CreateSequence</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateSequence</span><span class="p">(</span><span class="n">Sequence</span><span class="p">(</span><span class="s2">&quot;my_seq&quot;</span><span class="p">)))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="n">SEQUENCE</span><span class="w"> </span><span class="n">my_seq</span>
</div></pre></div>
</div>
<p>However, as <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sequence</span></code></a> support was added for MS SQL Server, where the
default start value is inconveniently set to <code class="docutils literal notranslate"><span class="pre">-2**63</span></code>,
version 1.4 decided to default the DDL to emit a start value of 1, if
<a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence.params.start" title="sqlalchemy.schema.Sequence"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Sequence.start</span></code></a> were not otherwise provided:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># SQLAlchemy 1.4 (only)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">CreateSequence</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateSequence</span><span class="p">(</span><span class="n">Sequence</span><span class="p">(</span><span class="s2">&quot;my_seq&quot;</span><span class="p">)))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="n">SEQUENCE</span><span class="w"> </span><span class="n">my_seq</span><span class="w"> </span><span class="k">START</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="mi">1</span>
</div></pre></div>
</div>
<p>This change has introduced other complexities, including that when
the <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence.params.min_value" title="sqlalchemy.schema.Sequence"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Sequence.min_value</span></code></a> parameter is included, this default of
<code class="docutils literal notranslate"><span class="pre">1</span></code> should in fact default to what <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence.params.min_value" title="sqlalchemy.schema.Sequence"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Sequence.min_value</span></code></a>
states, else a min_value that’s below the start_value may be seen as
contradictory.     As looking at this issue started to become a bit of a
rabbit hole of other various edge cases, we decided to instead revert this
change and restore the original behavior of <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sequence</span></code></a> which is
to have no opinion, and just emit CREATE SEQUENCE, allowing the database
itself to make its decisions on how the various parameters of <code class="docutils literal notranslate"><span class="pre">SEQUENCE</span></code>
should interact with each other.</p>
<p>Therefore, to ensure that the start value is 1 on all backends,
<strong>the start value of 1 may be indicated explicitly</strong>, as below:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># All SQLAlchemy versions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">CreateSequence</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateSequence</span><span class="p">(</span><span class="n">Sequence</span><span class="p">(</span><span class="s2">&quot;my_seq&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="n">SEQUENCE</span><span class="w"> </span><span class="n">my_seq</span><span class="w"> </span><span class="k">START</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="mi">1</span>
</div></pre></div>
</div>
<p>Beyond all of that, for autogeneration of integer primary keys on modern
backends including PostgreSQL, Oracle, SQL Server, the <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Identity" title="sqlalchemy.schema.Identity"><code class="xref py py-class docutils literal notranslate"><span class="pre">Identity</span></code></a>
construct should be preferred, which also works the same way in 1.4 and 2.0
with no changes in behavior.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7211">#7211</a></p>
</section>
<section id="with-variant-clones-the-original-typeengine-rather-than-changing-the-type">
<span id="change-6980"></span><h3>“with_variant()” clones the original TypeEngine rather than changing the type<a class="headerlink" href="#with-variant-clones-the-original-typeengine-rather-than-changing-the-type" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.with_variant" title="sqlalchemy.types.TypeEngine.with_variant"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.with_variant()</span></code></a> method, which is used to apply
alternate per-database behaviors to a particular type, now returns a copy of
the original <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> object with the variant information
stored internally, rather than wrapping it inside the <code class="docutils literal notranslate"><span class="pre">Variant</span></code> class.</p>
<p>While the previous <code class="docutils literal notranslate"><span class="pre">Variant</span></code> approach was able to maintain all the in-Python
behaviors of the original type using dynamic attribute getters, the improvement
here is that when calling upon a variant, the returned type remains an instance
of the original type, which works more smoothly with type checkers such as mypy
and pylance.  Given a program as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">typing</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mysql</span> <span class="kn">import</span> <span class="n">VARCHAR</span>

<span class="n">type_</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">with_variant</span><span class="p">(</span><span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;utf8mb4&quot;</span><span class="p">),</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;mariadb&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span></pre></div>
</div>
<p>A type checker like pyright will now report the type as:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>info: Type of &quot;type_&quot; is &quot;String&quot;</pre></div>
</div>
<p>In addition, as illustrated above, multiple dialect names may be passed for
single type, in particular this is helpful for the pair of <code class="docutils literal notranslate"><span class="pre">&quot;mysql&quot;</span></code> and
<code class="docutils literal notranslate"><span class="pre">&quot;mariadb&quot;</span></code> dialects which are considered separately as of SQLAlchemy 1.4.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/6980">#6980</a></p>
</section>
<section id="python-division-operator-performs-true-division-for-all-backends-added-floor-division">
<span id="change-4926"></span><h3>Python division operator performs true division for all backends; added floor division<a class="headerlink" href="#python-division-operator-performs-true-division-for-all-backends-added-floor-division" title="Link to this heading">¶</a></h3>
<p>The Core expression language now supports both “true division” (i.e. the <code class="docutils literal notranslate"><span class="pre">/</span></code>
Python operator) and “floor division” (i.e. the <code class="docutils literal notranslate"><span class="pre">//</span></code> Python operator)
including backend-specific behaviors to normalize different databases in this
regard.</p>
<p>Given a “true division” operation against two integer values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expr</span> <span class="o">=</span> <span class="n">literal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span> <span class="o">/</span> <span class="n">literal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span></pre></div>
</div>
<p>The SQL division operator on PostgreSQL for example normally acts as “floor division”
when used against integers, meaning the above result would return the integer
“0”.  For this and similar backends, SQLAlchemy now renders the SQL using
a form which is equivalent towards:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="p">(</span><span class="n">param_1</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">param_2</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">)</span></pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">param_1=5</span></code>, <code class="docutils literal notranslate"><span class="pre">param_2=10</span></code>, so that the return expression will be of type
NUMERIC, typically as the Python value <code class="docutils literal notranslate"><span class="pre">decimal.Decimal(&quot;0.5&quot;)</span></code>.</p>
<p>Given a “floor division” operation against two integer values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expr</span> <span class="o">=</span> <span class="n">literal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span> <span class="o">//</span> <span class="n">literal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span></pre></div>
</div>
<p>The SQL division operator on MySQL and Oracle for example normally acts
as “true division” when used against integers, meaning the above result
would return the floating point value “0.5”.  For these and similar backends,
SQLAlchemy now renders the SQL using a form which is equivalent towards:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FLOOR</span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">param_1</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">param_2</span><span class="p">)</span><span class="n">s</span><span class="p">)</span></pre></div>
</div>
<p>With param_1=5, param_2=10, so that the return expression will be of type
INTEGER, as the Python value <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p>The backwards-incompatible change here would be if an application using
PostgreSQL, SQL Server, or SQLite which relied on the Python “truediv” operator
to return an integer value in all cases.  Applications which rely upon this
behavior should instead use the Python “floor division” operator <code class="docutils literal notranslate"><span class="pre">//</span></code>
for these operations, or for forwards compatibility when using a previous
SQLAlchemy version, the floor function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expr</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">literal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span> <span class="o">/</span> <span class="n">literal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span></pre></div>
</div>
<p>The above form would be needed on any SQLAlchemy version prior to 2.0
in order to provide backend-agnostic floor division.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4926">#4926</a></p>
</section>
<section id="session-raises-proactively-when-illegal-concurrent-or-reentrant-access-is-detected">
<span id="change-7433"></span><h3>Session raises proactively when illegal concurrent or reentrant access is detected<a class="headerlink" href="#session-raises-proactively-when-illegal-concurrent-or-reentrant-access-is-detected" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> can now trap more errors related to illegal concurrent
state changes within multithreaded or other concurrent scenarios as well as for
event hooks which perform unexpected state changes.</p>
<p>One error that’s been known to occur when a <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is used in
multiple threads simultaneously is
<code class="docutils literal notranslate"><span class="pre">AttributeError:</span> <span class="pre">'NoneType'</span> <span class="pre">object</span> <span class="pre">has</span> <span class="pre">no</span> <span class="pre">attribute</span> <span class="pre">'twophase'</span></code>, which is
completely cryptic. This error occurs when a thread calls
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> which internally invokes the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionTransaction.close()</span></code> method to end the transactional context,
at the same time that another thread is in progress running a query
as from <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>.  Within <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>,
the internal method that acquires a database connection for the current
transaction first begins by asserting that the session is “active”, but
after this assertion passes, the concurrent call to <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.close" title="sqlalchemy.orm.Session.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.close()</span></code></a>
interferes with this state which leads to the undefined condition above.</p>
<p>The change applies guards to all state-changing methods surrounding the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.SessionTransaction" title="sqlalchemy.orm.SessionTransaction"><code class="xref py py-class docutils literal notranslate"><span class="pre">SessionTransaction</span></code></a> object so that in the above case, the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> method will instead fail as it will seek to change
the state to one that is disallowed for the duration of the already-in-progress
method that wants to get the current connection to run a database query.</p>
<p>Using the test script illustrated at <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7433">#7433</a>, the previous
error case looks like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
File &quot;/home/classic/dev/sqlalchemy/test3.py&quot;, line 30, in worker
    sess.execute(select(A)).all()
File &quot;/home/classic/tmp/sqlalchemy/lib/sqlalchemy/orm/session.py&quot;, line 1691, in execute
    conn = self._connection_for_bind(bind)
File &quot;/home/classic/tmp/sqlalchemy/lib/sqlalchemy/orm/session.py&quot;, line 1532, in _connection_for_bind
    return self._transaction._connection_for_bind(
File &quot;/home/classic/tmp/sqlalchemy/lib/sqlalchemy/orm/session.py&quot;, line 754, in _connection_for_bind
    if self.session.twophase and self._parent is None:
AttributeError: &#39;NoneType&#39; object has no attribute &#39;twophase&#39;</pre></div>
</div>
<p>Where the <code class="docutils literal notranslate"><span class="pre">_connection_for_bind()</span></code> method isn’t able to continue since
concurrent access placed it into an invalid state.  Using the new approach, the
originator of the state change throws the error instead:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>File &quot;/home/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py&quot;, line 1785, in close
   self._close_impl(invalidate=False)
File &quot;/home/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py&quot;, line 1827, in _close_impl
   transaction.close(invalidate)
File &quot;&lt;string&gt;&quot;, line 2, in close
File &quot;/home/classic/dev/sqlalchemy/lib/sqlalchemy/orm/session.py&quot;, line 506, in _go
   raise sa_exc.InvalidRequestError(
sqlalchemy.exc.InvalidRequestError: Method &#39;close()&#39; can&#39;t be called here;
method &#39;_connection_for_bind()&#39; is already in progress and this would cause
an unexpected state change to symbol(&#39;CLOSED&#39;)</pre></div>
</div>
<p>The state transition checks intentionally don’t use explicit locks to detect
concurrent thread activity, instead relying upon simple attribute set / value
test operations that inherently fail when unexpected concurrent changes occur.
The rationale is that the approach can detect illegal state changes that occur
entirely within a single thread, such as an event handler that runs on session
transaction events calls a state-changing method that’s not expected, or under
asyncio if a particular <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> were shared among multiple
asyncio tasks, as well as when using patching-style concurrency approaches
such as gevent.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7433">#7433</a></p>
</section>
<section id="the-sqlite-dialect-uses-queuepool-for-file-based-databases">
<span id="change-7490"></span><h3>The SQLite dialect uses QueuePool for file-based databases<a class="headerlink" href="#the-sqlite-dialect-uses-queuepool-for-file-based-databases" title="Link to this heading">¶</a></h3>
<p>The SQLite dialect now defaults to <a class="reference internal" href="../core/pooling.html#sqlalchemy.pool.QueuePool" title="sqlalchemy.pool.QueuePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">QueuePool</span></code></a> when a file
based database is used. This is set along with setting the
<code class="docutils literal notranslate"><span class="pre">check_same_thread</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">False</span></code>. It has been observed that the
previous approach of defaulting to <a class="reference internal" href="../core/pooling.html#sqlalchemy.pool.NullPool" title="sqlalchemy.pool.NullPool"><code class="xref py py-class docutils literal notranslate"><span class="pre">NullPool</span></code></a>, which does not
hold onto database connections after they are released, did in fact have a
measurable negative performance impact. As always, the pool class is
customizable via the <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.poolclass" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.poolclass</span></code></a> parameter.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/sqlite.html#pysqlite-threading-pooling"><span class="std std-ref">Threading/Pooling Behavior</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7490">#7490</a></p>
</section>
<section id="new-oracle-float-type-with-binary-precision-decimal-precision-not-accepted-directly">
<span id="change-5465-oracle"></span><h3>New Oracle FLOAT type with binary precision; decimal precision not accepted directly<a class="headerlink" href="#new-oracle-float-type-with-binary-precision-decimal-precision-not-accepted-directly" title="Link to this heading">¶</a></h3>
<p>A new datatype <a class="reference internal" href="../dialects/oracle.html#sqlalchemy.dialects.oracle.FLOAT" title="sqlalchemy.dialects.oracle.FLOAT"><code class="xref py py-class docutils literal notranslate"><span class="pre">FLOAT</span></code></a> has been added to the Oracle dialect, to
accompany the addition of <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Double" title="sqlalchemy.types.Double"><code class="xref py py-class docutils literal notranslate"><span class="pre">Double</span></code></a> and database-specific
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DOUBLE" title="sqlalchemy.types.DOUBLE"><code class="xref py py-class docutils literal notranslate"><span class="pre">DOUBLE</span></code></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DOUBLE_PRECISION" title="sqlalchemy.types.DOUBLE_PRECISION"><code class="xref py py-class docutils literal notranslate"><span class="pre">DOUBLE_PRECISION</span></code></a> and
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.REAL" title="sqlalchemy.types.REAL"><code class="xref py py-class docutils literal notranslate"><span class="pre">REAL</span></code></a> datatypes. Oracle’s <code class="docutils literal notranslate"><span class="pre">FLOAT</span></code> accepts a so-called
“binary precision” parameter that per Oracle documentation is roughly a
standard “precision” value divided by 0.3103:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">oracle</span>

<span class="n">Table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">oracle</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">(</span><span class="mi">126</span><span class="p">)))</span></pre></div>
</div>
<p>A binary precision value of 126 is synonymous with using the
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DOUBLE_PRECISION" title="sqlalchemy.types.DOUBLE_PRECISION"><code class="xref py py-class docutils literal notranslate"><span class="pre">DOUBLE_PRECISION</span></code></a> datatype, and a value of 63 is equivalent
to using the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.REAL" title="sqlalchemy.types.REAL"><code class="xref py py-class docutils literal notranslate"><span class="pre">REAL</span></code></a> datatype.  Other precision values are
specific to the <a class="reference internal" href="../dialects/oracle.html#sqlalchemy.dialects.oracle.FLOAT" title="sqlalchemy.dialects.oracle.FLOAT"><code class="xref py py-class docutils literal notranslate"><span class="pre">FLOAT</span></code></a> type itself.</p>
<p>The SQLAlchemy <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a> datatype also accepts a “precision”
parameter, but this is decimal precision which is not accepted by
Oracle.  Rather than attempting to guess the conversion, the Oracle dialect
will now raise an informative error if <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a> is used with
a precision value against the Oracle backend.  To specify a
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a> datatype with an explicit precision value for
supporting backends, while also supporting other backends, use
the <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.with_variant" title="sqlalchemy.types.TypeEngine.with_variant"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.with_variant()</span></code></a> method as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">oracle</span>

<span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;some_table&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">with_variant</span><span class="p">(</span><span class="n">oracle</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;oracle&quot;</span><span class="p">)),</span>
<span class="p">)</span></pre></div>
</div>
</section>
<section id="new-range-multirange-support-and-changes-for-postgresql-backends">
<span id="change-7156"></span><h3>New RANGE / MULTIRANGE support and changes for PostgreSQL backends<a class="headerlink" href="#new-range-multirange-support-and-changes-for-postgresql-backends" title="Link to this heading">¶</a></h3>
<p>RANGE / MULTIRANGE support has been fully implemented for psycopg2, psycopg3,
and asyncpg dialects.  The new support uses a new SQLAlchemy-specific
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Range" title="sqlalchemy.dialects.postgresql.Range"><code class="xref py py-class docutils literal notranslate"><span class="pre">Range</span></code></a> object that is agnostic of the different backends
and does not require the use of backend-specific imports or extension
steps.  For multirange support, lists of <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Range" title="sqlalchemy.dialects.postgresql.Range"><code class="xref py py-class docutils literal notranslate"><span class="pre">Range</span></code></a>
objects are used.</p>
<p>Code that used the previous psycopg2-specific types should be modified
to use <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Range" title="sqlalchemy.dialects.postgresql.Range"><code class="xref py py-class docutils literal notranslate"><span class="pre">Range</span></code></a>, which presents a compatible interface.</p>
<p>The <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Range" title="sqlalchemy.dialects.postgresql.Range"><code class="xref py py-class docutils literal notranslate"><span class="pre">Range</span></code></a> object also features comparison support which
mirrors that of PostgreSQL.  Implemented so far are <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Range.contains" title="sqlalchemy.dialects.postgresql.Range.contains"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Range.contains()</span></code></a>
and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Range.contained_by" title="sqlalchemy.dialects.postgresql.Range.contained_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Range.contained_by()</span></code></a> methods which work in the same way as
the PostgreSQL <code class="docutils literal notranslate"><span class="pre">&#64;&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;&#64;</span></code>.  Additional operator support may be added
in future releases.</p>
<p>See the documentation at <a class="reference internal" href="../dialects/postgresql.html#postgresql-ranges"><span class="std std-ref">Range and Multirange Types</span></a> for background on
using the new feature.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#postgresql-ranges"><span class="std std-ref">Range and Multirange Types</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7156">#7156</a>
<a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/8706">#8706</a></p>
</section>
<section id="match-operator-on-postgresql-uses-plainto-tsquery-rather-than-to-tsquery">
<span id="change-7086"></span><h3><code class="docutils literal notranslate"><span class="pre">match()</span></code> operator on PostgreSQL uses <code class="docutils literal notranslate"><span class="pre">plainto_tsquery()</span></code> rather than <code class="docutils literal notranslate"><span class="pre">to_tsquery()</span></code><a class="headerlink" href="#match-operator-on-postgresql-uses-plainto-tsquery-rather-than-to-tsquery" title="Link to this heading">¶</a></h3>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.match()</span></code> function now renders
<code class="docutils literal notranslate"><span class="pre">col</span> <span class="pre">&#64;&#64;</span> <span class="pre">plainto_tsquery(expr)</span></code> on the PostgreSQL backend, rather than
<code class="docutils literal notranslate"><span class="pre">col</span> <span class="pre">&#64;&#64;</span> <span class="pre">to_tsquery()</span></code>.  <code class="docutils literal notranslate"><span class="pre">plainto_tsquery()</span></code> accepts plain text whereas
<code class="docutils literal notranslate"><span class="pre">to_tsquery()</span></code> accepts specialized query symbols, and is therefore less
cross-compatible with other backends.</p>
<p>All PostgreSQL search functions and operators are available through use of
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a> to generate PostgreSQL-specific functions and
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.bool_op" title="sqlalchemy.sql.expression.Operators.bool_op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.bool_op()</span></code></a> (a boolean-typed version of <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a>)
to generate arbitrary operators, in the same manner as they are available
in previous versions.  See the examples at <a class="reference internal" href="../dialects/postgresql.html#postgresql-match"><span class="std std-ref">Full Text Search</span></a>.</p>
<p>Existing SQLAlchemy projects that make use of PG-specific directives within
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.match()</span></code> should make use of <code class="docutils literal notranslate"><span class="pre">func.to_tsquery()</span></code> directly.
To render SQL in exactly the same form as would be present
in 1.4, see the version note at <a class="reference internal" href="../dialects/postgresql.html#postgresql-simple-match"><span class="std std-ref">Simple plain text matching with match()</span></a>.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/7086">#7086</a></p>
</section>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="migration_20.html" title="previous chapter">SQLAlchemy 2.0 - Major Migration Guide</a>
        Next:
        <a href="changelog_20.html" title="next chapter">2.0 Changelog</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2024, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.2.6.

    Documentation last generated: Mon 05 Aug 2024 08:14:11 PM  JST

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      document.documentElement.dataset.content_root = '../';

    </script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


